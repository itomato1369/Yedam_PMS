<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.pms.project.mapper.ProjectMapper">

	<resultMap id="projectMap" type="ProjectSelectDTO" autoMapping="true">
		<id property="projectNo" column="project_no"/>
		<association property="projectTotalDTO" 
                     column="project_no" 
                     javaType="ProjectTotalDTO" 
                     select="selectTotalClac"/>
	</resultMap>

	<select id="selectUserProjects" resultMap="projectMap">
	SELECT 
	  p.le
	  , p.project_no
	  , p.parent_project_no
	  , p.project_name
	  , p.project_desc
	  , p.project_code
	  , p.project_home 
	  , FN_GET_CODE_NAME(p.status) AS project_status
	  , p.status
	  , p.public_yn
	  , m.join_no -- 조인 정상적으로 되었는지 조회하는 용도
	  , j.title AS latest_job_title
	  FROM vw_project p
	  LEFT JOIN (
	    SELECT DISTINCT project_no AS join_no
	    FROM vw_member m
	    WHERE user_id = #{userId}
	  ) m ON p.project_no = m.join_no
	  LEFT JOIN (
	    SELECT project_no, title
		    FROM (
		        SELECT project_no, title, 
		               ROW_NUMBER() OVER (PARTITION BY project_no ORDER BY add_date DESC) as rn
		        FROM job
		    )
		    WHERE rn = 1 
		) j ON j.project_no = p.project_no
	  WHERE 
	    p.status BETWEEN 330 AND 370 
	  AND
	  (
	    m.join_no IS NOT NULL  -- 조건1: 조인이 됐다? (즉, 나는 멤버다)
	    OR 
	    p.public_yn = 1           -- 조건2: 혹은 공개 프로젝트다
	  )
	</select>
	
	<!--/* 넘겨받은 프로젝트 번호별로 하위프로젝트 하향식 탐사 */-->
	<select id="selectTotalClac" resultType="ProjectTotalDTO">
	  WITH subtree AS (
	    SELECT sub.project_no
	    FROM project sub
	    START WITH sub.project_no = #{projectNo}
	    CONNECT BY PRIOR sub.project_no = sub.parent_project_no
	  )
	  SELECT
	    -- 총 소속 인원
	    (SELECT COUNT(DISTINCT m.user_id)
	     FROM vw_member m
	     WHERE m.project_no IN (SELECT project_no FROM subtree)
	    ) AS totalMemberCount,
	
	    -- 총 일감 수
	    (SELECT COUNT(*)
	     FROM job j
	     WHERE j.project_no IN (SELECT project_no FROM subtree)
	    ) AS totalJobCount,
	
	    -- 예상진척도 (CAST 추가)
	    NVL((SELECT ROUND(AVG(
	        CASE
			  WHEN p.start_date IS NULL OR p.end_date IS NULL THEN 0 
			  WHEN p.end_date = p.start_date THEN 100
	          ELSE
	            LEAST(
	              GREATEST(
	                (CAST(SYSDATE AS DATE) - CAST(p.start_date AS DATE)) 
	                / 
	                (CAST(p.end_date AS DATE) - CAST(p.start_date AS DATE)) 
	                * 100,
	                0
	              ),
	              100
	            )
	        END
	      ), 2)
	     FROM project p
	     WHERE p.project_no IN (SELECT project_no FROM subtree)
	    ), 0) AS targetProgress,
	
	    -- 실제진척도
	    NVL((SELECT ROUND(AVG(j.progress), 2)
	     FROM job j
	     WHERE j.project_no IN (SELECT project_no FROM subtree)
	    ), 0) AS currentProgress
	  FROM dual
	</select>
	
	<select id="selectProjectsByOptions" parameterType="com.pms.project.dto.ProjectSearchDTO" resultType="ProjectSelectDTO">
        SELECT
            p.project_no,
            p.project_name,
            p.project_desc,
            -- 1. 통합 인원수 (삭제 사용자 제외)
            (SELECT COUNT(DISTINCT m.user_id)
             FROM g_project gp
             JOIN members m ON gp.group_no = m.group_no
             JOIN users u ON m.user_id = u.user_id
             WHERE u.status != 190
               AND gp.project_no IN (
                   SELECT project_no FROM project
                   START WITH project_no = p.project_no
                   CONNECT BY PRIOR project_no = parent_project_no
               )) AS member_count,
            -- 2. 통합 일감수 (중단 일감 제외)
            (SELECT COUNT(*)
             FROM job j
             WHERE j.job_status_no != 3
               AND j.project_no IN (
                   SELECT project_no FROM project
                   START WITH project_no = p.project_no
                   CONNECT BY PRIOR project_no = parent_project_no
               )) AS total_job_count,
            -- 3. 최신 일감 내용
            (SELECT content
             FROM (
                 SELECT j.content, j.project_no,
                        ROW_NUMBER() OVER (PARTITION BY j.project_no ORDER BY j.add_date DESC, j.job_no DESC) as rn
                 FROM job j
             )
             WHERE rn = 1 AND project_no = p.project_no) AS latest_job_content,
            -- 4. 최신 일감 제목
            (SELECT title
             FROM (
                 SELECT j.title, j.project_no,
                        ROW_NUMBER() OVER (PARTITION BY j.project_no ORDER BY j.add_date DESC, j.job_no DESC) as rn
                 FROM job j
             )
             WHERE rn = 1 AND project_no = p.project_no) AS latest_job_title,
            -- 5. 로그인 사용자가 프로젝트에 참여했는지 여부 - 현재 로그인된 사용자 정보가 필요
            (SELECT CASE WHEN COUNT(m.user_id) > 0 THEN 1 ELSE 0 END
             FROM members m
             JOIN g_project gp ON m.group_no = gp.group_no
             WHERE gp.project_no = p.project_no
             AND m.user_id = #{currentUserId}) AS has_login_user_joined
        FROM project p
        <where>
            AND p.status != 390
            <if test="projectName != null and projectName != ''">
                AND p.project_name LIKE '%' || #{projectName} || '%'
            </if>
            <if test="projectStatus != null">
                AND p.status = #{projectStatus}
            </if>
            <if test="projectAssignee != null and projectAssignee != ''">
                AND p.user_id = #{projectAssignee}
            </if>
            <!-- 검색할 때도 사용자의 접근 권한을 고려해야 함 -->
            AND (p.project_no IN (
                  SELECT gp.project_no FROM g_project gp
                  JOIN members m ON gp.group_no = m.group_no
                  WHERE m.user_id = #{currentUserId}
              ) OR p.public_yn = 1)
        </where>
        ORDER BY p.create_at ASC
    </select>
    
    <!--/* insert-from에서 조회 할 프로젝트 목록 */-->
    <select id="selectParentProjects" resultType="ParentProjectDTO">
		SELECT project_no
		  , project_name
		FROM vw_project
		WHERE status != 390
		ORDER BY project_no
	</select>
	<!--/* insert 실행 전 projectCode 중복 체크*/-->
	<select id="selectByProjectCode" resultType="Integer">
		SELECT COUNT(*)
		FROM project
		WHERE project_code=#{projectCode}
	</select>
	
	<!--/* insert update delete: MyBatis가 내부적으로 실행 후 결과(Row 수)를 반환하는 구조 */-->
	<insert id="insertProject" parameterType="projectInsertDTO">
		INSERT INTO project (
		    project_no,         -- 식별자
		    parent_project_no,  -- 상위프로젝트
		    project_name,       -- 프로젝트명
		    user_id,            -- 제작자
		    project_desc,       -- 설명
		    project_home,       -- 홈페이지
		    project_code,       -- URI
		    create_at,          -- 생성일
		    update_at,          -- 수정일
		    start_date,         -- 시작일
		    end_date,           -- 종료일
		    parent_member_yn,   -- 멤버상속
		    public_yn,          -- 공개여부
		    status              -- 상태
		) VALUES (
	        PROJECT_SEQ.NEXTVAL               -- 시퀀스 자동 생성
	        , NVL(#{parentProjectNo}, 0)      -- null able, default: 0
	        , #{projectName}                  -- 필수값: 중복 가능
	        , #{userId}                       -- 필수값: Service 에서 세팅
	        , NVL(#{projectDesc}, '')         -- null able, 추후에 null 예외처리 가능성
	        , NVL(#{projectHome}, '')         -- null able, 추후에 null 예외처리 가능성
	        , #{projectCode}                  -- 필수값(Unique, 수정불가능)
	        , SYSTIMESTAMP                    -- 생성일 자동
	        , NULL                            -- 수정일은 생성 시 null
	        , #{startDate}                    -- 필수값(오늘 이전 날짜 불가)
	        , #{endDate}                      -- 필수값(오늘 이전 날짜 불가)
	        , NVL(#{parentMemberYn}, 0)       -- null able, default: 0
	        , NVL(#{publicYn}, 0)             -- null able, default: 0
	        , #{status}                       -- 필수값: Service 에서 세팅
    )
	</insert>
	
	
	<select id="selectFirstChildsByCode" resultType="ProjectSelectDTO">
		SELECT 
		  child.project_name
		  , child.project_code
		  , child.status
		  , FN_GET_CODE_NAME(child.status) AS status_name
		FROM project parent
		JOIN project child
		ON parent.project_no = child.parent_project_no
		WHERE parent.project_code = #{projectCode}
		AND child.status Between #{active} AND #{locked}
	</select>
</mapper>