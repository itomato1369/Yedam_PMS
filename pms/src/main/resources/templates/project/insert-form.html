<!doctype html>
<!--/*
* CoreUI - Free Bootstrap Admin Template
* @version v5.3.0
* @link https://coreui.io/product/free-bootstrap-admin-template/
* Copyright (c) 2025 creativeLabs Łukasz Holeczek
* Licensed under MIT (https://github.com/coreui/coreui-free-bootstrap-admin-template/blob/main/LICENSE)
*/-->
<html lang="ko" xmlns:th="https://www.thymeleaf.org/"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/default-layout}"
	layout:fragment="Content">

<div class="d-flex justify-content-between align-items-center mb-5">
	<div class="d-flex align-items-center">
		<div class="position-relative">
			<h2 class="fw-bold m-0 text-dark ps-0" 
                th:text="${mode == 'new' ? '새 프로젝트' : '프로젝트 설정'}"></h2>
		</div>
	</div>
</div>	
<div th:fragment="projectInsertForm" class="card">
	<div class="card-body">
		<form th:action="@{${mode == 'new' ? '/project/new' : '/project/user/edit/' + project.projectCode}}" 
              th:object="${project}" 
              method="post">
            <!--/* 0.프로젝트 기본식별자 */-->
            <input type="hidden" th:field="*{projectNo}" />
            
			<!--/* 1. 프로젝트 이름 라벨 */-->
			<div class="row mb-3 align-items-center">
				<label class="col-sm-2 col-form-label text-end pe-0">이름<i class="cil-asterisk text-danger"></i>
				</label>
                <div class="col-sm-9">
                    <input type="text" class="form-control" th:field="*{projectName}" />
                </div>
			</div>
			
			 <!--/* 2. 설명 (탭 + 텍스트에리어) */-->
            <div class="row mb-3">
			    <label class="col-sm-2 col-form-label text-end pe-0">설명</label>
			    <div class="col-sm-9">
			        <!--/* 탭 네비게이션 */-->
			        <ul class="nav nav-tabs mb-0" role="tablist">
			            <li class="nav-item">
			                <a class="nav-link active" data-coreui-toggle="tab" href="#tab1" 
			                   style="margin-bottom: -1px;">편집</a>
			            </li>
			        </ul>
			        <!--/* 텍스트에리어 */-->
			        <textarea class="form-control" rows="5" th:field="*{projectDesc}" 
			        style="border-top: none; border-top-left-radius: 0; border-top-right-radius: 0;"></textarea>
			    </div>
			</div>

            <!--/* 3. 식별자 */-->
            <div class="row mb-3 align-items-top">
                <label class="col-sm-2 col-form-label text-end pe-0">식별자 <i class="cil-asterisk text-danger"></i></label>
                <div class="col-sm-9">
                    <input type="text" class="form-control" 
                    pattern="[a-z0-9_-]{1,100}"  th:attr="maxlength=100"
                    th:field="*{projectCode}"/>
                    <small class="form-text text-muted">
                        1 에서 100, 글자 소문자(a-z), 숫자, 대시(-)와 밑줄(_)만 가능합니다.<br/>
                        식별자는 저장후에는 수정할 수 없습니다.
                    </small>
                </div>
            </div>

            <!--/* 4. 홈페이지 */-->
            <div class="row mb-3 align-items-center">
                <label class="col-sm-2 col-form-label text-end pe-0">홈페이지</label>
                <div class="col-sm-9">
                    <input type="url" class="form-control" th:field="*{projectHome}"/>
                </div>
            </div>

            <!--/* 5. 공개 체크박스 */-->
            <div class="row mb-3 align-items-center">
                <label class="col-sm-2 col-form-label text-end pe-0">공개</label>
                <div class="col-sm-9">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="publicCheck" th:field="*{publicYn}" value="1"/>
                        <label class="form-check-label" for="publicCheck">
                            공개 프로젝트는 프로젝트에 소속되지 않은 인원들도 조회할 수 있습니다.
                        </label>
                    </div>
                </div>
            </div>

            <!--/* 6. 상위 프로젝트 드롭다운 */-->
            <div class="row mb-3 align-items-center">
                <label class="col-sm-2 col-form-label text-end pe-0">상위 프로젝트</label>
                <div class="col-sm-9">
                    <select class="form-select" th:field="*{parentProjectNo}">
                    	<option value="0" selected></option>
						<option th:each="project : ${parentProjects}" 
						            th:value="${project.projectNo}" 
						            th:text="${project.projectName}">
						</option>
                    </select>
                </div>
            </div>

            <!--/* 7. 하위 프로젝트 체크박스 */-->
            <div class="row mb-3 align-items-center">
                <label class="col-sm-2 col-form-label text-end pe-0">상위 프로젝트 구성원 상속</label>
                <div class="col-sm-9">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="inheritCheck" th:field="*{parentMemberYn}" value="1"/>
                        <label class="form-check-label" for="inheritCheck"></label>
                    </div>
                </div>
            </div>
            <!--/* 8. 시작일/종료일 선택 */-->
            <div class="row mb-3 align-items-center">
			    <label class="col-sm-2 col-form-label text-end pe-0">기간 <i class="cil-asterisk text-danger"></i></label>
			    <div class="col-sm-9">
			        <div class="input-group input-group-sm">
			            
			            <span class="input-group-text rounded-start"><i class="cil-calendar-check me-1"></i> 시작</span>
			            <input type="date" class="form-control rounded-end" th:field="*{startDate}" id="startDate" style="max-width: 160px;" required />
			            
			            <span class="input-group-text bg-transparent border-0 d-flex align-items-center px-2">
			                <i class="cil-minus"></i>
			            </span>
			            
			            <span class="input-group-text rounded-start"><i class="cil-calendar-x me-1"></i> 종료</span>
			            <input type="date" class="form-control rounded-end" th:field="*{endDate}" id="endDate" style="max-width: 160px;" required />
			        </div>
			    </div>
			</div>
            
            <!--/* 9. 폼 버튼 영역 */-->
            <div class="card-footer bg-transparent border-top-0 pb-4">
	            <div class="row">
	                <div class="col-sm-2"></div> 
	                <div class="col-sm-10 ps-0">
	                    <button type="submit" class="btn btn-outline-primary me-2">
	                        <span th:text="${mode == 'new' ? '만들기' : '수정'}"></span>
	                    </button>
	            
	                    <button type="submit" name="continue" value="true" 
	                            th:if="${mode == 'new'}" 
	                            class="btn btn-outline-primary"
	                            th:text="'만들고 계속하기'">
	                    </button>
	                </div>
	            </div>
			</div>
		</form>
	</div>
</div>

<!--/* Toast Tag */-->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div th:if="${successMessage != null or errorMessage != null}" 
         id="liveToast" 
         class="toast hide" 
         role="alert" aria-live="assertive" aria-atomic="true">
        
        <div class="toast-header text-white" 
             th:classappend="${successMessage != null} ? 'bg-success' : 'bg-danger'">
            <strong class="me-auto" th:text="${successMessage != null} ? '성공' : '오류'">알림</strong>
            <button type="button" class="btn-close btn-close-white" data-coreui-dismiss="toast" aria-label="Close"></button>
        </div>
        
        <div class="toast-body" th:text="${successMessage ?: errorMessage}">
            </div>
    </div>
</div>
<!--/* Toast Script */-->
<script th:if="${successMessage != null or errorMessage != null}">
    document.addEventListener('DOMContentLoaded', function () {
        const toastElement = document.getElementById('liveToast');
        if (toastElement) {
            const toast = new coreui.Toast(toastElement);
            toast.show();
        }
    });
</script>
<script>
// 식별자 입력기능에 정규표현식 적용
const projectCodeInput = document.getElementById('projectCode');

if (projectCodeInput) {
    projectCodeInput.addEventListener('input', function(e) {
        let value = e.target.value;

        // 1. 영어 대문자를 소문자로 즉시 변환
        value = value.toLowerCase();

        // 2. 허용된 문자(소문자, 숫자, _, -)를 제외한 모든 문자를 제거
        //    [^a-z0-9_-]는 '허용된 문자 이외의 모든 문자'를 의미하는 정규식입니다.
        value = value.replace(/[^a-z0-9_-]/g, '');

        // 3. 필터링된 값으로 입력 필드의 값을 다시 설정
        e.target.value = value;
    });
}

// 상위 프로젝트 선택에 따른 멤버 상속 체크박스 제어
const parentProjectSelect = document.getElementById('parentProjectNo'); // 상위 프로젝트 드롭다운
const inheritMemberCheck = document.getElementById('inheritCheck');   // 멤버 상속 체크박스
// 체크박스 상태를 토글하는 함수
function toggleInheritCheckbox() {
    // 상위 프로젝트 드롭다운의 값이 '0'이면 (상위 프로젝트가 없으면)
    if (parentProjectSelect.value === '0') {
       inheritMemberCheck.disabled = true; // 체크박스를 비활성화
       inheritMemberCheck.checked = false; // 체크박스 선택을 해제
    } else {
        inheritMemberCheck.disabled = false; // 그 외의 경우 (상위 프로젝트가 선택된 경우) 체크박스를 활성화
    }
}

// 1. 페이지 로드 시 초기 상태 설정
toggleInheritCheckbox();

// 2. '상위 프로젝트' 드롭다운 값이 변경될 때마다 상태 업데이트
parentProjectSelect.addEventListener('change', toggleInheritCheckbox);

document.addEventListener('DOMContentLoaded', function() {
    // 오늘 날짜를 yyyy-mm-dd 형식으로 가져오기
    const today = new Date().toISOString().split('T')[0];
    
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    
    // 시작일과 종료일의 최소 날짜를 오늘로 제한
    startDateInput.min = today;
    endDateInput.min = today;
    
    // 시작일이 변경되면 종료일의 최소 날짜를 시작일로 업데이트 (UX 보너스)
    startDateInput.addEventListener('change', function() {
        endDateInput.min = this.value;
    });
});
</script>

</html>
