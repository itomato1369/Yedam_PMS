<!doctype html>
<!--/*
* CoreUI - Free Bootstrap Admin Template
* @version v5.3.0
* @link https://coreui.io/product/free-bootstrap-admin-template/
* Copyright (c) 2025 creativeLabs Łukasz Holeczek
* Licensed under MIT (https://github.com/coreui/coreui-free-bootstrap-admin-template/blob/main/LICENSE)
*/-->
<html
  lang="ko"
  xmlns:th="https://www.thymeleaf.org/"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{common/layouts/default-layout}"
  layout:fragment="Content"
>
  <div class="mb-2">
    <!--/* row-header */-->
    <div class="d-flex justify-content-between align-items-center mb-5">
      <div class="d-flex align-items-center">
        <div class="position-relative">
          <h2 class="fw-bold m-0 text-dark" 
                th:text="프로젝트"></h2>
        </div>
      </div>
      <!--/* pm/admin Only */-->
      <!--/* ProjectAdmin buttons : add-project, modify-project */-->
      <div class="d-flex align-items-center gap-4">
        <div class="d-flex align-items-center gap-2">
          <i class="cil-plus text-dark" style="font-size: 1.5rem; font-weight: bold"></i>
			<button type="button" 
			        id="btnAddNewProject" 
			        class="btn btn-dark fw-bold" 
			        th:data-url="@{/project/new}">
			    새 프로젝트
			</button>
        </div>

        <div class="d-flex align-items-center gap-2">
          <i class="cil-settings text-secondary" style="font-size: 1.5rem"></i>
          <button class="btn btn-primary fw-bold">관리</button>
        </div>
      </div>
    </div>

    <!--/* search-menu */-->
    <form method="get" th:action="@{/projects}" class="card bg-transparent shadow-none border-0">
      <div
        class="card-body py-4 px-0 d-flex flex-wrap justify-content-between align-items-center gap-3"
      >
        <div class="d-flex flex-wrap gap-2" style="flex: 1">
          <input
            type="text"
            class="form-control"
            placeholder="프로젝트명"
            name="projectName"
            th:value="${searchDTO?.projectName}"
            style="max-width: 200px"
          />
          <select class="form-select" name="projectStatus" style="max-width: 150px">
            <option value="" disabled selected hidden>상태</option>
            <option
              th:each="common : ${commons}"
              th:value="${common.commonNo}"
              th:text="${common.commonName}"
              th:selected="${searchDTO?.projectStatus != null and searchDTO.projectStatus == common.commonNo}"
            ></option>
          </select>
          <input
            type="text"
            class="form-control"
            placeholder="담당자"
            name="projectAssignee"
            th:value="${searchDTO?.projectAssignee}"
            style="max-width: 200px"
          />
        </div>

        <div class="d-flex align-items-center gap-2">
          <i class="cil-search text-dark" style="font-size: 1.5rem"></i>
          <button type="submit" class="btn btn-primary px-4 fw-bold" name="projectSearchiBtn">
            조회
          </button>
        </div>
      </div>
    </form>
  </div>
  <!--/* Card */-->
<div class="card mb-4 shadow-sm" th:each="project : ${projects}" th:if="${project.le == 1}">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-start">
            
            <div class="project-info" style="flex: 1;">
                <div class="d-flex align-items-center gap-2 mb-1">
                    <h5 class="fw-bold text-primary mb-0">
                        <a th:text="${project.projectName}" 
                           th:href="@{/project/user/{code}/info(code=${project.projectCode})}" 
                           class="text-decoration-none"></a>
                    </h5>
                    <span th:if="${project.publicYn == 1}" class="badge bg-info-light text-info small" style="font-size: 0.7rem;">Public</span>
                </div>
                <p class="text-muted small mb-3" th:text="${project.projectDesc}"></p>

                <div class="mt-2">
                    <th:block th:replace="~{::recursiveTree(parentNo=${project.projectNo}, allProjects=${projects})}"></th:block>
                </div>
            </div>

            <div class="project-stats d-flex gap-5 text-end ms-4" th:if="${project.projectTotalDTO != null}">
                <div class="stat-item">
                    <div class="small text-secondary">일감 수 <span class="text-success fw-bold fs-4" th:text="${project.projectTotalDTO.totalJobCount}">0</span>개</div>
                    <div class="text-muted" style="font-size: 0.75rem;" th:text="${project.latestJobTitle ?: '일감 없음'}"></div>
                </div>
                <div class="stat-item">
                    <div class="small text-secondary">참여 인원 <span class="text-warning fw-bold fs-4" th:text="${project.projectTotalDTO.totalMemberCount}">0</span>명</div>
                    <div class="text-muted" style="font-size: 0.75rem;" th:text="${project.projectHome ?: '-'}"></div>
                </div>
                <div class="stat-item" style="min-width: 140px;">
                    <div class="small text-secondary">진행률 <span class="text-danger fw-bold fs-5" th:text="${project.projectTotalDTO.currentProgress + '%'}"></span></div>
                    <div class="progress" style="height: 5px; margin-top: 4px;">
                        <div class="progress-bar bg-danger" th:style="'width:' + ${project.projectTotalDTO.currentProgress} + '%'"></div>
                    </div>
                    <div class="text-muted mt-1" style="font-size: 0.7rem;">목표: <span th:text="${project.projectTotalDTO.targetProgress + '%'}"></span></div>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block th:fragment="recursiveTree(parentNo, allProjects)">
    <div th:each="sub : ${allProjects}" th:if="${sub.parentProjectNo == parentNo}" 
         class="border-start border-secondary border-4 ms-3 ps-3 mb-0"> <div class="d-flex align-items-center gap-2">
            <h6 class="fw-bold text-primary mb-0">
                <a th:href="@{/project/user/{code}/info(code=${sub.projectCode})}" 
                   th:text="${sub.projectName}" class="text-decoration-none"></a>
            </h6>
            <span th:if="${sub.publicYn == 1}" class="badge bg-info-light text-info small" style="font-size: 0.65rem;">Public</span>
        </div>
        <p class="text-muted mb-0" style="font-size: 0.85rem;" th:text="${sub.projectDesc}"></p>
        
        <th:block th:replace="~{::recursiveTree(parentNo=${sub.projectNo}, allProjects=${allProjects})}"></th:block>
    </div>
</th:block>
	<script>
	document.addEventListener('DOMContentLoaded', function() {
	    const btn = document.getElementById('btnAddNewProject');
	    if (btn) {
	        btn.addEventListener('click', function() {
	            const url = this.getAttribute('data-url');
	            location.href = url;
	        });
	    }
	});	
	</script>
</html>
