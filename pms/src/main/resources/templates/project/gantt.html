<!DOCTYPE html>
<html lang="ko" xmlns:th="https://www.thymeleaf.org/"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layouts/default-layout}"
      layout:fragment="Content">
<head>
    <meta charset="UTF-8">
    <title>Gantt Chart</title>
    <style>
        /*
         The gantt chart container needs a defined height.
         The default layout (CoreUI) uses flexbox, but the intermediate containers don't have a height set.
         We will use viewport height (vh) units and CSS calc() to set the height of our chart's wrapper,
         subtracting the approximate height of the header and padding to make it fit nicely.
        */
        .gantt-wrapper {
            /* 100vh = 100% of the viewport height. 120px is an estimate for header/padding. Adjust if needed. */
            height: calc(100vh - 120px);
            width: 100%;
        }
        /* The gantt container itself should fill its wrapper */
        #gantt_here {
            height: 100%;
            width: 100%;
        }
    </style>
    <link th:href="@{/dhtmlx/gantt/dhtmlxgantt.css}" rel="stylesheet">
    <script th:src="@{/dhtmlx/gantt/dhtmlxgantt.js}"></script>
    <script src="https://cdn.dhtmlx.com/gantt/edge/locales/locale_kr.js"></script>
</head>
<body>
    <div class="gantt-wrapper">
        <div id="gantt_here"></div>
    </div>

    <script>
        // Activate the Marker plugin
        gantt.plugins({
            marker: true
        });

        // This function initializes the gantt chart with given data.
        // This makes it easy to load data from either a hardcoded variable or a server response.
        function initGantt(tasks) {
            gantt.i18n.setLocale("kr"); // Explicitly set the locale to Korean
            gantt.setSkin("meadow");

            // --- Korean Localization Configuration ---
            // 1. Grid Column Headers
            gantt.config.columns = [
                { name: "text",       label: "작업명",  tree: true, width: "*" },
                { name: "start_date", label: "시작일",  align: "center" },
                { name: "duration",   label: "기간(일)",    align: "center" },
                { name: "add",        label: "",       width: 44 }
            ];

            // 2. Timeline Scale Format
            gantt.config.scales = [
                { unit: "month", step: 1, format: "%Y년 %n월" },
                { unit: "day",   step: 1, format: "%d일 (%D)" } 
            ];
            // --- End of Localization ---
            gantt.templates.rightside_text = function (start, end, task) {
                return "ID: #" + task.id;
            };
            gantt.templates.leftside_text = function (start, end, task) {
                return task.duration + " days";
            };

            gantt.init("gantt_here");
            gantt.parse(tasks);

            // --- Today Marker ---
            // Set date format for the marker tooltip
            var dateToStr = gantt.date.date_to_str(gantt.config.task_date);

            // Add Today Marker
            var todayMarkerId = gantt.addMarker({
                start_date: new Date(), // Marker date (Today)
                css: "today",           // Custom CSS class for the marker line
                text: "오늘",            // Text displayed above the marker
                title: dateToStr(new Date()) // Tooltip on mouse over
            });

            // Update marker position every minute (optional)
            setInterval(function() {
                var todayMarker = gantt.getMarker(todayMarkerId);
                todayMarker.start_date = new Date();
                todayMarker.title = dateToStr(todayMarker.start_date);
                gantt.updateMarker(todayMarkerId);
            }, 1000 * 60); // Update every minute
        }

        // --- Data Loading ---

        // Option 1: Load hardcoded dummy data (current implementation)
        
        // Function to format date for Gantt
        function formatDate(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}-${month}-${year}`;
        }

        const fixedData = [
            {id: 1, text: "Project #1 (Fixed)", start_date: "20-02-2026", duration: 20, progress: 0.4, open: true},
            {id: 2, text: "Task #1-1", start_date: "21-02-2026", duration: 8, progress: 0.6, parent: 1},
            {id: 3, text: "Task #1-2", start_date: "01-03-2026", duration: 8, progress: 0.6, parent: 1},
            {id: 4, text: "Project #2 (Fixed)", start_date: "21-02-2026", duration: 12, progress: 0.8, open: true},
            {id: 5, text: "Task #2-1", start_date: "22-02-2026", duration: 7, progress: 0.7, parent: 4},

            {id: 6, text: "Legacy System Audit", start_date: "20-11-2025", duration: 40, progress: 1, open: false},
            {id: 7, text: "Audit: Phase 1", start_date: "20-11-2025", duration: 10, progress: 1, parent: 6},
            {id: 8, text: "Audit: Phase 2", start_date: "30-11-2025", duration: 15, progress: 1, parent: 6},
            {id: 9, text: "Audit: Phase 3", start_date: "15-12-2025", duration: 10, progress: 1, parent: 6},
            {id: 10, text: "2025 Website SEO", start_date: "01-12-2025", duration: 50, progress: 1, open: false},
            {id: 11, text: "SEO: Keyword Research", start_date: "01-12-2025", duration: 15, progress: 1, parent: 10},
            {id: 12, text: "SEO: On-page Optimization", start_date: "16-12-2025", duration: 20, progress: 1, parent: 10},
            {id: 13, text: "SEO: Final Report", start_date: "05-01-2026", duration: 10, progress: 1, parent: 10},

            {id: 14, text: "Q1 Marketing Campaign", start_date: "20-01-2026", duration: 60, progress: 0.65, open: true},
            {id: 15, text: "Campaign: Planning", start_date: "20-01-2026", duration: 10, progress: 0.9, parent: 14},
            {id: 16, text: "Campaign: Creatives", start_date: "30-01-2026", duration: 20, progress: 0.7, parent: 14},
            {id: 17, text: "Campaign: Execution", start_date: "19-02-2026", duration: 25, progress: 0.3, parent: 14},
            {id: 18, text: "Mobile App Refactor", start_date: "01-02-2026", duration: 75, progress: 0.4, open: true},
            {id: 19, text: "Refactor: UI Kit", start_date: "01-02-2026", duration: 20, progress: 0.8, parent: 18},
            {id: 20, text: "Refactor: State Management", start_date: "21-02-2026", duration: 25, progress: 0.2, parent: 18},
            {id: 21, text: "Refactor: API Integration", start_date: "18-03-2026", duration: 20, progress: 0.1, parent: 18},
            
            {id: 22, text: "New BI Platform", start_date: "01-04-2026", duration: 90, progress: 0, open: true},
            {id: 23, text: "BI: Requirements", start_date: "01-04-2026", duration: 15, progress: 0, parent: 22},
            {id: 24, text: "BI: Vendor Selection", start_date: "16-04-2026", duration: 20, progress: 0, parent: 22},
            {id: 25, text: "BI: Implementation", start_date: "06-05-2026", duration: 40, progress: 0, parent: 22},
            {id: 26, text: "BI: Rollout", start_date: "25-06-2026", duration: 15, progress: 0, parent: 22},
            {id: 27, text: "2026 Rebranding Initiative", start_date: "15-04-2026", duration: 120, progress: 0, open: true},
            {id: 28, text: "Rebrand: Discovery", start_date: "15-04-2026", duration: 30, progress: 0, parent: 27},
            {id: 29, text: "Rebrand: Design Concepts", start_date: "15-05-2026", duration: 40, progress: 0, parent: 27},
            {id: 30, text: "Rebrand: Style Guide", start_date: "24-06-2026", duration: 30, progress: 0, parent: 27},
            {id: 31, text: "Rebrand: Website Update", start_date: "24-07-2026", duration: 20, progress: 0, parent: 27}
        ];
        const fixedLinks = [
            {id: 1, source: 1, target: 2, type: "1"}, {id: 2, source: 2, target: 3, type: "0"},
            {id: 3, source: 4, target: 5, type: "1"},
            {id: 4, source: 6, target: 7, type: "1"}, {id: 5, source: 7, target: 8, type: "0"}, {id: 6, source: 8, target: 9, type: "0"},
            {id: 7, source: 10, target: 11, type: "1"}, {id: 8, source: 11, target: 12, type: "0"}, {id: 9, source: 12, target: 13, type: "0"},
            {id: 10, source: 14, target: 15, type: "1"}, {id: 11, source: 15, target: 16, type: "0"}, {id: 12, source: 16, target: 17, type: "0"},
            {id: 13, source: 18, target: 19, type: "1"}, {id: 14, source: 19, target: 20, type: "0"}, {id: 15, source: 20, target: 21, type: "0"},
            {id: 16, source: 22, target: 23, type: "1"}, {id: 17, source: 23, target: 24, type: "0"}, {id: 18, source: 24, target: 25, type: "0"}, {id: 19, source: 25, target: 26, type: "0"},
            {id: 20, source: 27, target: 28, type: "1"}, {id: 21, source: 28, target: 29, type: "0"}, {id: 22, source: 29, target: 30, type: "0"}, {id: 23, source: 30, target: 31, type: "0"}
        ];

        let currentId = 32;
        let linkId = 24;

        const generatedData = [];
        const generatedLinks = [];

        let lastProjectId = 0;
        for (let i = 0; currentId <= 100; i++) {
            if (i % 8 === 0) { // Make every ~8th task a project
                lastProjectId = currentId;
                const startMonth = Math.floor(Math.random() * 5) + 3; // March to July
                const startDate = new Date(2026, startMonth - 1, Math.floor(Math.random() * 28) + 1);
                generatedData.push({
                    id: currentId,
                    text: `Proc. Project ${Math.floor(currentId / 8)}`,
                    start_date: formatDate(startDate),
                    duration: 50 + Math.floor(Math.random() * 20),
                    progress: Math.random().toFixed(2),
                    open: true
                });
            } else {
                const parentProject = (fixedData.concat(generatedData)).find(task => task.id === lastProjectId);
                const parentStartDate = parentProject ? new Date(parentProject.start_date.split('-').reverse().join('-')) : new Date();
                const startDate = new Date(parentStartDate.getTime());
                startDate.setDate(startDate.getDate() + Math.floor(Math.random() * 15));

                generatedData.push({
                    id: currentId,
                    text: `Proc. Sub-task ${currentId}`,
                    start_date: formatDate(startDate),
                    duration: 5 + Math.floor(Math.random() * 10),
                    progress: Math.random().toFixed(2),
                    parent: lastProjectId
                });
                if (currentId > lastProjectId + 1) {
                    generatedLinks.push({ id: linkId++, source: currentId - 1, target: currentId, type: '0' });
                } else {
                    generatedLinks.push({ id: linkId++, source: lastProjectId, target: currentId, type: '1' });
                }
            }
            currentId++;
        }

        const dummyTasks = {
            data: fixedData.concat(generatedData),
            links: fixedLinks.concat(generatedLinks)
        };
        initGantt(dummyTasks);


        /*
        // Option 2: Load data from the server (for future use)
        // When you have a backend API endpoint (e.g., /api/gantt-data), you can use this code.
        
        fetch("/api/gantt-data")
            .then(response => response.json())
            .then(data => {
                initGantt(data);
            })
            .catch(error => {
                console.error("Error loading Gantt data from server:", error);
            });
        */
    </script>

</body>
</html>
