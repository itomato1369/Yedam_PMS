<!DOCTYPE html>
<html lang="ko" xmlns:th="https://www.thymeleaf.org/"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layouts/full-default-layout}"
      layout:fragment="Content">
<head>
    <meta charset="UTF-8">
    <title>Gantt Chart</title>
    <style>
        /*
         The gantt chart container needs a defined height.
         The default layout (CoreUI) uses flexbox, but the intermediate containers don't have a height set.
         We will use viewport height (vh) units and CSS calc() to set the height of our chart's wrapper,
         subtracting the approximate height of the header and padding to make it fit nicely.
        */
        .gantt-wrapper {
            /* 100vh = 100% of the viewport height. 120px is an estimate for header/padding. Adjust if needed. */
            height: calc(100vh - 120px);
            width: 100%;
        }
        /* The gantt container itself should fill its wrapper */
        #gantt_here {
            height: 100%;
            width: 100%;
        }
    </style>
    <!--/* <link th:href="@{/dhtmlx/gantt/dhtmlxgantt.css}" rel="stylesheet">
    <script th:src="@{/dhtmlx/gantt/dhtmlxgantt.js}"></script> */-->
    <link href="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.css" rel="stylesheet">
    <script src="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.js"></script>
    <script src="https://cdn.dhtmlx.com/gantt/edge/locales/locale_kr.js"></script>
</head>
<body>
    <div class="gantt-wrapper">
        <div id="gantt_here"></div>
    </div>

<script th:inline="javascript">
    gantt.plugins({ marker: true });

    function initGantt(tasks) {
        gantt.i18n.setLocale("kr");
        
        // [수정됨] 둥글둥글하고 부드러운 디자인의 스킨으로 변경
        gantt.setSkin("terrace"); 

        gantt.config.date_format = "%d-%m-%Y";

        gantt.config.columns = [
            { name: "text",       label: "작업명",  tree: true, width: "*" },
            { name: "start_date", label: "시작일",  align: "center" },
            { name: "duration",   label: "기간(일)", align: "center" },
            { name: "add",        label: "",       width: 44 }
        ];

        gantt.config.scales = [
            { unit: "month", step: 1, format: "%Y년 %n월" },
            { unit: "day",   step: 1, format: "%d일 (%D)" } 
        ];

        gantt.templates.rightside_text = function (start, end, task) {
            return "ID: #" + task.id;
        };
        gantt.templates.leftside_text = function (start, end, task) {
            return task.duration + " days";
        };

        gantt.init("gantt_here");
        gantt.parse(tasks);

        var dateToStr = gantt.date.date_to_str(gantt.config.task_date);
        var todayMarkerId = gantt.addMarker({
            start_date: new Date(),
            css: "today",
            text: "오늘",
            title: dateToStr(new Date())
        });

        setInterval(function() {
            var todayMarker = gantt.getMarker(todayMarkerId);
            todayMarker.start_date = new Date();
            todayMarker.title = dateToStr(todayMarker.start_date);
            gantt.updateMarker(todayMarkerId);
        }, 1000 * 60);
    }

    // 1. 서버에서 데이터 가져오기 (links는 빈 배열로 초기화)
    const backendData = /*[[${ganttData}]]*/ { data: [], links: [] }; 

    // 2. JS에서 데이터를 순회하며 속성 및 연결선(Links) 자동 부여
    let linkIdCounter = 1;
    let previousTaskByParent = {}; // 부모 ID별로 '직전 작업'을 기억하기 위한 객체

    backendData.data.forEach(task => {
        
        // [요구사항 1 & 3] 최상위(parent가 0)이거나 하위 '프로젝트(p)'인 경우
        if (task.parent === "0" || String(task.id).startsWith("p")) {
            task.open = true;        // 폴더를 기본으로 열어둠
            task.type = "project";   // 모양을 '요약 바'로 바꾸고, 날짜 자동 계산 활성화
        }

        // [요구사항 2] 노란색 연결선(Link) 자동 생성
        // 같은 부모(parent) 안에 있는 작업들끼리 순서대로 선을 긋습니다.
        let parentId = task.parent || "0";
        let prevSibling = previousTaskByParent[parentId]; // 같은 부모의 직전 작업

        if (prevSibling) {
            // 직전 작업과 현재 작업을 연결하는 링크 데이터를 추가
            backendData.links.push({
                id: linkIdCounter++,
                source: prevSibling.id,
                target: task.id,
                type: "0" // 0 = Finish-to-Start (앞 작업 끝나면 뒤 작업 시작)
            });
        }
        
        // 현재 작업을 이 부모 그룹의 '직전 작업'으로 기록하여 다음 루프 때 쓰도록 갱신
        previousTaskByParent[parentId] = task; 
    });

    // 3. 가공이 완료된 데이터로 차트 렌더링
    initGantt(backendData);
</script>

</body>
</html>
