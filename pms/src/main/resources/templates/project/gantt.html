<!DOCTYPE html>
<html lang="ko" xmlns:th="https://www.thymeleaf.org/"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layouts/default-layout}"
      layout:fragment="Content">
<head>
    <meta charset="UTF-8">
    <title>Gantt Chart</title>
    <style>
        /*
         The gantt chart container needs a defined height.
         The default layout (CoreUI) uses flexbox, but the intermediate containers don't have a height set.
         We will use viewport height (vh) units and CSS calc() to set the height of our chart's wrapper,
         subtracting the approximate height of the header and padding to make it fit nicely.
        */
        .gantt-wrapper {
            /* 100vh = 100% of the viewport height. 120px is an estimate for header/padding. Adjust if needed. */
            height: calc(100vh - 120px);
            width: 100%;
        }
        /* The gantt container itself should fill its wrapper */
        #gantt_here {
            height: 100%;
            width: 100%;
        }
    </style>
    <!--/* <link th:href="@{/dhtmlx/gantt/dhtmlxgantt.css}" rel="stylesheet">
    <script th:src="@{/dhtmlx/gantt/dhtmlxgantt.js}"></script> */-->
    <link href="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.css" rel="stylesheet">
    <script src="https://cdn.dhtmlx.com/gantt/edge/dhtmlxgantt.js"></script>
    <script src="https://cdn.dhtmlx.com/gantt/edge/locales/locale_kr.js"></script>
</head>
<body>
    <div class="gantt-wrapper">
        <div id="gantt_here"></div>
    </div>

    <script th:inline="javascript">
    gantt.plugins({
        marker: true
    });

    function initGantt(tasks) {
        gantt.i18n.setLocale("kr");
        gantt.setSkin("meadow");

        // [추가] 백엔드(DB)에서 넘어오는 String 날짜 포맷 명시 (예: "yyyy-MM-dd")
        // 만약 시간까지 넘어온다면 "%Y-%m-%d %H:%i:%s" 로 설정하세요.
        gantt.config.date_format = "%d-%m-%Y";

        gantt.config.columns = [
            { name: "text",       label: "작업명",  tree: true, width: "*" },
            { name: "start_date", label: "시작일",  align: "center" },
            { name: "duration",   label: "기간(일)", align: "center" },
            { name: "add",        label: "",       width: 44 }
        ];

        gantt.config.scales = [
            { unit: "month", step: 1, format: "%Y년 %n월" },
            { unit: "day",   step: 1, format: "%d일 (%D)" } 
        ];

        gantt.templates.rightside_text = function (start, end, task) {
            return "ID: #" + task.id;
        };
        gantt.templates.leftside_text = function (start, end, task) {
            return task.duration + " days";
        };

        gantt.init("gantt_here");
        gantt.parse(tasks);

        var dateToStr = gantt.date.date_to_str(gantt.config.task_date);
        var todayMarkerId = gantt.addMarker({
            start_date: new Date(),
            css: "today",
            text: "오늘",
            title: dateToStr(new Date())
        });

        setInterval(function() {
            var todayMarker = gantt.getMarker(todayMarkerId);
            todayMarker.start_date = new Date();
            todayMarker.title = dateToStr(todayMarker.start_date);
            gantt.updateMarker(todayMarkerId);
        }, 1000 * 60);
    }

    // 1. Thymeleaf 인라인을 통해 Java List를 JSON 배열로 파싱
    // 데이터가 비어있을 경우를 대비해 기본값 [] 할당
    const backendData = /*[[${ganttData}]]*/ { data: [], links: [] }; 

    // 2. DHTMLX가 요구하는 객체 포맷으로 래핑
    const parsedData = {
        data: backendData,
        links: [] // 추후 의존성 선 렌더링 시 여기에 링크 배열 추가
    };

    // 3. 차트 초기화
    initGantt(backendData);
</script>

</body>
</html>
