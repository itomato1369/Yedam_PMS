<!DOCTYPE html>
<html lang="ko" xmlns:th="https://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/default-layout}">

<div layout:fragment="Content">
	<div class="container-fluid">
		<div class="card mb-4 border-top-primary border-top-4 shadow-sm">
			<div
				class="card-body d-flex justify-content-between align-items-center">
				<div>
					<nav aria-label="breadcrumb">
						<ol class="breadcrumb mb-1">
							<li class="breadcrumb-item"><a th:href="@{/settings}">ì„¤ì •</a></li>
							<li class="breadcrumb-item active">ê·¸ë£¹ ìƒì„¸ ê´€ë¦¬</li>
						</ol>
					</nav>
					<h3 class="mb-0">
						<i class="cil-group me-2"></i> <span id="groupTitle">ê·¸ë£¹ ì •ë³´
							ë¡œë”© ì¤‘...</span> <span id="groupStatusBadge" class="badge ms-2"></span>
					</h3>
				</div>
				<div class="btn-group">
					<button type="button" class="btn btn-outline-secondary"
						onclick="history.back()">
						<i class="cil-arrow-left"></i> ë’¤ë¡œê°€ê¸°
					</button>
					<button type="button" id="btnToggleStatus" class="btn">
						<i id="statusIcon"></i> <span id="statusText">ë¡œë”© ì¤‘...</span>
					</button>
				</div>
			</div>
		</div>

		<div class="row">
			<div class="col-lg-7">
				<div class="card mb-4 shadow-sm">
					<div
						class="card-header bg-light d-flex justify-content-between align-items-center py-3">
						<strong class="fs-5"><i class="cil-user me-2"></i>ì†Œì† ë©¤ë²„
							ëª…ë‹¨</strong>
						<div>
							<button class="btn btn-primary btn-sm px-3" id="btnOpenModal">
								<i class="cil-user-follow me-1"></i> ë©¤ë²„ ì¶”ê°€
							</button>
							<span class="badge bg-info text-white ms-2" id="memberCount">0ëª…</span>
						</div>
					</div>
					<div class="card-body">
						<div class="table-responsive">
							<table class="table table-hover align-middle border-bottom">
								<thead class="table-light">
									<tr class="text-center">
										<th>ì•„ì´ë””</th>
										<th>ì´ë¦„</th>
										<th>í•©ë¥˜ì¼</th>
										<th>ì‘ì—…</th>
									</tr>
								</thead>
								<tbody id="memberListTable"></tbody>
							</table>
						</div>
					</div>
				</div>
			</div>

			<div class="col-lg-5">
				<div class="card mb-4 shadow-sm border-top-info border-top-4">
					<div
						class="card-header bg-light py-3 d-flex justify-content-between align-items-center">
						<strong class="fs-5"><i class="cil-shield-alt me-2"></i>ê·¸ë£¹
							ê¶Œí•œ ì„¤ì •</strong> <span id="saveStatus" class="badge bg-secondary opacity-50">ìë™
							ì €ì¥ë¨</span>
					</div>
					<div class="card-body">
						<p class="text-muted small mb-3">
							ì´ ê·¸ë£¹ì— ë¶€ì—¬í•  ì—­í• ì„ ì„ íƒí•˜ì„¸ìš”. <strong>ê·¸ë£¹ë‹¹ í•˜ë‚˜ì˜ ì—­í• ë§Œ</strong> ë¶€ì—¬í•  ìˆ˜ ìˆìœ¼ë©°, ì„ íƒ ì‹œ
							ì¦‰ì‹œ ë°˜ì˜ë©ë‹ˆë‹¤.
						</p>
						<div id="roleListContainer" class="list-group shadow-sm">
							<div class="text-center py-5">
								<div class="spinner-border text-primary" role="status"></div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="userSearchModal" tabindex="-1"
		aria-hidden="true">
		<div class="modal-dialog modal-lg modal-dialog-scrollable">
			<div class="modal-content border-0 shadow-lg">
				<div class="modal-header bg-primary text-white">
					<h5 class="modal-title">
						<i class="cil-user-plus me-2"></i>ìƒˆ ë©¤ë²„ ì¼ê´„ ì¶”ê°€
					</h5>
					<button type="button" class="btn-close btn-close-white"
						data-coreui-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body p-4">
					<div class="input-group mb-4 shadow-sm">
						<span class="input-group-text bg-white border-end-0"><i
							class="cil-filter"></i></span> <input type="text" id="modalFilterInput"
							class="form-control border-start-0 ps-0"
							placeholder="ì´ë¦„ ë˜ëŠ” ì•„ì´ë””ë¡œ ê²€ìƒ‰...">
					</div>
					<div class="table-responsive">
						<table class="table table-hover align-middle">
							<thead class="table-light sticky-top">
								<tr>
									<th style="width: 45px;"><input type="checkbox"
										id="checkAll" class="form-check-input"></th>
									<th>ì•„ì´ë””</th>
									<th>ì´ë¦„</th>
									<th>ì´ë©”ì¼</th>
								</tr>
							</thead>
							<tbody id="modalSearchResultTable"></tbody>
						</table>
					</div>
				</div>
				<div class="modal-footer bg-light border-0">
					<button type="button" class="btn btn-secondary"
						data-coreui-dismiss="modal">ì·¨ì†Œ</button>
					<button type="button" class="btn btn-primary px-4" id="btnBatchAdd">ì„ íƒ
						ë©¤ë²„ ì¶”ê°€</button>
				</div>
			</div>
		</div>
	</div>

	<script th:inline="javascript">
        // íƒ€ì„ë¦¬í”„ë¥¼ í†µí•´ ì „ë‹¬ë°›ì€ ê·¸ë£¹ ë²ˆí˜¸
        const GROUP_NO = [[${groupNo}]];
        let searchModal;

        $(document).ready(function() {
            // CoreUI/Bootstrap ëª¨ë‹¬ ì´ˆê¸°í™”
            searchModal = new coreui.Modal(document.getElementById('userSearchModal'));
            
            // í˜ì´ì§€ ì´ˆê¸° ë¡œë“œ
            loadAllData();

            /**
             * 1. ë©”ì¸ ë°ì´í„° ë¡œë“œ (ê·¸ë£¹ ì •ë³´ + ë©¤ë²„ + ë¶€ì—¬ëœ ê¶Œí•œ)
             */
            function loadAllData() {
                $.get(`/api/groups/${GROUP_NO}`, function(data) {
                    renderHeader(data);    // ê·¸ë£¹ ì´ë¦„ ë° ìƒíƒœ
                    renderMembers(data.members); // ë©¤ë²„ ëª©ë¡
                    loadAllRoles(data.roles);    // ì „ì²´ ê¶Œí•œ ëª©ë¡ ë¡œë“œ ë° í˜„ì¬ ê¶Œí•œ ì²´í¬
                }).fail(function() {
                    console.error("ê·¸ë£¹ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                });
            }

            /**
             * 2. ìƒë‹¨ í—¤ë” ë Œë”ë§
             */
            function renderHeader(data) {
                $('#groupTitle').text(data.groupName || 'ê·¸ë£¹ ìƒì„¸');
                const $badge = $('#groupStatusBadge');
                // 510: ì‚¬ìš©ì¤‘ ìƒíƒœ ì½”ë“œ (ì‚¬ìš©ì í™˜ê²½ì— ë§ê²Œ ì¡°ì ˆ)
                if(data.status === 510) {
                    $badge.text('ì‚¬ìš©ì¤‘').addClass('bg-success').removeClass('bg-warning');
                } else {
                    $badge.text('ì¤‘ì§€ë¨').addClass('bg-warning').removeClass('bg-success');
                }
            }

            /**
             * 3. ì†Œì† ë©¤ë²„ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
             */
            function renderMembers(members) {
                const $tbody = $('#memberListTable').empty();
                $('#memberCount').text(`${members ? members.length : 0}ëª…`);
                
                if(!members || members.length === 0) {
                    $tbody.append('<tr><td colspan="4" class="text-center py-5 text-muted">ì†Œì†ëœ ë©¤ë²„ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>');
                    return;
                }

                members.forEach(m => {
                    $tbody.append(`
                        <tr class="text-center">
                            <td><code>${m.userId}</code></td>
                            <td class="text-start ps-4"><strong>${m.userName}</strong></td>
                            <td class="small text-muted">${m.accessDate || '-'}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-danger btn-remove-member" data-id="${m.userId}">
                                    ì œì™¸
                                </button>
                            </td>
                        </tr>
                    `);
                });
            }

            /**
             * 4. [ìš°ì¸¡ ì‚¬ì´ë“œ] ì „ì²´ ê¶Œí•œ ëª©ë¡ ë¡œë“œ ë° ì„ íƒ í‘œì‹œ
             * @param assignedRoles í˜„ì¬ ê·¸ë£¹ì— í• ë‹¹ëœ ê¶Œí•œ ë°°ì—´
             */
            function loadAllRoles(assignedRoles) {
                const assignedRoleNo = (assignedRoles && assignedRoles.length > 0) ? assignedRoles[0].roleNo : null;

                // ğŸ“ ì¤‘ìš”: ì»¨íŠ¸ë¡¤ëŸ¬ ë§¤í•‘ì— ë”°ë¼ /api/groups/rolesë¡œ í˜¸ì¶œ
                $.get('/api/groups/roles', function(allRoles) {
                    const $container = $('#roleListContainer').empty();
                    
                    allRoles.forEach(role => {
                        const isChecked = role.roleNo === assignedRoleNo;
                        $container.append(`
                            <label class="list-group-item d-flex justify-content-between align-items-center py-3 ${isChecked ? 'bg-light border-primary' : ''}" style="cursor: pointer;">
                                <div>
                                    <input class="form-check-input me-3 role-radio" type="radio" name="groupRole" 
                                           value="${role.roleNo}" ${isChecked ? 'checked' : ''}>
                                    <span class="${isChecked ? 'fw-bold text-primary' : ''}">${role.roleName}</span>
                                </div>
                                ${isChecked ? '<span class="badge bg-primary rounded-pill shadow-sm">í˜„ì¬ ê¶Œí•œ</span>' : ''}
                            </label>
                        `);
                    });
                }).fail(function() {
                    $('#roleListContainer').html('<p class="text-center py-4 text-danger small">ê¶Œí•œ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨ (API í™•ì¸ í•„ìš”)</p>');
                });
            }

            /**
             * 5. [ìš°ì¸¡ ì‚¬ì´ë“œ] ê¶Œí•œ ë³€ê²½ ì´ë²¤íŠ¸ (ë¼ë””ì˜¤ ë²„íŠ¼ í´ë¦­ ì‹œ ì¦‰ì‹œ ì €ì¥)
             */
            $(document).on('change', 'input[name="groupRole"]', function() {
                const newRoleNo = $(this).val();
                $('#saveStatus').text('ì €ì¥ ì¤‘...').removeClass('bg-secondary bg-success').addClass('bg-warning opacity-100');

                $.ajax({
                    url: `/api/groups/${GROUP_NO}/roles`,
                    type: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify({ roleNo: parseInt(newRoleNo) }),
                    success: function() {
                        setTimeout(() => {
                            $('#saveStatus').text('ë³€ê²½ ì™„ë£Œ').removeClass('bg-warning').addClass('bg-success');
                            loadAllData(); // ê°•ì¡° í‘œì‹œë¥¼ ìœ„í•´ ë¦¬ë¡œë“œ
                            setTimeout(() => {
                                $('#saveStatus').text('ìë™ ì €ì¥ë¨').attr('class', 'badge bg-secondary opacity-50');
                            }, 2000);
                        }, 500);
                    },
                    error: function() {
                        alert("ê¶Œí•œ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                        loadAllData();
                    }
                });
            });

            /**
             * 6. [ëª¨ë‹¬] ë©¤ë²„ ì¶”ê°€ ëª¨ë‹¬ ì—´ê¸° ë° ê°€ìš© ìœ ì € ì „ì²´ ë¡œë“œ
             */
            $('#btnOpenModal').on('click', function() {
                $('#modalFilterInput').val('');
                $('#checkAll').prop('checked', false);
                
                // ê²€ìƒ‰ì–´ ì—†ì´ ì „ì²´ ê°€ìš© ìœ ì € ìš”ì²­
                $.get(`/api/groups/${GROUP_NO}/available-users`, { keyword: '' }, function(users) {
                    const $tbody = $('#modalSearchResultTable').empty();
                    
                    if(!users || users.length === 0) {
                        $tbody.append('<tr><td colspan="4" class="text-center py-5 text-muted">ì¶”ê°€ ê°€ëŠ¥í•œ ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>');
                    } else {
                        users.forEach(u => {
                            $tbody.append(`
                                <tr class="user-row-item">
                                    <td><input type="checkbox" class="form-check-input user-check" value="${u.userId}"></td>
                                    <td><code>${u.userId}</code></td>
                                    <td class="user-name"><strong>${u.userName || u.username}</strong></td>
                                    <td class="small text-muted">${u.email || '-'}</td>
                                </tr>
                            `);
                        });
                    }
                    searchModal.show();
                });
            });

            /**
             * 7. [ëª¨ë‹¬] ê²°ê³¼ ë‚´ ì‹¤ì‹œê°„ í•„í„°ë§
             */
            $('#modalFilterInput').on('input', function() {
                const val = $(this).val().toLowerCase();
                $('.user-row-item').each(function() {
                    const text = $(this).text().toLowerCase();
                    $(this).toggle(text.indexOf(val) > -1);
                });
            });

            /**
             * 8. [ëª¨ë‹¬] ì²´í¬ë°•ìŠ¤ ì „ì²´ ì„ íƒ
             */
            $('#checkAll').on('change', function() {
                $('.user-check:visible').prop('checked', $(this).prop('checked'));
            });

            /**
             * 9. [ëª¨ë‹¬] ì„ íƒ ë©¤ë²„ ì¼ê´„ ì¶”ê°€ ì‹¤í–‰
             */
            $('#btnBatchAdd').on('click', function() {
                const selectedIds = [];
                $('.user-check:checked').each(function() {
                    selectedIds.push($(this).val());
                });

                if(selectedIds.length === 0) {
                    alert("ì¶”ê°€í•  ì‚¬ìš©ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                    return;
                }

                if(!confirm(`${selectedIds.length}ëª…ì„ ê·¸ë£¹ì— ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

                // ì—¬ëŸ¬ ê±´ì˜ ì¶”ê°€ ìš”ì²­ì„ ë³‘ë ¬ë¡œ ì²˜ë¦¬
                const addRequests = selectedIds.map(id => {
                    return $.ajax({
                        url: `/api/groups/${GROUP_NO}/members`,
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({ userId: id })
                    });
                });

                Promise.all(addRequests)
                    .then(() => {
                        searchModal.hide();
                        loadAllData();
                    })
                    .catch(err => {
                        alert("ì¼ë¶€ ìœ ì € ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                        loadAllData();
                    });
            });

            /**
             * 10. ë©¤ë²„ ì œì™¸ ì²˜ë¦¬
             */
            $(document).on('click', '.btn-remove-member', function() {
                const userId = $(this).data('id');
                if(!confirm(`[${userId}] ì‚¬ìš©ìë¥¼ ê·¸ë£¹ì—ì„œ ì œì™¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
                
                $.ajax({
                    url: `/api/groups/${GROUP_NO}/members/${userId}`,
                    type: 'DELETE',
                    success: function() {
                        loadAllData();
                    },
                    error: function() {
                        alert("ì œì™¸ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    }
                });
            });
            function loadAllData() {
                $.get(`/api/groups/${GROUP_NO}`, function(data) {
                    renderHeader(data);    
                    renderMembers(data.members);
                    loadAllRoles(data.roles); 
                    // ğŸ“ ë²„íŠ¼ UI ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ renderHeaderì— ë°ì´í„° ì „ë‹¬
                });
            }

            function renderHeader(data) {
                $('#groupTitle').text(data.groupName || 'ê·¸ë£¹ ìƒì„¸');
                const $badge = $('#groupStatusBadge');
                const $btn = $('#btnToggleStatus');
                const $icon = $('#statusIcon');
                const $text = $('#statusText');

                // ìƒíƒœ ì½”ë“œ 510(ì‚¬ìš©ì¤‘), ê·¸ ì™¸(ì¤‘ì§€ë¨) ê°€ì •
                if(data.status === 510) {
                    $badge.text('ì‚¬ìš©ì¤‘').attr('class', 'badge ms-2 bg-success');
                    $btn.attr('class', 'btn btn-outline-warning'); // ì¤‘ì§€ì‹œí‚¬ ìˆ˜ ìˆê²Œ ê²½ê³ ìƒ‰
                    $icon.attr('class', 'cil-media-pause me-1');
                    $text.text('ê·¸ë£¹ ì¤‘ì§€');
                } else {
                    $badge.text('ì¤‘ì§€ë¨').attr('class', 'badge ms-2 bg-warning');
                    $btn.attr('class', 'btn btn-outline-success'); // ì‚¬ìš©ê°€ëŠ¥í•˜ê²Œ ì„±ê³µìƒ‰
                    $icon.attr('class', 'cil-media-play me-1');
                    $text.text('ê·¸ë£¹ ì‚¬ìš©');
                }
            }

            /**
             * ğŸ“ ê¸°ì¡´ GroupsControllerì˜ toggle-status API í˜¸ì¶œ
             */
            $('#btnToggleStatus').on('click', function() {
                const msg = "ê·¸ë£¹ ìƒíƒœë¥¼ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
                if(!confirm(msg)) return;

                $.ajax({
                    // ğŸ“ ì„¼ì„¸ê°€ ë³´ì—¬ì£¼ì‹  ì»¨íŠ¸ë¡¤ëŸ¬ì˜ Mapping ì£¼ì†Œ ê·¸ëŒ€ë¡œ ì‚¬ìš©!
                    url: `/settings/api/groups/${GROUP_NO}/toggle-status`,
                    type: 'PATCH',
                    success: function() {
                        // ì„±ê³µ ì‹œ ë‹¤ì‹œ ë°ì´í„°ë¥¼ ì½ì–´ì™€ì„œ UI ê°±ì‹ 
                        loadAllData();
                    },
                    error: function() {
                        alert("ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. API ê²½ë¡œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
                    }
                });
            });
        });
    </script>
</div>
</html>