<!DOCTYPE html>
<html lang="ko" xmlns:th="https://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layouts/default-layout}">

<div layout:fragment="Content">
    <div class="container-fluid">
        <div class="card mb-4 border-top-primary border-top-4 shadow-sm">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-1">
                            <li class="breadcrumb-item"><a th:href="@{/settings}">ì„¤ì •</a></li>
                            <li class="breadcrumb-item active">ê·¸ë£¹ ìƒì„¸ ê´€ë¦¬</li>
                        </ol>
                    </nav>
                    <h3 class="mb-0">
                        <i class="cil-group me-2"></i>
                        <span id="groupTitle">ê·¸ë£¹ ì •ë³´ ë¡œë”© ì¤‘...</span>
                        <span id="groupStatusBadge" class="badge ms-2"></span>
                    </h3>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-outline-secondary" onclick="history.back()">
                        <i class="cil-arrow-left"></i> ë’¤ë¡œê°€ê¸°
                    </button>
                    <button type="button" id="btnRefresh" class="btn btn-outline-primary">
                        <i class="cil-reload"></i> ìƒˆë¡œê³ ì¹¨
                    </button>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-7">
                <div class="card mb-4 shadow-sm">
                    <div class="card-header bg-light d-flex justify-content-between align-items-center py-3">
                        <strong class="fs-5"><i class="cil-user me-2"></i>ì†Œì† ë©¤ë²„ ëª…ë‹¨</strong>
                        <div>
                            <button class="btn btn-primary btn-sm px-3" id="btnOpenModal">
                                <i class="cil-user-follow me-1"></i> ë©¤ë²„ ì¶”ê°€
                            </button>
                            <span class="badge bg-info text-white ms-2" id="memberCount">0ëª…</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle border-bottom">
                                <thead class="table-light">
                                    <tr class="text-center">
                                        <th>ì•„ì´ë””</th>
                                        <th>ì´ë¦„</th>
                                        <th>í•©ë¥˜ì¼</th>
                                        <th>ì‘ì—…</th>
                                    </tr>
                                </thead>
                                <tbody id="memberListTable">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-5">
                <div class="card mb-4 shadow-sm">
                    <div class="card-header bg-light py-3">
                        <strong class="fs-5"><i class="cil-shield-alt me-2"></i>ê·¸ë£¹ ê¶Œí•œ ì„¤ì •</strong>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small mb-3">í˜„ì¬ ê·¸ë£¹ì— í• ë‹¹ëœ ê¶Œí•œ ëª©ë¡ì…ë‹ˆë‹¤. ì²´í¬ë°•ìŠ¤ ê¸°ëŠ¥ì€ ì¶”í›„ í™•ì¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
                        <hr>
                        <div id="roleListContainer" class="list-group list-group-flush">
                            </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="userSearchModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="cil-user-plus me-2"></i>ìƒˆ ë©¤ë²„ ì¼ê´„ ì¶”ê°€</h5>
                    <button type="button" class="btn-close btn-close-white" data-coreui-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="input-group mb-4 shadow-sm">
                        <span class="input-group-text bg-white border-end-0"><i class="cil-filter"></i></span>
                        <input type="text" id="modalFilterInput" class="form-control border-start-0 ps-0" 
                               placeholder="ëª©ë¡ ë‚´ì—ì„œ ì´ë¦„ ë˜ëŠ” ì•„ì´ë””ë¡œ ê²€ìƒ‰í•˜ì„¸ìš”...">
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light sticky-top" style="top: -1px; z-index: 10;">
                                <tr>
                                    <th style="width: 45px;">
                                        <input type="checkbox" id="checkAll" class="form-check-input">
                                    </th>
                                    <th>ì•„ì´ë””</th>
                                    <th>ì´ë¦„</th>
                                    <th>ì´ë©”ì¼</th>
                                </tr>
                            </thead>
                            <tbody id="modalSearchResultTable">
                                </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer bg-light border-0">
                    <button type="button" class="btn btn-secondary" data-coreui-dismiss="modal">ì·¨ì†Œ</button>
                    <button type="button" class="btn btn-primary px-4" id="btnBatchAdd">
                        <i class="cil-check me-1"></i> ì„ íƒ ë©¤ë²„ ì¶”ê°€
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        const GROUP_NO = [[${groupNo}]];
        let searchModal;

        $(document).ready(function() {
            searchModal = new coreui.Modal(document.getElementById('userSearchModal'));
            loadAllData();

            // 1. ì „ì²´ ë°ì´í„° ë¡œë“œ
            function loadAllData() {
                $.get(`/api/groups/${GROUP_NO}`, function(data) {
                    renderHeader(data);
                    renderMembers(data.members); 
                    renderRoles(data.roles);
                });
            }

            function renderHeader(data) {
                $('#groupTitle').text(data.groupName || 'ê·¸ë£¹ ì •ë³´'); 
                const $badge = $('#groupStatusBadge');
                if(data.status === 510) {
                    $badge.text('ì‚¬ìš©ì¤‘').addClass('bg-success').removeClass('bg-warning');
                } else {
                    $badge.text('ì¤‘ì§€ë¨').addClass('bg-warning').removeClass('bg-success');
                }
            }

            function renderMembers(members) {
                const $tbody = $('#memberListTable').empty();
                $('#memberCount').text(`${members ? members.length : 0}ëª…`);
                
                if(!members || members.length === 0) {
                    $tbody.append('<tr><td colspan="4" class="text-center py-5 text-muted">ì†Œì†ëœ ë©¤ë²„ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>');
                    return;
                }

                members.forEach(m => {
                    $tbody.append(`
                        <tr class="text-center">
                            <td><code>${m.userId}</code></td>
                            <td class="text-start ps-4"><strong>${m.userName}</strong></td>
                            <td class="small text-muted">${m.accessDate || '-'}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-danger btn-remove-member" data-id="${m.userId}">
                                    ì œì™¸
                                </button>
                            </td>
                        </tr>
                    `);
                });
            }

            function renderRoles(roles) {
                const $container = $('#roleListContainer').empty();
                if(!roles || roles.length === 0) {
                    $container.append('<p class="text-center py-4 text-muted">ë¶€ì—¬ëœ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.</p>');
                    return;
                }
                roles.forEach(r => {
                    $container.append(`
                        <label class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
                            <div>
                                <input class="form-check-input me-3 role-checkbox" type="checkbox" checked data-id="${r.roleNo}">
                                <span>${r.roleName}</span>
                            </div>
                            <span class="badge rounded-pill bg-light text-primary border border-primary">Active</span>
                        </label>
                    `);
                });
            }

            // ğŸ“ 2. ëª¨ë‹¬ ì˜¤í”ˆ ì‹œ ì „ì²´ ê°€ìš© ìœ ì € ë¡œë”©
            $('#btnOpenModal').on('click', function() {
                $('#modalFilterInput').val('');
                $('#checkAll').prop('checked', false);
                
                // ê²€ìƒ‰ì–´ ì—†ì´ í˜¸ì¶œí•˜ì—¬ ì „ì²´ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                $.get(`/api/groups/${GROUP_NO}/available-users`, { keyword: '' }, function(users) {
                    const $tbody = $('#modalSearchResultTable').empty();
                    
                    if(!users || users.length === 0) {
                        $tbody.append('<tr><td colspan="4" class="text-center py-5 text-muted">ì¶”ê°€ ê°€ëŠ¥í•œ ìœ ì €ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>');
                    } else {
                        users.forEach(u => {
                            $tbody.append(`
                                <tr class="user-row-item">
                                    <td><input type="checkbox" class="form-check-input user-check" value="${u.userId}"></td>
                                    <td><code>${u.userId}</code></td>
                                    <td class="user-name"><strong>${u.userName || u.username}</strong></td>
                                    <td class="small text-muted">${u.email || '-'}</td>
                                </tr>
                            `);
                        });
                    }
                    searchModal.show();
                });
            });

            // ğŸ“ 3. ëª¨ë‹¬ ë‚´ ì‹¤ì‹œê°„ í•„í„°ë§ (í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ)
            $('#modalFilterInput').on('input', function() {
                const searchVal = $(this).val().toLowerCase();
                $('.user-row-item').each(function() {
                    const rowText = $(this).text().toLowerCase();
                    $(this).toggle(rowText.indexOf(searchVal) > -1);
                });
            });

            // ğŸ“ 4. ì²´í¬ë°•ìŠ¤ ì „ì²´ ì„ íƒ ê¸°ëŠ¥
            $('#checkAll').on('change', function() {
                $('.user-check:visible').prop('checked', $(this).prop('checked'));
            });

            // ğŸ“ 5. ì„ íƒ ë©¤ë²„ ì¼ê´„ ì¶”ê°€ ì‹¤í–‰
            $('#btnBatchAdd').on('click', function() {
                const selectedIds = [];
                $('.user-check:checked').each(function() {
                    selectedIds.push($(this).val());
                });

                if(selectedIds.length === 0) {
                    alert("ì¶”ê°€í•  ì‚¬ìš©ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                    return;
                }

                if(!confirm(`${selectedIds.length}ëª…ì˜ ì‚¬ìš©ìë¥¼ ê·¸ë£¹ì— ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

                // ìˆœì°¨ì  AJAX ì²˜ë¦¬ (Promise.all)
                const addRequests = selectedIds.map(id => {
                    return $.ajax({
                        url: `/api/groups/${GROUP_NO}/members`,
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({ userId: id })
                    });
                });

                Promise.all(addRequests)
                    .then(() => {
                        alert("ë©¤ë²„ ì¶”ê°€ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                        searchModal.hide();
                        loadAllData();
                    })
                    .catch(err => {
                        console.error(err);
                        alert("ì²˜ë¦¬ ì¤‘ ì¼ë¶€ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                        loadAllData();
                    });
            });

            // ë©¤ë²„ ì‚­ì œ (ì œì™¸)
            $(document).on('click', '.btn-remove-member', function() {
                const userId = $(this).data('id');
                if(!confirm(`[${userId}] ì‚¬ìš©ìë¥¼ ê·¸ë£¹ì—ì„œ ì œì™¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
                
                $.ajax({
                    url: `/api/groups/${GROUP_NO}/members/${userId}`,
                    type: 'DELETE',
                    success: function() { loadAllData(); },
                    error: function() { alert("ì‚­ì œ ì‹¤íŒ¨!"); }
                });
            });

            $('#btnRefresh').on('click', loadAllData);
        });
    </script>
</div>
</html>