<html layout:decorate="~{common/layouts/default_layout}">
<div layout:fragment="Content">
	<!-- í”„ë¡œì íŠ¸ ì•„ì½”ë””ì–¸ -->
	<div class="accordion" id="settingsAccordion">
		<div class="accordion-item">
			<h2 class="accordion-header">
				<button class="accordion-button" type="button"
					data-coreui-toggle="collapse" data-coreui-target="#collapseProject">
					í”„ë¡œì íŠ¸ ê´€ë¦¬</button>
			</h2>

			<div id="collapseProject" class="accordion-collapse collapse show"
				data-coreui-parent="#settingsAccordion">
				<div class="accordion-body">
					<div class="card mb-3">
						<div class="card-body">
							<form id="searchForm" class="row g-2">
								<div class="col-md-3">
									<select id="projectStatusSelect" name="status"
										class="form-select">
										<option value="">ì „ì²´ ìƒíƒœ</option>
										<th:block th:each="status : ${statusList}">
											<option th:value="${status.commonNo}"
												th:text="${status.commonName}"></option>
										</th:block>
									</select>
								</div>
								<div class="col-md-6">
									<input type="text" id="keyword" name="keyword"
										class="form-control" placeholder="í”„ë¡œì íŠ¸ëª… ê²€ìƒ‰">
								</div>
								<div class="col-md-3">
									<div class="d-flex gap-2">
										<button type="button" id="btnSearch"
											class="btn btn-primary w-100">
											<i class="cil-search"></i> ê²€ìƒ‰
										</button>
										<button type="button" id="btnProjectAdd"
											class="btn btn-success w-100 text-white">
											<i class="cil-plus"></i> ìƒì„±
										</button>
									</div>
								</div>
							</form>
						</div>
					</div>

					<div class="card">
						<div class="card-body p-0">
							<table
								class="table table-striped table-hover mb-0 text-center align-middle">
								<thead class="table-light">
									<tr>
										<th>ë²ˆí˜¸</th>
										<th>í”„ë¡œì íŠ¸ëª…</th>
										<th>ìƒíƒœ</th>
										<th>ê³µê°œ ì—¬ë¶€</th>
										<th>ë“±ë¡ì¼</th>
										<th>ê´€ë¦¬</th>
									</tr>
								</thead>
								<tbody id="projectTableBody">
									<tr th:each="p : ${projects}">
										<td th:text="${p.projectNo}"></td>
										<td class="text-start" th:text="${p.projectName}"></td>

										<td><span class="badge"
											th:classappend="${p.statusValue == 330 ? 'bg-success' : (p.statusValue == 350 ? 'bg-warning' : 'bg-info')}"
											th:text="${p.statusLabel}"></span></td>

										<td><span class="badge rounded-pill"
											th:classappend="${p.publicYn == 1 ? 'text-bg-light border' : 'text-bg-dark'}"
											th:text="${p.publicYnLabel}"></span></td>

										<td
											th:text="${p.createAt != null ? #temporals.format(p.createAt, 'yyyy/MM/dd') : '-'}"></td>

										<td>
											<button type="button" class="btn btn-sm btn-lock"
												th:classappend="${p.statusValue == 350 ? 'btn-outline-success' : 'btn-outline-warning'}"
												th:data-id="${p.projectNo}"
												th:data-status="${p.statusValue}">
												<i
													th:class="${p.statusValue == 350 ? 'cil-lock-locked' : 'cil-lock-unlocked'}"></i>
												<span th:text="${p.statusValue == 350 ? 'ì ê¸ˆí•´ì œ' : 'ì ê¸ˆ'}"></span>
											</button>

											<button class="btn btn-sm btn-outline-danger btn-delete"
												th:data-id="${p.projectNo}">ì‚­ì œ</button>
										</td>
									</tr>
									<tr th:if="${#lists.isEmpty(projects)}">
										<td colspan="6" class="py-4">ë“±ë¡ëœ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- ì‚¬ìš©ì ì•„ì½”ë””ì–¸ -->
		<div class="accordion-item">
			<h2 class="accordion-header">
				<button class="accordion-button collapsed" type="button"
					data-coreui-toggle="collapse" data-coreui-target="#collapseUser">
					ì‚¬ìš©ì ê´€ë¦¬</button>
			</h2>

			<div id="collapseUser" class="accordion-collapse collapse"
				data-coreui-parent="#settingsAccordion">
				<div class="accordion-body">
					<div class="card mb-3">
						<div class="card-body">
							<form id="userSearchForm" class="row g-2">
								<div class="col-md-3">
									<select id="userStatusSelect" name="status" class="form-select">
										<option value="">ì „ì²´ ìƒíƒœ</option>
									</select>
								</div>
								<div class="col-md-6">
									<input type="text" id="userKeyword" name="keyword"
										class="form-control" placeholder="ì´ë¦„ ê²€ìƒ‰">
								</div>
								<div class="col-md-3">
									<div class="d-flex gap-2">
										<button type="button" id="btnUserSearch"
											class="btn btn-primary w-100">
											<i class="cil-search"></i> ê²€ìƒ‰
										</button>
										<button type="button" id="btnUserAdd"
											class="btn btn-success w-100 text-white">
											<i class="cil-plus"></i> ë“±ë¡
										</button>
									</div>
								</div>
							</form>
						</div>
					</div>

					<div class="card">
						<div class="card-body p-0">
							<table
								class="table table-striped table-hover mb-0 text-center align-middle">
								<thead class="table-light">
									<tr>
										<th>ì•„ì´ë””</th>
										<th>ì´ë¦„</th>
										<th>ìƒíƒœ</th>
										<th>ê¶Œí•œ</th>
										<th>ì´ë©”ì¼</th>
										<th>ê°€ì…ì¼</th>
										<th>ê´€ë¦¬</th>
									</tr>
								</thead>
								<tbody id="userTableBody">
									<tr th:each="u : ${users}">
										<td th:text="${u.userId}"></td>
										<td class="text-start" th:text="${u.userName}"></td>

										<td><span class="badge"
											th:classappend="${u.status == 110 ? 'bg-success' : (u.status == 120 ? 'bg-info' : (u.status == 130 ? 'bg-warning' : 'bg-secondary'))}"
											th:text="${u.status == 110 ? 'ì‚¬ìš©ì¤‘' : (u.status == 120 ? 'ë“±ë¡ëŒ€ê¸°' : (u.status == 130 ? 'ì ê¸ˆ' : 'í‡´ì‚¬'))}">
										</span></td>

										<td><span class="badge"
											th:classappend="${u.admin == 1 ? 'bg-danger' : 'bg-info'}"
											th:text="${u.admin == 1 ? 'ê´€ë¦¬ì' : 'ì¼ë°˜'}"></span></td>
										<td th:text="${u.email}"></td>
										<td th:text="${#temporals.format(u.createTime, 'yyyy/MM/dd')}"></td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- ê·¸ë£¹ ì•„ì½”ë””ì–¸ -->
		<div class="accordion-item">
			<h2 class="accordion-header">
				<button class="accordion-button collapsed" type="button"
					data-coreui-toggle="collapse" data-coreui-target="#collapseGroup">
					ê·¸ë£¹ ê´€ë¦¬</button>
			</h2>

			<div id="collapseGroup" class="accordion-collapse collapse"
				data-coreui-parent="#settingsAccordion">

				<div class="accordion-body">

					<!-- ê²€ìƒ‰ ì˜ì—­ (ì„ íƒì‚¬í•­) -->
					<div class="card mb-3">
						<div class="card-body">
							<form id="groupSearchForm" class="row g-2">
								<div class="col-md-9">
									<input type="text" id="groupKeyword" class="form-control"
										placeholder="ê·¸ë£¹ëª… ê²€ìƒ‰">
								</div>
								<div class="col-md-3">
									<div class="d-flex gap-2">
										<button type="button" id="btnGroupSearch"
											class="btn btn-primary w-100">ê²€ìƒ‰</button>
										<button type="button" id="btnGroupAdd"
											class="btn btn-success w-100 text-white">
											<i class="cil-plus"></i> ìƒì„±
										</button>
									</div>
								</div>
							</form>
						</div>
					</div>

					<!-- ê·¸ë£¹ í…Œì´ë¸” -->
					<div class="card">
						<div class="card-body p-0">

							<table
								class="table table-striped table-hover mb-0 text-center align-middle">
								<thead class="table-light">
									<tr>
										<th>ë²ˆí˜¸</th>
										<th>ê·¸ë£¹ëª…</th>
										<th>ìƒíƒœ</th>
										<th>ê´€ë¦¬</th>
									</tr>
								</thead>
								<tbody id="groupTableBody">
								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- ì—­í•  ì•„ì½”ë””ì–¸ -->
		<div class="accordion-item">
			<h2 class="accordion-header">
				<button class="accordion-button collapsed" type="button"
					data-coreui-toggle="collapse" data-coreui-target="#collapseRoles">
					í”„ë¡œì íŠ¸ ì—­í•  ê´€ë¦¬</button>
			</h2>
			<div id="collapseRoles" class="accordion-collapse collapse"
				data-coreui-parent="#settingsAccordion">
				<div class="accordion-body">
					<div class="card mb-3">
						<div class="card-body">
							<div class="row g-2">
								<div class="col-md-9">
									<input type="text" id="roleKeyword" class="form-control"
										placeholder="ì—­í• ëª… ê²€ìƒ‰">
								</div>
								<div class="col-md-3">
									<div class="d-flex gap-2">
										<button type="button" id="btnRoleSearch"
											class="btn btn-primary w-100">ê²€ìƒ‰</button>
										<button type="button" id="btnRoleAdd"
											class="btn btn-success w-100 text-white">
											<i class="cil-plus"></i> ì¶”ê°€
										</button>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="card">
						<div class="card-body p-0">
							<table
								class="table table-striped table-hover mb-0 text-center align-middle">
								<thead class="table-light">
									<tr>
										<th>ì—­í• ëª…</th>
										<th>ê´€ë¦¬</th>
									</tr>
								</thead>
								<tbody id="roleTableBody">
								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- ì¼ê° ìƒíƒœ ì•„ì½”ë””ì–¸ -->
		<div class="accordion-item">
			<h2 class="accordion-header">
				<button class="accordion-button collapsed" type="button"
					data-coreui-toggle="collapse"
					data-coreui-target="#collapseJobStatus">ì¼ê° ìƒíƒœ ê´€ë¦¬</button>
			</h2>
			<div id="collapseJobStatus" class="accordion-collapse collapse"
				data-coreui-parent="#settingsAccordion">
				<div class="accordion-body">
					<div class="card mb-3">
						<div class="card-body">
							<div class="row g-2">
								<div class="col-md-9">
									<input type="text" id="jobStatusKeyword" class="form-control"
										placeholder="ìƒíƒœëª… ê²€ìƒ‰">
								</div>
								<div class="col-md-3">
									<div class="d-flex gap-2">
										<button type="button" id="btnJobStatusSearch"
											class="btn btn-primary w-100">ê²€ìƒ‰</button>
										<button type="button" id="btnJobStatusAdd"
											class="btn btn-success w-100 text-white">
											<i class="cil-plus"></i> ì¶”ê°€
										</button>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="card">
						<div class="card-body p-0">
							<table
								class="table table-striped table-hover mb-0 text-center align-middle">
								<thead class="table-light">
									<tr>
										<th>ì¼ê° ìƒíƒœëª…</th>
										<th>ê´€ë¦¬</th>
									</tr>
								</thead>
								<tbody id="jobStatusTableBody"></tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- ì¼ê° ìœ í˜• ì•„ì½”ë””ì–¸ -->
		<div class="accordion-item">
			<h2 class="accordion-header">
				<button class="accordion-button collapsed" type="button"
					data-coreui-toggle="collapse" data-coreui-target="#collapseJobType">
					ì¼ê° ìœ í˜• ê´€ë¦¬</button>
			</h2>
			<div id="collapseJobType" class="accordion-collapse collapse"
				data-coreui-parent="#settingsAccordion">
				<div class="accordion-body">
					<div class="card mb-3">
						<div class="card-body">
							<div class="row g-2">
								<div class="col-md-9">
									<input type="text" id="jobTypeKeyword" class="form-control"
										placeholder="ìœ í˜•ëª… ê²€ìƒ‰">
								</div>
								<div class="col-md-3">
									<div class="d-flex gap-2">
										<button type="button" id="btnJobTypeSearch"
											class="btn btn-primary w-100">ê²€ìƒ‰</button>
										<button type="button" id="btnJobTypeAdd"
											class="btn btn-success w-100 text-white">
											<i class="cil-plus"></i> ì¶”ê°€
										</button>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="card">
						<div class="card-body p-0">
							<table
								class="table table-striped table-hover mb-0 text-center align-middle">
								<thead class="table-light">
									<tr>
										<th>ì¼ê° ìœ í˜•ëª…</th>
										<th>ê´€ë¦¬</th>
									</tr>
								</thead>
								<tbody id="jobTypeTableBody"></tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<script>
$(document).ready(function () {
    // 1. ì´ˆê¸° ë°ì´í„° ë¡œë”©
    performSearch();          // í”„ë¡œì íŠ¸ ì´ˆê¸° ì¡°íšŒ
    loadUserStatusOptions();  // ìœ ì € ìƒíƒœ ì˜µì…˜ ë¡œë“œ
    performUserSearch();      // ìœ ì € ì´ˆê¸° ì¡°íšŒ
    loadGroups();             // ê·¸ë£¹ ì´ˆê¸° ì¡°íšŒ

    // =============================
    // 1ï¸âƒ£ í”„ë¡œì íŠ¸ ê´€ë¦¬ ì˜ì—­
    // =============================
    
    // ê²€ìƒ‰ ì´ë²¤íŠ¸
    $('#btnSearch').on('click', performSearch);
    $('#keyword').on('keypress', (e) => { 
        if(e.which == 13) { e.preventDefault(); performSearch(); } 
    });

    function performSearch() {
        const status = $('#projectStatusSelect').val();
        const keyword = $('#keyword').val();
        $.ajax({
            url: '/settings/api/projects/search',
            type: 'GET',
            data: { status, keyword },
            success: renderProjectTable
        });
    }

    function renderProjectTable(projects) {
        const $tbody = $('#projectTableBody').empty();
        if (!projects || projects.length === 0) {
            $tbody.append('<tr><td colspan="6" class="py-4">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>');
            return;
        }

        projects.forEach(p => {
            let formattedDate = "-";
            if(p.createAt) {
                const date = new Date(p.createAt);
                formattedDate = `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
            }
            
            let statusColor = p.statusValue == 330 ? 'bg-success' : (p.statusValue == 350 ? 'bg-warning' : 'bg-info');
            const isLocked = (p.statusValue == 350); 
            const lockBtnClass = isLocked ? 'btn-outline-success' : 'btn-outline-warning';
            const lockIcon = isLocked ? 'cil-lock-locked' : 'cil-lock-unlocked';
            const lockText = isLocked ? 'ì ê¸ˆí•´ì œ' : 'ì ê¸ˆ';

            const row = `
                <tr>
                    <td>${p.projectNo}</td>
                    <td class="text-start">${p.projectName}</td>
                    <td><span class="badge ${statusColor}">${p.statusLabel}</span></td>
                    <td><span class="badge rounded-pill ${p.publicYn === 1 ? 'text-bg-light border' : 'text-bg-dark'}">${p.publicYnLabel}</span></td>
                    <td>${formattedDate}</td>
                    <td>
                        <button class="btn btn-sm btn-lock ${lockBtnClass}" data-id="${p.projectNo}" data-status="${p.statusValue}">
                            <i class="${lockIcon}"></i> ${lockText}
                        </button>
                        <button class="btn btn-sm btn-outline-danger btn-delete" data-id="${p.projectNo}">ì‚­ì œ</button>
                    </td>
                </tr>`;
            $tbody.append(row);
        });
    }

    // í”„ë¡œì íŠ¸ ì ê¸ˆ/í•´ì œ (ì´ë²¤íŠ¸ ìœ„ì„)
    $(document).on('click', '.btn-lock', function() {
        const id = $(this).data('id');
        const currentStatus = $(this).data('status');
        const targetStatus = (currentStatus == 350) ? 330 : 350;
        const msg = (targetStatus == 350) ? "ì ê¸ˆë³´ê´€" : "ì§„í–‰ì¤‘ìœ¼ë¡œ ë³€ê²½";

        if(confirm(`í•´ë‹¹ í”„ë¡œì íŠ¸ë¥¼ ${msg} í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            $.ajax({
                url: `/settings/api/projects/${id}/lock`,
                type: 'PATCH',
                data: { status: targetStatus },
                success: performSearch
            });
        }
    });

    // í”„ë¡œì íŠ¸ ì‚­ì œ
    $(document).on('click', '.btn-delete', function() {
        const id = $(this).data('id');
        if(confirm(`${id}ë²ˆ í”„ë¡œì íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            $.ajax({
                url: `/settings/api/projects/${id}`,
                type: 'DELETE',
                success: function() { alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."); performSearch(); },
                error: () => alert("ì‚­ì œ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")
            });
        }
    });


    // =============================
    // 2ï¸âƒ£ ìœ ì € ê´€ë¦¬ ì˜ì—­
    // =============================

    $('#btnUserSearch').on('click', performUserSearch);
    $('#userKeyword').on('keypress', (e) => { 
        if(e.which == 13) { e.preventDefault(); performUserSearch(); } 
    });

    function loadUserStatusOptions() {
        $.get('/settings/api/common/user-status-count', function(list){
            const $select = $('#userStatusSelect');
            const currentVal = $select.val(); 
            $select.empty().append('<option value="">ì „ì²´ ìƒíƒœ</option>');
            list.forEach(s => {
                $select.append(`<option value="${s.commonNo}" ${currentVal == s.commonNo ? 'selected' : ''}>${s.commonName} (${s.userCount})</option>`);
            });
        });
    }

    function performUserSearch() {
        const status = $('#userStatusSelect').val();
        const keyword = $('#userKeyword').val();
        $.get('/settings/api/users/search', { status, keyword }, renderUserTable);
    }

    function renderUserTable(users) {
        const $tbody = $('#userTableBody').empty();
        if (!users || !users.length) {
            $tbody.append('<tr><td colspan="7" class="py-4">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>'); // colspan 6 -> 7ë¡œ ë³€ê²½
            return;
        }

        users.forEach(u => {
            let formattedDate = u.createTime ? new Date(u.createTime).toLocaleDateString('ko-KR') : "-";
            let roleColor = u.admin === 1 ? 'bg-danger' : 'bg-info';
            let roleName  = u.admin === 1 ? 'ê´€ë¦¬ì' : 'ì¼ë°˜';

            // ğŸ“ ìƒíƒœë³„ ì„¤ì • (110: ì‚¬ìš©ì¤‘, 120: ë“±ë¡ëŒ€ê¸°, 130: ì ê¸ˆ, 190: í‡´ì‚¬)
            let statusText = '';
            let statusColor = '';
            switch(u.status) {
                case 110: statusText = 'ì‚¬ìš©ì¤‘'; statusColor = 'bg-success'; break;
                case 120: statusText = 'ë“±ë¡ëŒ€ê¸°'; statusColor = 'bg-info'; break;
                case 130: statusText = 'ì ê¸ˆ'; statusColor = 'bg-warning'; break;
                case 190: statusText = 'í‡´ì‚¬'; statusColor = 'bg-secondary'; break;
                default: statusText = 'ì•Œìˆ˜ì—†ìŒ'; statusColor = 'bg-dark';
            }

            const isPending = (u.status === 120);
            const isLocked  = (u.status === 130);
            const isRetired = (u.status === 190);

            let actionBtnHtml = '';
            if (isPending) {
                actionBtnHtml = `<button class="btn btn-sm btn-outline-primary btn-user-activate" data-id="${u.userId}">í™œì„±í™”</button>`;
            } else {
                const lockBtnClass = isLocked ? 'btn-outline-success' : 'btn-outline-warning';
                const lockBtnText  = isLocked ? 'ì ê¸ˆí•´ì œ' : 'ì ê¸ˆ';
                actionBtnHtml = `<button class="btn btn-sm ${lockBtnClass} btn-user-status" data-id="${u.userId}" data-status="${isLocked ? 110 : 130}" ${isRetired ? 'disabled' : ''}>${lockBtnText}</button>`;
            }

            $tbody.append(`
                <tr>
                    <td>${u.userId}</td>
                    <td class="text-start">${u.userName}</td>
                    <td><span class="badge ${statusColor}">${statusText}</span></td> <td><span class="badge ${roleColor}">${roleName}</span></td>
                    <td>${u.email || '-'}</td>
                    <td>${formattedDate}</td>
                    <td>
                        ${actionBtnHtml}
                        <button class="btn btn-sm ${isRetired ? 'btn-secondary' : 'btn-outline-danger'} btn-user-retire" data-id="${u.userId}" ${isRetired ? 'disabled' : ''}>
                            ${isRetired ? 'í‡´ì‚¬ì™„ë£Œ' : 'í‡´ì‚¬'}
                        </button>
                    </td>
                </tr>`);
        });
    }

    // ìœ ì € ìƒíƒœ ì—…ë°ì´íŠ¸ ê³µí†µ
    function updateUserStatus(userId, status, message) {
        $.ajax({
            url: '/settings/api/users/status',
            type: 'PATCH',
            contentType: 'application/json',
            data: JSON.stringify({ userId, status }),
            success: function(res) { if(res === "SUCCESS") { if(message) alert(message); performUserSearch(); loadUserStatusOptions(); } }
        });
    }

    $(document).on('click', '.btn-user-status', function() { updateUserStatus($(this).data('id'), $(this).data('status')); });
    $(document).on('click', '.btn-user-activate', function() { if(confirm("í™œì„±í™” í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) updateUserStatus($(this).data('id'), 110, "í™œì„±í™” ì™„ë£Œ"); });
    $(document).on('click', '.btn-user-retire', function() { if(confirm("í‡´ì‚¬ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) updateUserStatus($(this).data('id'), 190, "í‡´ì‚¬ ì™„ë£Œ"); });


    // =============================
    // 3ï¸âƒ£ ê·¸ë£¹ ê´€ë¦¬ ì˜ì—­
    // =============================

    $('#btnGroupSearch').on('click', performGroupSearch);
    $('#groupKeyword').on('keypress', (e) => { 
        if(e.which == 13) { e.preventDefault(); performGroupSearch(); } 
    });

    function loadGroups() {
        $.get('/settings/api/groups', renderGroupTable);
    }

    function performGroupSearch() {
        const keyword = $('#groupKeyword').val();
        $.get('/settings/api/groups/search', { keyword }, renderGroupTable);
    }

    function renderGroupTable(groups) {
        const $tbody = $('#groupTableBody').empty();
        if (!groups || !groups.length) {
            $tbody.append('<tr><td colspan="4" class="py-4">ë“±ë¡ëœ ê·¸ë£¹ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>');
            return;
        }

        groups.forEach(g => {
            const isActive = (g.status === 510);
            const statusBadge = isActive ? 'bg-success' : 'bg-warning';
            const btnClass = isActive ? 'btn-outline-warning' : 'btn-outline-success';
            const btnIcon = isActive ? 'cil-lock-locked' : 'cil-lock-unlocked';
            const btnText = isActive ? 'ë¹„í™œì„±í™”' : 'í™œì„±í™”';

            $tbody.append(`
                <tr>
                    <td>${g.groupNo}</td>
                    <td class="text-start">${g.groupName}</td>
                    <td><span class="badge ${statusBadge}">${g.statusName}</span></td>
                    <td>
                        <button class="btn btn-sm ${btnClass} btn-group-toggle" data-id="${g.groupNo}" data-status="${g.status}">
                            <i class="${btnIcon}"></i> ${btnText}
                        </button>
                    </td>
                </tr>`);
        });
    }
 //  ê·¸ë£¹ í–‰ ì¶”ê°€ ë²„íŠ¼
    $('#btnGroupAdd').on('click', function() {
        if ($('#groupNewInput').length > 0) {
            $('#groupNewInput').focus();
            return;
        }

        const newRow = `
            <tr class="table-info" id="rowGroupNew">
                <td>#</td>
                <td>
                    <input type="text" id="groupNewInput" class="form-control form-control-sm" placeholder="ê·¸ë£¹ëª… ì…ë ¥">
                </td>
                <td><span class="badge bg-warning">ë¹„í™œì„±</span></td> <td>
                    <button class="btn btn-sm btn-primary btn-group-save">ì €ì¥</button>
                    <button class="btn btn-sm btn-secondary btn-group-cancel">ì·¨ì†Œ</button>
                </td>
            </tr>`;
        
        $('#groupTableBody').prepend(newRow);
        $('#groupNewInput').focus();
    });

    //  ì—”í„° í‚¤ ì €ì¥ & ESC ì·¨ì†Œ
    $(document).on('keydown', '#groupNewInput', function(e) {
        if (e.key === 'Enter') { e.preventDefault(); $('.btn-group-save').click(); }
        if (e.key === 'Escape') { $('.btn-group-cancel').click(); }
    });

    //  ì·¨ì†Œ
    $(document).on('click', '.btn-group-cancel', function() {
        $('#rowGroupNew').remove();
    });

    // ì €ì¥ (POST)
    $(document).on('click', '.btn-group-save', function() {
        const groupName = $('#groupNewInput').val().trim();

        if (!groupName) {
            alert("ê·¸ë£¹ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            $('#groupNewInput').focus();
            return;
        }

        $.ajax({
            url: '/settings/api/groups',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ 
                groupName: groupName,
                status: 520 // ğŸ“ ì´ˆê¸° ìƒíƒœê°’ (DB ê³µí†µì½”ë“œì— ë§ì¶° ìˆ˜ì •í•˜ì„¸ìš”)
            }),
            success: function() {
                alert("ìƒˆë¡œìš´ ê·¸ë£¹ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.");
                loadGroups(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            },
            error: function() {
                alert("ê·¸ë£¹ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        });
    });

    // ê·¸ë£¹ í† ê¸€ ì´ë²¤íŠ¸
    $(document).on('click', '.btn-group-toggle', function(){
        const id = $(this).data('id');
        const msg = ($(this).data('status') === 510) ? "ë¹„í™œì„±í™”" : "í™œì„±í™”";
        if(confirm(`í•´ë‹¹ ê·¸ë£¹ì„ ${msg} ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            $.ajax({
                url: `/settings/api/groups/${id}/toggle-status`,
                type: 'PATCH',
                success: loadGroups
            });
        }
    });
});
//=============================
//4ï¸âƒ£ ê¶Œí•œ(Roles) ê´€ë¦¬ ì˜ì—­
//=============================

//ì´ˆê¸° ë¡œë”©ì— ì¶”ê°€
loadRoles();

//ê²€ìƒ‰ ì´ë²¤íŠ¸
$('#btnRoleSearch').on('click', performRoleSearch);
$('#roleKeyword').on('keypress', (e) => { 
 if(e.which == 13) { e.preventDefault(); performRoleSearch(); } 
});

function loadRoles() {
 $.get('/settings/api/roles', renderRoleTable);
}

function performRoleSearch() {
 const keyword = $('#roleKeyword').val();
 $.get('/settings/api/roles/search', { keyword }, renderRoleTable);
}

function renderRoleTable(roles) {
 const $tbody = $('#roleTableBody').empty();
 if (!roles || !roles.length) {
     $tbody.append('<tr><td colspan="2" class="py-4">ë“±ë¡ëœ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>');
     return;
 }

 roles.forEach(r => {
     $tbody.append(`
         <tr>
             <td><strong>${r.roleNo}</strong></td>
             <td class="text-start">${r.roleName}</td>
         </tr>`);
 });
}

//ğŸ”¹ ê¶Œí•œ í…Œì´ë¸” ë Œë”ë§ (ë²ˆí˜¸ ì œê±°, ì‚­ì œ ë²„íŠ¼ ì¶”ê°€)
function renderRoleTable(roles) {
    const $tbody = $('#roleTableBody').empty();
    if (!roles || !roles.length) {
        $tbody.append('<tr><td colspan="2" class="py-4">ë“±ë¡ëœ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>');
        return;
    }

    roles.forEach(r => {
        $tbody.append(`
            <tr>
                <td class="text-start ps-4">${r.roleName}</td>
                <td>
                    <button class="btn btn-sm btn-outline-danger btn-role-delete" 
                            data-id="${r.roleNo}" 
                            data-name="${r.roleName}">
                        ì‚­ì œ
                    </button>
                </td>
            </tr>`);
    });
}

// ğŸ”¹ ê¶Œí•œ ì‚­ì œ ì´ë²¤íŠ¸ (ì´ë²¤íŠ¸ ìœ„ì„)
$(document).on('click', '.btn-role-delete', function() {
    const roleNo = $(this).data('id');
    const roleName = $(this).data('name');

    if(confirm(`[${roleName}] ê¶Œí•œì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ê¶Œí•œì„ ê°€ì§„ ì‚¬ìš©ìë“¤ì—ê²Œ ì˜í–¥ì´ ê°ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`)) {
        $.ajax({
            url: `/settings/api/roles/${roleNo}`,
            type: 'DELETE',
            success: function() {
                alert("ê¶Œí•œì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                loadRoles(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            },
            error: function() {
                alert("ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í•´ë‹¹ ê¶Œí•œì„ ì‚¬ìš© ì¤‘ì¸ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.");
            }
        });
    }
});
// ì—­í•  í–‰ ì¶”ê°€ ë²„íŠ¼
$('#btnRoleAdd').on('click', function() {
    if ($('#roleNewInput').length > 0) {
        $('#roleNewInput').focus();
        return;
    }

    const newRow = `
        <tr class="table-info" id="rowRoleNew">
            <td>
                <input type="text" id="roleNewInput" class="form-control form-control-sm" placeholder="ì—­í• ëª… ì…ë ¥ (ì˜ˆ: ê°œë°œì)">
            </td>
            <td>
                <button class="btn btn-sm btn-primary btn-role-save">ì €ì¥</button>
                <button class="btn btn-sm btn-secondary btn-role-cancel">ì·¨ì†Œ</button>
            </td>
        </tr>`;
    
    $('#roleTableBody').prepend(newRow);
    $('#roleNewInput').focus();
});

//í–‰ ì¶”ê°€ ì‹œ ì—”í„° ì´ë²¤íŠ¸ ë°”ì¸ë”© ì¶”ê°€
$(document).on('keydown', '#roleNewInput', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ë°©ì§€
        $('.btn-role-save').click(); // ì €ì¥ ë²„íŠ¼ í´ë¦­ íŠ¸ë¦¬ê±°
    }
    if (e.key === 'Escape') {
        $('.btn-role-cancel').click(); // ESC ëˆ„ë¥´ë©´ ì·¨ì†Œ
    }
});

//  ì·¨ì†Œ
$(document).on('click', '.btn-role-cancel', function() {
    $('#rowRoleNew').remove();
});

//  ì €ì¥ (POST)
$(document).on('click', '.btn-role-save', function() {
    const roleName = $('#roleNewInput').val().trim();

    if (!roleName) {
        alert("ì—­í• ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        $('#roleNewInput').focus();
        return;
    }

    $.ajax({
        url: '/settings/api/roles',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ roleName: roleName }),
        success: function() {
            alert("ìƒˆë¡œìš´ ì—­í• ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
            loadRoles(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        },
        error: function() {
            alert("ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
    });
});
//=============================
// 5 ì¼ê° ìƒíƒœ ê´€ë¦¬ ì˜ì—­
//=============================
// ğŸ”¹ ì´ˆê¸° ë¡œë“œ í˜¸ì¶œ
loadJobStatus();

// ê²€ìƒ‰ ì´ë²¤íŠ¸
$('#btnJobStatusSearch').on('click', performJobStatusSearch);
$('#jobStatusKeyword').on('keypress', (e) => { if(e.which == 13) performJobStatusSearch(); });

function loadJobStatus() {
    $.get('/settings/api/job-status', renderJobStatusTable);
}

function performJobStatusSearch() {
    const keyword = $('#jobStatusKeyword').val();
    $.get('/settings/api/job-status/search', { keyword }, renderJobStatusTable);
}

function renderJobStatusTable(list) {
    const $tbody = $('#jobStatusTableBody').empty();
    if (!list.length) {
        $tbody.append('<tr><td colspan="2" class="py-4">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>');
        return;
    }
    list.forEach(item => {
        $tbody.append(`
            <tr>
                <td class="text-start ps-4">${item.jobStatus}</td>
                <td>
                    <button class="btn btn-sm btn-outline-danger btn-job-status-delete" data-id="${item.jobStatusNo}" data-name="${item.jobStatus}">ì‚­ì œ</button>
                </td>
            </tr>`);
    });
}
//ğŸ“ ìƒì„± ë²„íŠ¼ í´ë¦­ ì‹œ ë¹ˆ í–‰ ì¶”ê°€
$('#btnJobStatusAdd').on('click', function() {
    // ì´ë¯¸ ì…ë ¥ ì¤‘ì¸ í–‰ì´ ìˆë‹¤ë©´ ì¤‘ë³µ ì¶”ê°€ ë°©ì§€
    if ($('#jobStatusNewInput').length > 0) {
        $('#jobStatusNewInput').focus();
        return;
    }

    const newRow = `
        <tr class="table-info" id="rowJobStatusNew">
            <td>
                <input type="text" id="jobStatusNewInput" class="form-control form-control-sm" placeholder="ìƒíƒœëª… ì…ë ¥ (ì˜ˆ: ì§„í–‰ì¤‘)">
            </td>
            <td>
                <button class="btn btn-sm btn-primary btn-job-status-save">ì €ì¥</button>
                <button class="btn btn-sm btn-secondary btn-job-status-cancel">ì·¨ì†Œ</button>
            </td>
        </tr>`;
    
    $('#jobStatusTableBody').prepend(newRow);
    $('#jobStatusNewInput').focus();
});
//í–‰ ì¶”ê°€ ì‹œ ì—”í„° ì´ë²¤íŠ¸ ë°”ì¸ë”© ì¶”ê°€
$(document).on('keydown', '#jobStatusNewInput', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ë°©ì§€
        $('.btn-job-status-save').click(); // ì €ì¥ ë²„íŠ¼ í´ë¦­ íŠ¸ë¦¬ê±°
    }
    if (e.key === 'Escape') {
        $('.btn-job-status-cancel').click(); // ESC ëˆ„ë¥´ë©´ ì·¨ì†Œ
    }
});
// ğŸ“ ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì‹œ í–‰ ì œê±°
$(document).on('click', '.btn-job-status-cancel', function() {
    $('#rowJobStatusNew').remove();
});

// ğŸ“ ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ Ajax ì¸ì„œíŠ¸ (POST)
$(document).on('click', '.btn-job-status-save', function() {
    const jobStatusName = $('#jobStatusNewInput').val().trim();

    if (!jobStatusName) {
        alert("ìƒíƒœëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        $('#jobStatusNewInput').focus();
        return;
    }

    $.ajax({
        url: '/settings/api/job-status',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ jobStatus: jobStatusName }), // VOì˜ í•„ë“œëª… 'jobStatus'ì™€ ì¼ì¹˜í•´ì•¼ í•¨
        success: function(res) {
            alert("ìƒˆë¡œìš´ ìƒíƒœê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
            loadJobStatus(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        },
        error: function(xhr) {
            alert("ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ì‚¬ìœ : " + xhr.responseText + ")");
        }
    });
});

// ì‚­ì œ ì´ë²¤íŠ¸
$(document).on('click', '.btn-job-status-delete', function() {
    const no = $(this).data('id');
    const name = $(this).data('name');
    if(confirm(`[${name}] ìƒíƒœë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        $.ajax({
            url: `/settings/api/job-status/${no}`,
            type: 'DELETE',
            success: loadJobStatus
        });
    }
});
//=============================
// 6 ì¼ê° ìœ í˜• ê´€ë¦¬ ì˜ì—­
//=============================
//ğŸ”¹ ì´ˆê¸° ë¡œë“œ
loadJobTypes();

// ê²€ìƒ‰ ì´ë²¤íŠ¸
$('#btnJobTypeSearch').on('click', performJobTypeSearch);
$('#jobTypeKeyword').on('keypress', (e) => { if(e.which == 13) performJobTypeSearch(); });

function loadJobTypes() {
    $.get('/settings/api/job-types', renderJobTypeTable);
}

function performJobTypeSearch() {
    const keyword = $('#jobTypeKeyword').val();
    $.get('/settings/api/job-types/search', { keyword }, renderJobTypeTable);
}

function renderJobTypeTable(list) {
    const $tbody = $('#jobTypeTableBody').empty();
    if (!list.length) {
        $tbody.append('<tr><td colspan="2" class="py-4">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>');
        return;
    }
    list.forEach(item => {
        $tbody.append(`
            <tr>
                <td class="text-start ps-4">${item.jobType}</td>
                <td>
                    <button class="btn btn-sm btn-outline-danger btn-job-type-delete" data-id="${item.jobTypeNo}" data-name="${item.jobType}">ì‚­ì œ</button>
                </td>
            </tr>`);
    });
}
// ì‚­ì œ ì´ë²¤íŠ¸
$(document).on('click', '.btn-job-type-delete', function() {
    const no = $(this).data('id');
    const name = $(this).data('name');
    if(confirm(`[${name}] ìœ í˜•ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        $.ajax({
            url: `/settings/api/job-types/${no}`,
            type: 'DELETE',
            success: loadJobTypes
        });
    }
});
// ìƒì„± ë²„íŠ¼ í´ë¦­ ì‹œ ë¹ˆ í–‰ ì¶”ê°€
$('#btnJobTypeAdd').on('click', function() {
    // ì´ë¯¸ ì…ë ¥ ì¤‘ì¸ í–‰ì´ ìˆë‹¤ë©´ ì¤‘ë³µ ì¶”ê°€ ë°©ì§€
    if ($('#jobTypeNewInput').length > 0) {
        $('#jobTypeNewInput').focus();
        return;
    }

    const newRow = `
        <tr class="table-info" id="rowJobTypeNew">
            <td>
                <input type="text" id="jobTypeNewInput" class="form-control form-control-sm" placeholder="ìœ í˜•ëª… ì…ë ¥">
            </td>
            <td>
                <button class="btn btn-sm btn-primary btn-job-type-save">ì €ì¥</button>
                <button class="btn btn-sm btn-secondary btn-job-type-cancel">ì·¨ì†Œ</button>
            </td>
        </tr>`;
    
    // í…Œì´ë¸” ìµœìƒë‹¨ì— ì¶”ê°€
    $('#jobTypeTableBody').prepend(newRow);
    $('#jobTypeNewInput').focus();
});

// í–‰ ì¶”ê°€ ì‹œ ì—”í„° ì´ë²¤íŠ¸ ë°”ì¸ë”© ì¶”ê°€
$(document).on('keydown', '#jobTypeNewInput', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ë°©ì§€
        $('.btn-job-type-save').click(); // ì €ì¥ ë²„íŠ¼ í´ë¦­ íŠ¸ë¦¬ê±°
    }
    if (e.key === 'Escape') {
        $('.btn-job-type-cancel').click(); // ESC ëˆ„ë¥´ë©´ ì·¨ì†Œ
    }
});

// ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì‹œ í–‰ ì œê±°
$(document).on('click', '.btn-job-type-cancel', function() {
    $('#rowJobTypeNew').remove();
});

// ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ Ajax ì¸ì„œíŠ¸
$(document).on('click', '.btn-job-type-save', function() {
    const jobType = $('#jobTypeNewInput').val().trim();

    if (!jobType) {
        alert("ìœ í˜•ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        $('#jobTypeNewInput').focus();
        return;
    }

    $.ajax({
        url: '/settings/api/job-types',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ jobType: jobType }),
        success: function() {
            alert("ìƒˆë¡œìš´ ìœ í˜•ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
            loadJobTypes(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        },
        error: function() {
            alert("ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
    });
});
</script>
</div>
</html>