<html layout:decorate="~{common/layouts/default_layout}">
<div layout:fragment="Content">
	<!-- í”„ë¡œì íŠ¸ ì•„ì½”ë””ì–¸ -->
	<div class="accordion" id="settingsAccordion">
		<div class="accordion-item">
			<h2 class="accordion-header">
				<button class="accordion-button" type="button"
					data-coreui-toggle="collapse" data-coreui-target="#collapseProject">
					í”„ë¡œì íŠ¸ ê´€ë¦¬</button>
			</h2>

			<div id="collapseProject" class="accordion-collapse collapse show"
				data-coreui-parent="#settingsAccordion">
				<div class="accordion-body">
					<div class="card mb-3">
						<div class="card-body">
							<form id="searchForm" class="row g-2">
								<div class="col-md-3">
									<select id="projectStatusSelect" name="status"
										class="form-select">
										<option value="">ì „ì²´ ìƒíƒœ</option>
										<th:block th:each="status : ${statusList}">
											<option th:value="${status.commonNo}"
												th:text="${status.commonName}"></option>
										</th:block>
									</select>
								</div>
								<div class="col-md-7">
									<input type="text" id="keyword" name="keyword"
										class="form-control" placeholder="í”„ë¡œì íŠ¸ëª… ê²€ìƒ‰">
								</div>
								<div class="col-md-2">
									<button type="button" id="btnSearch"
										class="btn btn-primary w-100">
										<i class="cil-search"></i> ê²€ìƒ‰
									</button>
								</div>
							</form>
						</div>
					</div>

					<div class="card">
						<div class="card-body p-0">
							<table
								class="table table-striped table-hover mb-0 text-center align-middle">
								<thead class="table-light">
									<tr>
										<th>ë²ˆí˜¸</th>
										<th>í”„ë¡œì íŠ¸ëª…</th>
										<th>ìƒíƒœ</th>
										<th>ê³µê°œ ì—¬ë¶€</th>
										<th>ë“±ë¡ì¼</th>
										<th>ê´€ë¦¬</th>
									</tr>
								</thead>
								<tbody id="projectTableBody">
									<tr th:each="p : ${projects}">
										<td th:text="${p.projectNo}"></td>
										<td class="text-start" th:text="${p.projectName}"></td>

										<td><span class="badge"
											th:classappend="${p.statusValue == 330 ? 'bg-success' : (p.statusValue == 350 ? 'bg-warning' : 'bg-info')}"
											th:text="${p.statusLabel}"></span></td>

										<td><span class="badge rounded-pill"
											th:classappend="${p.publicYn == 1 ? 'text-bg-light border' : 'text-bg-dark'}"
											th:text="${p.publicYnLabel}"></span></td>

										<td
											th:text="${p.createAt != null ? #temporals.format(p.createAt, 'yyyy/MM/dd') : '-'}"></td>

										<td>
											<button type="button" class="btn btn-sm btn-lock"
												th:classappend="${p.statusValue == 350 ? 'btn-outline-success' : 'btn-outline-warning'}"
												th:data-id="${p.projectNo}"
												th:data-status="${p.statusValue}">
												<i
													th:class="${p.statusValue == 350 ? 'cil-lock-locked' : 'cil-lock-unlocked'}"></i>
												<span th:text="${p.statusValue == 350 ? 'ì ê¸ˆí•´ì œ' : 'ì ê¸ˆ'}"></span>
											</button>

											<button class="btn btn-sm btn-outline-danger btn-delete"
												th:data-id="${p.projectNo}">ì‚­ì œ</button>
										</td>
									</tr>
									<tr th:if="${#lists.isEmpty(projects)}">
										<td colspan="6" class="py-4">ë“±ë¡ëœ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- ì‚¬ìš©ì ì•„ì½”ë””ì–¸ -->
		<div class="accordion-item">
			<h2 class="accordion-header">
				<button class="accordion-button collapsed" type="button"
					data-coreui-toggle="collapse" data-coreui-target="#collapseUser">
					ì‚¬ìš©ì ê´€ë¦¬</button>
			</h2>

			<div id="collapseUser" class="accordion-collapse collapse"
				data-coreui-parent="#settingsAccordion">
				<div class="accordion-body">
					<div class="card mb-3">
						<div class="card-body">
							<form id="userSearchForm" class="row g-2">
								<div class="col-md-3">
									<select id="userStatusSelect" name="status" class="form-select">
										<option value="">ì „ì²´ ìƒíƒœ</option>
									</select>
								</div>
								<div class="col-md-7">
									<input type="text" id="userKeyword" name="keyword"
										class="form-control" placeholder="ì´ë¦„ ê²€ìƒ‰">
								</div>
								<div class="col-md-2">
									<button type="button" id="btnUserSearch"
										class="btn btn-primary w-100">
										<i class="cil-search"></i> ê²€ìƒ‰
									</button>
								</div>
							</form>
						</div>
					</div>

					<div class="card">
						<div class="card-body p-0">
							<table
								class="table table-striped table-hover mb-0 text-center align-middle">
								<thead class="table-light">
									<tr>
										<th>ì•„ì´ë””</th>
										<th>ì´ë¦„</th>
										<th>ê¶Œí•œ</th>
										<th>ì´ë©”ì¼</th>
										<th>ê°€ì…ì¼</th>
										<th>ê´€ë¦¬</th>
									</tr>
								</thead>
								<tbody id="userTableBody">
									<tr th:each="u : ${users}">
										<td th:text="${u.userId}"></td>
										<td class="text-start" th:text="${u.userName}"></td>
										<td><span class="badge"
											th:classappend="${u.admin == 1 ? 'bg-danger' : 'bg-info'}"
											th:text="${u.admin == 1 ? 'ê´€ë¦¬ì' : 'ì¼ë°˜'}"></span></td>
										<td th:text="${u.email}"></td>
										<td th:text="${#temporals.format(u.createTime, 'yyyy/MM/dd')}"></td>
										<td>
											<button class="btn btn-sm btn-outline-primary"
												th:onclick="|alert('ì•„ì´ë””: ${u.userId}')|">ìƒì„¸</button>
											<button class="btn btn-sm btn-outline-danger btn-user-delete"
												th:data-id="${u.userId}">ì‚­ì œ</button>
										</td>
									</tr>
									<tr th:if="${#lists.isEmpty(users)}">
										<td colspan="6" class="py-4 text-muted">ë“±ë¡ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- ê·¸ë£¹ ì•„ì½”ë””ì–¸ -->
		<div class="accordion-item">
			<h2 class="accordion-header">
				<button class="accordion-button collapsed" type="button"
					data-coreui-toggle="collapse" data-coreui-target="#collapseGroup">
					ê·¸ë£¹ ê´€ë¦¬</button>
			</h2>

			<div id="collapseGroup" class="accordion-collapse collapse"
				data-coreui-parent="#settingsAccordion">

				<div class="accordion-body">

					<!-- ê²€ìƒ‰ ì˜ì—­ (ì„ íƒì‚¬í•­) -->
					<div class="card mb-3">
						<div class="card-body">
							<form id="groupSearchForm" class="row g-2">
								<div class="col-md-10">
									<input type="text" id="groupKeyword" class="form-control"
										placeholder="ê·¸ë£¹ëª… ê²€ìƒ‰">
								</div>
								<div class="col-md-2">
									<button type="button" id="btnGroupSearch"
										class="btn btn-primary w-100">ê²€ìƒ‰</button>
								</div>
							</form>
						</div>
					</div>

					<!-- ê·¸ë£¹ í…Œì´ë¸” -->
					<div class="card">
						<div class="card-body p-0">

							<table
								class="table table-striped table-hover mb-0 text-center align-middle">
								<thead class="table-light">
									<tr>
										<th>ë²ˆí˜¸</th>
										<th>ê·¸ë£¹ëª…</th>
										<th>ê´€ë¦¬</th>
									</tr>
								</thead>

								<tbody id="groupTableBody">
									<!-- AJAX ë Œë”ë§ -->
								</tbody>

							</table>

						</div>
					</div>

				</div>
			</div>
		</div>
	</div>

	<script>
	// =============================
	// í”„ë¡œì íŠ¸ ì´ë²¤íŠ¸ ì˜ì—­
	// =============================
	$(document).ready(function () {

	    // ğŸ”¹ í”„ë¡œì íŠ¸ ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì‹œ ê²€ìƒ‰ ì‹¤í–‰
	    $('#btnSearch').on('click', performSearch);

	    // ğŸ”¹ ê²€ìƒ‰ inputì—ì„œ Enter ëˆ„ë¥´ë©´ ê²€ìƒ‰ ì‹¤í–‰
	    $('#keyword').on('keypress', (e) => { 
	        if(e.which == 13) { 
	            e.preventDefault(); 
	            performSearch(); 
	        } 
	    });

	    // ğŸ”¹ í”„ë¡œì íŠ¸ ê²€ìƒ‰ AJAX í•¨ìˆ˜
	    function performSearch() {
	        const status = $('#projectStatusSelect').val();   // ì„ íƒëœ ìƒíƒœê°’
	        const keyword = $('#keyword').val();              // ê²€ìƒ‰ í‚¤ì›Œë“œ

	        $.ajax({
	            url: '/settings/api/projects/search',         // í”„ë¡œì íŠ¸ ê²€ìƒ‰ API
	            type: 'GET',
	            data: { status, keyword },                   // íŒŒë¼ë¯¸í„° ì „ë‹¬
	            success: renderProjectTable                  // ì„±ê³µ ì‹œ í…Œì´ë¸” ë Œë”ë§
	        });
	    }

	    function renderProjectTable(projects) {
	        const $tbody = $('#projectTableBody').empty();
	        if (!projects || projects.length === 0) {
	            $tbody.append('<tr><td colspan="6" class="py-4">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>');
	            return;
	        }

	        projects.forEach(p => {
	            // ë‚ ì§œ í˜•ì‹ì„ íƒ€ì„ë¦¬í”„(yyyy/MM/dd)ì™€ ë™ì¼í•˜ê²Œ êµì •
	            let formattedDate = "-";
	            if(p.createAt) {
	                const date = new Date(p.createAt);
	                const y = date.getFullYear();
	                const m = String(date.getMonth() + 1).padStart(2, '0');
	                const d = String(date.getDate()).padStart(2, '0');
	                formattedDate = `${y}/${m}/${d}`;
	            }
	            
	            let statusColor = p.statusValue == 330 ? 'bg-success' : (p.statusValue == 350 ? 'bg-warning' : 'bg-info');
	            const isLocked = (p.statusValue == 350); 
	            const lockBtnClass = isLocked ? 'btn-outline-success' : 'btn-outline-warning';
	            const lockIcon = isLocked ? 'cil-lock-locked' : 'cil-lock-unlocked';
	            const lockText = isLocked ? 'ì ê¸ˆí•´ì œ' : 'ì ê¸ˆ';

	            const row = `
	                <tr>
	                    <td>${p.projectNo}</td>
	                    <td class="text-start">${p.projectName}</td>
	                    <td><span class="badge ${statusColor}">${p.statusLabel}</span></td>
	                    <td><span class="badge rounded-pill ${p.publicYn === 1 ? 'text-bg-light border' : 'text-bg-dark'}">${p.publicYnLabel}</span></td>
	                    <td>${formattedDate}</td>
	                    <td>
	                        <button class="btn btn-sm btn-lock ${lockBtnClass}" 
	                                data-id="${p.projectNo}" 
	                                data-status="${p.statusValue}">
	                            <i class="${lockIcon}"></i> ${lockText}
	                        </button>
	                        <button class="btn btn-sm btn-outline-danger btn-delete" data-id="${p.projectNo}">ì‚­ì œ</button>
	                    </td>
	                </tr>`;
	            $tbody.append(row);
	        });
	    }

	    // ğŸ”¹ ì ê¸ˆ/í•´ì œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
	    $(document).on('click', '.btn-lock', function() {
	        const id = $(this).data('id');
	        const currentStatus = $(this).data('status');
	        const targetStatus = (currentStatus == 350) ? 330 : 350;
	        const msg = (targetStatus == 350) ? "ì ê¸ˆë³´ê´€" : "ì§„í–‰ì¤‘ìœ¼ë¡œ ë³€ê²½";

	        if(confirm(`í•´ë‹¹ í”„ë¡œì íŠ¸ë¥¼ ${msg} í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
	            $.ajax({
	                url: `/settings/api/projects/${id}/lock`,
	                type: 'PATCH',
	                data: { status: targetStatus },
	                success: function() {
	                    performSearch(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
	                }
	            });
	        }
	    });

	    // ğŸ”¹ í”„ë¡œì íŠ¸ ì‚­ì œ ì´ë²¤íŠ¸ (ë™ì  ë²„íŠ¼ ëŒ€ì‘ ìœ„í•´ ìœ„ì„ ë°©ì‹)
	    $(document).on('click', '.btn-delete', function() {

	        const id = $(this).data('id');   // í”„ë¡œì íŠ¸ ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°

	        // ì‚­ì œ í™•ì¸
	        if(confirm(`${id}ë²ˆ í”„ë¡œì íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {

	            $.ajax({
	                url: `/settings/api/projects/${id}`,  // ì‚­ì œ API
	                type: 'DELETE',

	                success: function() {
	                    alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
	                    performSearch(); // ì‚­ì œ í›„ ì¬ì¡°íšŒ
	                },

	                error: () => alert("ì‚­ì œ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")
	            });
	        }
	    });

	});


	// =============================
	// ìœ ì € ì´ë²¤íŠ¸ ì˜ì—­
	// =============================

// ğŸ”¹ ìœ ì € ìƒíƒœ Select ì˜µì…˜ ë° ì¹´ìš´íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°
function loadUserStatusOptions() {
    $.get('/settings/api/common/user-status-count', function(list){
        const $select = $('#userStatusSelect');
        const currentVal = $select.val(); 
        
        $select.empty().append('<option value="">ì „ì²´ ìƒíƒœ</option>');
        list.forEach(s => {
            $select.append(`
                <option value="${s.commonNo}" ${currentVal == s.commonNo ? 'selected' : ''}>
                    ${s.commonName} (${s.userCount})
                </option>
            `);
        });
    });
}

// ğŸ”¹ ìœ ì € ê²€ìƒ‰ ì‹¤í–‰
function performUserSearch() {
    const status = $('#userStatusSelect').val();
    const keyword = $('#userKeyword').val();
    $.ajax({
        url: '/settings/api/users/search',
        type: 'GET',
        data: { status, keyword },
        success: renderUserTable
    });
}

// ğŸ”¹ ìƒíƒœ ë³€ê²½ ê³µí†µ ì²˜ë¦¬ (í™œì„±í™”, ì ê¸ˆ, í‡´ì‚¬)
function updateUserStatus(userId, status, message) {
    $.ajax({
        url: '/settings/api/users/status',
        type: 'PATCH',
        contentType: 'application/json',
        data: JSON.stringify({ userId, status }),
        success: function(response) {
            if(response === "SUCCESS") {
                if(message) alert(message);
                performUserSearch();      
                loadUserStatusOptions(); // ì¹´ìš´íŠ¸ ë™ê¸°í™”
            }
        },
        error: () => alert("ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")
    });
}

// ğŸ”¹ í…Œì´ë¸” ë Œë”ë§
function renderUserTable(users) {
    const $tbody = $('#userTableBody').empty();
    if (!users || !users.length) {
        $tbody.append('<tr><td colspan="6" class="py-4">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>');
        return;
    }

    users.forEach(u => {
        let formattedDate = u.createTime ? new Date(u.createTime).toLocaleDateString('ko-KR') : "-";
        let roleColor = u.admin === 1 ? 'bg-danger' : 'bg-info';
        let roleName  = u.admin === 1 ? 'ê´€ë¦¬ì' : 'ì¼ë°˜';

        const isPending = (u.status === 120);
        const isLocked  = (u.status === 130);
        const isRetired = (u.status === 190);

        let actionBtnHtml = '';
        if (isPending) {
            actionBtnHtml = `<button class="btn btn-sm btn-outline-primary btn-user-activate" data-id="${u.userId}">í™œì„±í™”</button>`;
        } else {
            const lockBtnClass = isLocked ? 'btn-outline-success' : 'btn-outline-warning';
            const lockBtnText  = isLocked ? 'ì ê¸ˆí•´ì œ' : 'ì ê¸ˆ';
            const lockTargetStatus = isLocked ? 110 : 130;
            actionBtnHtml = `<button class="btn btn-sm ${lockBtnClass} btn-user-status" data-id="${u.userId}" data-status="${lockTargetStatus}" ${isRetired ? 'disabled' : ''}>${lockBtnText}</button>`;
        }

        const row = `
            <tr>
                <td>${u.userId}</td>
                <td class="text-start">${u.userName}</td>
                <td><span class="badge ${roleColor}">${roleName}</span></td>
                <td>${u.email || '-'}</td>
                <td>${formattedDate}</td>
                <td>
                    ${actionBtnHtml}
                    <button class="btn btn-sm ${isRetired ? 'btn-secondary' : 'btn-outline-danger'} btn-user-retire" data-id="${u.userId}" ${isRetired ? 'disabled' : ''}>
                        ${isRetired ? 'í‡´ì‚¬ì™„ë£Œ' : 'í‡´ì‚¬'}
                    </button>
                </td>
            </tr>`;
        $tbody.append(row);
    });
}

// ğŸ”¹ [í†µí•©] ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë°”ì¸ë”©
$(document).ready(function() {
    // 1. ì´ˆê¸° ë°ì´í„° ë¡œë“œ
    loadUserStatusOptions(); 
    performUserSearch();     

    // 2. ê²€ìƒ‰ ì´ë²¤íŠ¸
    $('#btnUserSearch').on('click', performUserSearch);
    $('#userKeyword').on('keypress', (e) => { 
        if(e.which == 13) { e.preventDefault(); performUserSearch(); } 
    });

    // 3. ìƒíƒœ ë³€ê²½ ì´ë²¤íŠ¸ (ìœ„ì„)
    $(document).on('click', '.btn-user-status', function() {
        updateUserStatus($(this).data('id'), $(this).data('status'));
    });
    
    $(document).on('click', '.btn-user-activate', function() {
        const userId = $(this).data('id');
        if(confirm(`ì•„ì´ë”” [${userId}] ì‚¬ìš©ìë¥¼ í™œì„±í™” í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            updateUserStatus(userId, 110, "í™œì„±í™” ì™„ë£Œ");
        }
    });

    $(document).on('click', '.btn-user-retire', function() {
        const userId = $(this).data('id');
        if(confirm(`ì•„ì´ë”” [${userId}] ì‚¬ìš©ìë¥¼ í‡´ì‚¬ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            updateUserStatus(userId, 190, "í‡´ì‚¬ ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
    });
});

//=============================
//ê·¸ë£¹ ì´ë²¤íŠ¸ ì˜ì—­
//=============================
$(document).ready(function () {

    $('#btnSearch').on('click', performSearch);

    performSearch(); // â­ ìµœì´ˆ ì¡°íšŒ ì¶”ê°€
});
$(document).ready(function () {

    $('#groupSearchForm').on('submit', function(e){
        e.preventDefault();
        performGroupSearch();
    });

});
//ğŸ”¹ ê·¸ë£¹ ëª©ë¡ ì¡°íšŒ
function loadGroups() {
$.get('/settings/api/groups', function(list){
   renderGroupTable(list);
});
}

//ğŸ”¹ ê·¸ë£¹ ê²€ìƒ‰
function performGroupSearch() {
const keyword = $('#groupKeyword').val();

$.get('/settings/api/groups/search', { keyword }, function(list){
   renderGroupTable(list);
});
}

//ğŸ”¹ ê·¸ë£¹ í…Œì´ë¸” ë Œë”ë§
function renderGroupTable(groups) {
const $tbody = $('#groupTableBody').empty();

if (!groups || !groups.length) {
   $tbody.append('<tr><td colspan="3">ë°ì´í„° ì—†ìŒ</td></tr>');
   return;
}

groups.forEach(g => {
   const row = `
       <tr>
           <td>${g.groupNo}</td>
           <td class="text-start">${g.groupName}</td>
           <td>
               <button class="btn btn-sm btn-outline-danger btn-group-delete"
                       data-id="${g.groupNo}">
                   ì‚­ì œ
               </button>
           </td>
       </tr>
   `;
   $tbody.append(row);
});
}

//ğŸ”¹ ê·¸ë£¹ ì‚­ì œ
$(document).on('click', '.btn-group-delete', function(){
const id = $(this).data('id');

if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
   $.ajax({
       url: `/settings/api/groups/${id}`,
       type: 'DELETE',
       success: function(){
           loadGroups();
       }
   });
}
});

//ğŸ”¹ ê²€ìƒ‰ ë²„íŠ¼
$('#btnGroupSearch').on('click', performGroupSearch);

//ğŸ”¹ í˜ì´ì§€ ë¡œë“œì‹œ ê·¸ë£¹ ì¡°íšŒ
$(document).ready(function(){
loadGroups();
});
    </script>
</div>
</html>