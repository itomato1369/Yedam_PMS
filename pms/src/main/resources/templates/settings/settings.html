<!DOCTYPE html>
<html lang="ko" xmlns:th="https://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
	layout:decorate="~{common/layouts/default-layout}">

<body>
	<div layout:fragment="Content">
		<!-- í”„ë¡œì íŠ¸ ì•„ì½”ë””ì–¸ -->
		<div class="accordion" id="settingsAccordion">
			<div class="accordion-item">
				<h2 class="accordion-header">
					<button class="accordion-button" type="button"
						data-coreui-toggle="collapse"
						data-coreui-target="#collapseProject">í”„ë¡œì íŠ¸ ê´€ë¦¬</button>
				</h2>

				<div id="collapseProject" class="accordion-collapse collapse show"
					data-coreui-parent="#settingsAccordion">
					<div class="accordion-body">
						<div class="card mb-3">
							<div class="card-body">
								<form id="searchForm" class="row g-2">
									<div class="col-md-3">
										<select id="projectStatusSelect" name="status"
											class="form-select">
											<option value="">ì „ì²´ ìƒíƒœ</option>
											<th:block th:each="status : ${statusList}">
												<option th:value="${status.commonNo}"
													th:text="${status.commonName}"></option>
											</th:block>
										</select>
									</div>
									<div class="col-md-6">
										<input type="text" id="keyword" name="keyword"
											class="form-control" placeholder="í”„ë¡œì íŠ¸ëª… ê²€ìƒ‰">
									</div>
									<div class="col-md-3">
										<div class="d-flex gap-2">
											<button type="button" id="btnSearch"
												class="btn btn-primary w-100">
												<i class="cil-search"></i> ê²€ìƒ‰
											</button>
											<button type="button" id="btnProjectAdd"
												class="btn btn-success w-100 text-white">
												<i class="cil-plus"></i> ìƒì„±
											</button>
										</div>
									</div>
								</form>
							</div>
						</div>

						<div class="card">
							<div class="card-body p-0">
								<table
									class="table table-striped table-hover mb-0 text-center align-middle">
									<thead class="table-light">
										<tr>
											<!--<th>ë²ˆí˜¸</th>-->
											<th>ìƒíƒœ</th>
											<th>í”„ë¡œì íŠ¸ëª…</th>
											<th>ê³µê°œ ì—¬ë¶€</th>
											<th>ë“±ë¡ì¼</th>
											<th>ê´€ë¦¬</th>
										</tr>
									</thead>
									<tbody id="projectTableBody">
										<tr th:each="p : ${projects}">
											<td th:text="${p.projectNo}"></td>
											<td class="text-start" th:text="${p.projectName}"></td>

											<td><span class="badge"
												th:classappend="${p.statusValue == 330 ? 'bg-success' : (p.statusValue == 350 ? 'bg-warning' : 'bg-info')}"
												th:text="${p.statusLabel}"></span></td>

											<td><span class="badge rounded-pill"
												th:classappend="${p.publicYn == 1 ? 'text-bg-light border' : 'text-bg-dark'}"
												th:text="${p.publicYnLabel}"></span></td>

											<td
												th:text="${p.createAt != null ? #temporals.format(p.createAt, 'yyyy/MM/dd') : '-'}"></td>

											<td>
												<button type="button" class="btn btn-sm btn-lock"
													th:classappend="${p.statusValue == 350 ? 'btn-outline-success' : 'btn-outline-warning'}"
													th:data-id="${p.projectNo}"
													th:data-status="${p.statusValue}">
													<i
														th:class="${p.statusValue == 350 ? 'cil-lock-locked' : 'cil-lock-unlocked'}"></i>
													<span th:text="${p.statusValue == 350 ? 'ì ê¸ˆí•´ì œ' : 'ì ê¸ˆ'}"></span>
												</button>

												<button class="btn btn-sm btn-outline-danger btn-delete"
													th:data-id="${p.projectNo}">ì‚­ì œ</button>
											</td>
										</tr>
										<tr th:if="${#lists.isEmpty(projects)}">
											<td colspan="6" class="py-4">ë“±ë¡ëœ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
										</tr>
									</tbody>
								</table>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- ì‚¬ìš©ì ì•„ì½”ë””ì–¸ -->
			<div class="accordion-item">
				<h2 class="accordion-header">
					<button class="accordion-button collapsed" type="button"
						data-coreui-toggle="collapse" data-coreui-target="#collapseUser">
						ì‚¬ìš©ì ê´€ë¦¬</button>
				</h2>

				<div id="collapseUser" class="accordion-collapse collapse"
					data-coreui-parent="#settingsAccordion">
					<div class="accordion-body">
						<div class="card mb-3">
							<div class="card-body">
								<form id="userSearchForm" class="row g-2">
									<div class="col-md-3">
										<select id="userStatusSelect" name="status"
											class="form-select">
											<option value="">ì „ì²´ ìƒíƒœ</option>
										</select>
									</div>
									<div class="col-md-6">
										<input type="text" id="userKeyword" name="keyword"
											class="form-control" placeholder="ì´ë¦„ ê²€ìƒ‰">
									</div>
									<div class="col-md-3">
										<div class="d-flex gap-2">
											<button type="button" id="btnUserSearch"
												class="btn btn-primary w-100">
												<i class="cil-search"></i> ê²€ìƒ‰
											</button>
											<button type="button" id="btnUserAdd"
												class="btn btn-success w-100 text-white">
												<i class="cil-plus"></i> ë“±ë¡
											</button>
										</div>
									</div>
								</form>
							</div>
						</div>

						<div class="card">
							<div class="card-body p-0">
								<table
									class="table table-striped table-hover mb-0 text-center align-middle">
									<thead class="table-light">
										<tr>
											<th>ì•„ì´ë””</th>
											<th>ì´ë¦„</th>
											<th>ìƒíƒœ</th>
											<th>ê¶Œí•œ</th>
											<th>ì´ë©”ì¼</th>
											<th>ê°€ì…ì¼</th>
											<th>ê´€ë¦¬</th>
										</tr>
									</thead>
									<tbody id="userTableBody">
										<tr th:each="u : ${users}">
											<td th:text="${u.userId}"></td>
											<td class="text-start" th:text="${u.userName}"></td>

											<td><span class="badge"
												th:classappend="${u.status == 110 ? 'bg-success' : (u.status == 120 ? 'bg-info' : (u.status == 130 ? 'bg-warning' : 'bg-secondary'))}"
												th:text="${u.status == 110 ? 'ì‚¬ìš©ì¤‘' : (u.status == 120 ? 'ë“±ë¡ëŒ€ê¸°' : (u.status == 130 ? 'ì ê¸ˆ' : 'í‡´ì‚¬'))}">
											</span></td>

											<td><span class="badge"
												th:classappend="${u.admin == 1 ? 'bg-danger' : 'bg-info'}"
												th:text="${u.admin == 1 ? 'ê´€ë¦¬ì' : 'ì¼ë°˜'}"></span></td>
											<td th:text="${u.email}"></td>
											<td
												th:text="${#temporals.format(u.createTime, 'yyyy/MM/dd')}"></td>
										</tr>
									</tbody>
								</table>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- ê·¸ë£¹ ì•„ì½”ë””ì–¸ -->
			<div class="accordion-item">
				<h2 class="accordion-header">
					<button class="accordion-button collapsed" type="button"
						data-coreui-toggle="collapse" data-coreui-target="#collapseGroup">
						ê·¸ë£¹ ê´€ë¦¬</button>
				</h2>

				<div id="collapseGroup" class="accordion-collapse collapse"
					data-coreui-parent="#settingsAccordion">

					<div class="accordion-body">

						<!-- ê²€ìƒ‰ ì˜ì—­ (ì„ íƒì‚¬í•­) -->
						<div class="card mb-3">
							<div class="card-body">
								<form id="groupSearchForm" class="row g-2">
									<div class="col-md-9">
										<input type="text" id="groupKeyword" class="form-control"
											placeholder="ê·¸ë£¹ëª… ê²€ìƒ‰">
									</div>
									<div class="col-md-3">
										<div class="d-flex gap-2">
											<button type="button" id="btnGroupSearch"
												class="btn btn-primary w-100">ê²€ìƒ‰</button>
											<button type="button" id="btnGroupAdd"
												class="btn btn-success w-100 text-white">
												<i class="cil-plus"></i> ìƒì„±
											</button>
										</div>
									</div>
								</form>
							</div>
						</div>

						<!-- ê·¸ë£¹ í…Œì´ë¸” -->
						<div class="card">
							<div class="card-body p-0">
								<table
									class="table table-striped table-hover mb-0 text-center align-middle">
									<thead class="table-light">
										<tr>
											<!-- <th>ë²ˆí˜¸</th> -->
											<th>ìƒíƒœ</th>
											<th>ê·¸ë£¹ëª…</th>
											<th class="text-center">ì¸ì› ìˆ˜</th>
								
											<th>ê´€ë¦¬</th>
										</tr>
									</thead>
									<tbody id="groupTableBody">
									</tbody>
								</table>
							</div>
						</div>
					</div>
				</div>
			</div>

			<!-- ì—­í•  ì•„ì½”ë””ì–¸ -->
			<div class="accordion-item">
				<h2 class="accordion-header">
					<button class="accordion-button collapsed" type="button"
						data-coreui-toggle="collapse" data-coreui-target="#collapseRoles">
						í”„ë¡œì íŠ¸ ì—­í•  ê´€ë¦¬</button>
				</h2>
				<div id="collapseRoles" class="accordion-collapse collapse"
					data-coreui-parent="#settingsAccordion">
					<div class="accordion-body">
						<div class="card mb-3">
							<div class="card-body">
								<div class="row g-2">
									<div class="col-md-9">
										<input type="text" id="roleKeyword" class="form-control"
											placeholder="ì—­í• ëª… ê²€ìƒ‰">
									</div>
									<div class="col-md-3">
										<div class="d-flex gap-2">
											<button type="button" id="btnRoleSearch"
												class="btn btn-primary w-100">ê²€ìƒ‰</button>
											<button type="button" id="btnRoleAdd"
												class="btn btn-success w-100 text-white">
												<i class="cil-plus"></i> ì¶”ê°€
											</button>
										</div>
									</div>
								</div>
							</div>
						</div>
						<div class="card">
							<div class="card-body p-0">
								<table
									class="table table-striped table-hover mb-0 text-center align-middle">
									<thead class="table-light">
										<tr>
											<th>ì—­í• ëª…</th>
											<th>ê´€ë¦¬</th>
										</tr>
									</thead>
									<tbody id="roleTableBody">
									</tbody>
								</table>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- ì¼ê° ìƒíƒœ ì•„ì½”ë””ì–¸ -->
			<div class="accordion-item">
				<h2 class="accordion-header">
					<button class="accordion-button collapsed" type="button"
						data-coreui-toggle="collapse"
						data-coreui-target="#collapseJobStatus">ì¼ê° ìƒíƒœ ê´€ë¦¬</button>
				</h2>
				<div id="collapseJobStatus" class="accordion-collapse collapse"
					data-coreui-parent="#settingsAccordion">
					<div class="accordion-body">
						<div class="card mb-3">
							<div class="card-body">
								<div class="row g-2">
									<div class="col-md-9">
										<input type="text" id="jobStatusKeyword" class="form-control"
											placeholder="ìƒíƒœëª… ê²€ìƒ‰">
									</div>
									<div class="col-md-3">
										<div class="d-flex gap-2">
											<button type="button" id="btnJobStatusSearch"
												class="btn btn-primary w-100">ê²€ìƒ‰</button>
											<button type="button" id="btnJobStatusAdd"
												class="btn btn-success w-100 text-white">
												<i class="cil-plus"></i> ì¶”ê°€
											</button>
										</div>
									</div>
								</div>
							</div>
						</div>
						<div class="card">
							<div class="card-body p-0">
								<table
									class="table table-striped table-hover mb-0 text-center align-middle">
									<thead class="table-light">
										<tr>
											<th>ì¼ê° ìƒíƒœëª…</th>
											<th>ê´€ë¦¬</th>
										</tr>
									</thead>
									<tbody id="jobStatusTableBody"></tbody>
								</table>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- ì¼ê° ìœ í˜• ì•„ì½”ë””ì–¸ -->
			<div class="accordion-item">
				<h2 class="accordion-header">
					<button class="accordion-button collapsed" type="button"
						data-coreui-toggle="collapse"
						data-coreui-target="#collapseJobType">ì¼ê° ìœ í˜• ê´€ë¦¬</button>
				</h2>
				<div id="collapseJobType" class="accordion-collapse collapse"
					data-coreui-parent="#settingsAccordion">
					<div class="accordion-body">
						<div class="card mb-3">
							<div class="card-body">
								<div class="row g-2">
									<div class="col-md-9">
										<input type="text" id="jobTypeKeyword" class="form-control"
											placeholder="ìœ í˜•ëª… ê²€ìƒ‰">
									</div>
									<div class="col-md-3">
										<div class="d-flex gap-2">
											<button type="button" id="btnJobTypeSearch"
												class="btn btn-primary w-100">ê²€ìƒ‰</button>
											<button type="button" id="btnJobTypeAdd"
												class="btn btn-success w-100 text-white">
												<i class="cil-plus"></i> ì¶”ê°€
											</button>
										</div>
									</div>
								</div>
							</div>
						</div>
						<div class="card">
							<div class="card-body p-0">
								<table
									class="table table-striped table-hover mb-0 text-center align-middle">
									<thead class="table-light">
										<tr>
											<th>ì¼ê° ìœ í˜•ëª…</th>
											<th>ê´€ë¦¬</th>
										</tr>
									</thead>
									<tbody id="jobTypeTableBody"></tbody>
								</table>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
<script>
$(document).ready(function () {
	// ğŸ“ 1. ì „ì—­ Map ì¶”ê°€ (ì ê¸ˆ ì „ ì›ë˜ ìƒíƒœë¥¼ ê¸°ì–µí•¨)
    const projectOriginMap = {};
    // 1. ì´ˆê¸°í™” ë° ê³µí†µ ìœ í‹¸
    const init = () => {
        performSearch();
        loadUserStatusOptions();
        performUserSearch();
        loadGroups();
        loadRoles();
        loadJobStatus();
        loadJobTypes();
    };

    const apiCall = (url, type, data, success, error) => $.ajax({
        url,
        type,
        data: typeof data === 'object' && type !== 'GET' ? JSON.stringify(data) : data,
        contentType: type !== 'GET' ? 'application/json' : undefined,
        success,
        error
    });

 // 2. ê²€ìƒ‰ ìœ í‹¸ë¦¬í‹° (ë¼ì´ë¸Œ ê²€ìƒ‰ + ì—”í„° ì²˜ë¦¬)
    const handleSearch = (inputSelector, searchFn) => {
    let timer;
    $(inputSelector).on('input', function () {
        clearTimeout(timer);
        timer = setTimeout(() => {
            // ì…ë ¥ê°’ì„ ì†Œë¬¸ìë¡œ ë³€ê²½í•˜ì—¬ ê²€ìƒ‰ ì‹¤í–‰ (ì„œë²„ ëŒ€ì‘ìš©)
            // ë§Œì•½ ì„œë²„ê°€ ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ì´ ê²€ìƒ‰ì„ ì§€ì›í•œë‹¤ë©´ ì´ ê³¼ì • ì—†ì´ë„ ì˜ ì‘ë™í•´ì•¼ í•©ë‹ˆë‹¤.
            searchFn(); 
        }, 300);
    });
    
        // ì—”í„°í‚¤ëŠ” ì¦‰ì‹œ ì‹¤í–‰ë˜ë„ë¡ ìœ ì§€
        $(inputSelector).on('keydown', e => {
            if (e.key === 'Enter') {
                e.preventDefault();
                clearTimeout(timer); // ì—”í„° ëˆ„ë¥´ë©´ ëŒ€ê¸° ì¤‘ì¸ íƒ€ì´ë¨¸ ì·¨ì†Œ
                searchFn();
            }
        });
    };

    // 3. ë°ì´í„° ë¡œë”© ë° ë Œë”ë§ í•¨ìˆ˜
    const performSearch = () => $.get('/settings/api/projects/search', {
        status: $('#projectStatusSelect').val(),
        keyword: $('#keyword').val()
    }, renderProjectTable);

    const performUserSearch = () => $.get('/settings/api/users/search', {
        status: $('#userStatusSelect').val(),
        keyword: $('#userKeyword').val()
    }, renderUserTable);

    $('#btnSearch').on('click', performSearch);
    $('#btnUserSearch').on('click', performUserSearch);
    handleSearch('#keyword', performSearch);
    handleSearch('#userKeyword', performUserSearch);

    function renderProjectTable(projects) {
        const $tbody = $('#projectTableBody').empty();
        if (!projects?.length) return $tbody.append('<tr><td colspan="6" class="py-4">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>');

        projects.forEach(p => {
            const isLocked = (p.statusValue == 350);
            const date = p.createAt ? new Date(p.createAt).toLocaleDateString('ko-KR').replace(/\. /g, '/').replace('.', '') : "-";
            
            // ğŸ“ 2. í•µì‹¬ ìˆ˜ì • ë¡œì§
            // í˜„ì¬ ì ê¸ˆ ìƒíƒœê°€ ì•„ë‹ˆë¼ë©´(ì§„í–‰/ì¤‘ë‹¨ ë“±), ê·¸ ê°’ì„ Mapì— 'ì§„ì§œ ì›ë˜ ìƒíƒœ'ë¡œ ì €ì¥í•©ë‹ˆë‹¤.
            if (!isLocked) {
                projectOriginMap[p.projectNo] = p.statusValue;
            }

            // ë§Œì•½ í˜„ì¬ ì ê¸ˆ ìƒíƒœë¼ë©´, Mapì—ì„œ ì˜ˆì „ ìƒíƒœë¥¼ êº¼ë‚´ì˜µë‹ˆë‹¤. (ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ 330)
            const originStatus = isLocked ? (projectOriginMap[p.projectNo] || 330) : p.statusValue;

            $tbody.append(`
                <tr>
                    <td><span class="badge ${p.statusValue == 330 ? 'bg-success' : isLocked ? 'bg-warning' : 'bg-info'}">${p.statusLabel}</span></td>
                    <td class="text-start">${p.projectName}</td>
                    <td><span class="badge rounded-pill ${p.publicYn === 1 ? 'text-bg-light border' : 'text-bg-dark'}">${p.publicYnLabel}</span></td>
                    <td>${date}</td>
                    <td>
                        <button class="btn btn-sm btn-lock ${isLocked ? 'btn-outline-success' : 'btn-outline-warning'}" 
                                data-id="${p.projectNo}" 
                                data-status="${p.statusValue}"
                                data-origin="${originStatus}"> <i class="${isLocked ? 'cil-lock-locked' : 'cil-lock-unlocked'}"></i> 
                            ${isLocked ? 'ì ê¸ˆí•´ì œ' : 'ì ê¸ˆ'}
                        </button> 
                        <button class="btn btn-sm btn-outline-danger btn-delete" data-id="${p.projectNo}">ì‚­ì œ</button>
                    </td>
                </tr>`);
        });
    }

    function renderUserTable(users) {
        const $tbody = $('#userTableBody').empty();
        if (!users?.length) return $tbody.append('<tr><td colspan="7" class="py-4">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>');

        users.forEach(u => {
            const st = { 
                110: ['ì‚¬ìš©ì¤‘', 'bg-success'], 
                120: ['ë“±ë¡ëŒ€ê¸°', 'bg-info'], 
                130: ['ì ê¸ˆ', 'bg-warning'], 
                190: ['í‡´ì‚¬', 'bg-secondary'] 
            }[u.status] || ['ì•Œìˆ˜ì—†ìŒ', 'bg-dark'];

            const actionBtn = u.status === 120 
                ? `<button class="btn btn-sm btn-outline-primary btn-user-activate" data-id="${u.userId}">í™œì„±í™”</button>` 
                : `<button class="btn btn-sm ${u.status === 130 ? 'btn-outline-success' : 'btn-outline-warning'} btn-user-status" 
                           data-id="${u.userId}" 
                           data-status="${u.status === 130 ? 110 : 130}" 
                           ${u.status === 190 ? 'disabled' : ''}>${u.status === 130 ? 'ì ê¸ˆí•´ì œ' : 'ì ê¸ˆ'}</button>`;

            $tbody.append(`
                <tr>
                    <td>${u.userId}</td>
                    <td class="text-start">${u.userName}</td>
                    <td><span class="badge ${st[1]}">${st[0]}</span></td>
                    <td><span class="badge ${u.admin === 1 ? 'bg-danger' : 'bg-info'}">${u.admin === 1 ? 'ê´€ë¦¬ì' : 'ì¼ë°˜'}</span></td>
                    <td>${u.email || '-'}</td>
                    <td>${u.createTime ? new Date(u.createTime).toLocaleDateString() : "-"}</td>
                    <td>
                        ${actionBtn} 
                        <button class="btn btn-sm ${u.status === 190 ? 'btn-secondary' : 'btn-outline-danger'} btn-user-retire" 
                                data-id="${u.userId}" ${u.status === 190 ? 'disabled' : ''}>
                            ${u.status === 190 ? 'í‡´ì‚¬ì™„ë£Œ' : 'í‡´ì‚¬'}
                        </button>
                    </td>
                </tr>`);
        });
    }

    const loadUserStatusOptions = () => $.get('/settings/api/common/user-status-count', list => {
        const $select = $('#userStatusSelect'), cur = $select.val();
        $select.empty().append('<option value="">ì „ì²´ ìƒíƒœ</option>');
        list.forEach(s => $select.append(`<option value="${s.commonNo}" ${cur == s.commonNo ? 'selected' : ''}>${s.commonName} (${s.userCount})</option>`));
    });

    // 4. ê³µí†µ ì„¹ì…˜ í•¸ë“¤ëŸ¬ (ê·¸ë£¹/ì—­í• /ì¼ê° ì„¤ì •)
    const setupSection = (config) => {
    const renderTable = (data) => {
        const $tbody = $(config.tbodyId).empty();
        // ë°ì´í„°ê°€ ì—†ê±°ë‚˜ undefinedì¼ ë•Œ ì²˜ë¦¬
        if (!data || data.length === 0) {
            return $tbody.append(`<tr><td colspan="${config.cols}" class="py-4 text-center">${config.emptyMsg}</td></tr>`);
        }
        data.forEach(item => $tbody.append(config.rowFn(item)));
    };

    // ì „ì²´ ë¡œë“œ í•¨ìˆ˜
    const load = () => $.get(config.listUrl, renderTable);
    
    // ê²€ìƒ‰ í•¨ìˆ˜
    const search = () => {
        const keyword = $(config.keywordId).val();
        $.get(config.searchUrl, { keyword: keyword }, renderTable);
    };

    // ğŸ“ ë¼ì´ë¸Œ ê²€ìƒ‰ (ë°ë°”ìš´ì‹± ì ìš©)
    let timer;
    $(config.keywordId).on('input', function () {
        clearTimeout(timer);
        timer = setTimeout(() => {
            search();
        }, 300);
    });

    // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ë° ì—”í„° ì²˜ë¦¬
    $(config.searchBtnId).on('click', search);
    $(config.keywordId).on('keydown', e => {
        if (e.key === 'Enter') {
            e.preventDefault();
            clearTimeout(timer);
            search();
        }
    });

    // ìƒì„± ë²„íŠ¼ ì²˜ë¦¬
    $(config.addBtnId).on('click', () => {
        if ($(config.newInputId).length) return $(config.newInputId).focus();
        $(config.tbodyId).prepend(config.newRowHtml); 
        $(config.newInputId).focus();
    });

    // ğŸ“ ì¤‘ìš”: ìµœì´ˆ 1íšŒ ë¡œë“œëŠ” ìˆ˜ë™ìœ¼ë¡œ í˜¸ì¶œí•˜ê±°ë‚˜ ë¦¬í„´ë°›ì€ ê°ì²´ë¡œ í˜¸ì¶œí•´ì•¼ í•¨
    return { load, renderTable };
};

    // 5. ê° ì„¹ì…˜ ì»¨íŠ¸ë¡¤ëŸ¬ ì„¤ì •
    const gCtrl = setupSection({
        listUrl: '/settings/api/groups',
        searchUrl: '/settings/api/groups/search',
        searchBtnId: '#btnGroupSearch',
        keywordId: '#groupKeyword',
        addBtnId: '#btnGroupAdd',
        tbodyId: '#groupTableBody',
        cols: 4,
        emptyMsg: 'ë“±ë¡ëœ ê·¸ë£¹ì´ ì—†ìŠµë‹ˆë‹¤.',
        newInputId: '#groupNewInput',
        rowFn: g => `
            <tr>
                <td><span class="badge ${g.status == 510 ? 'bg-success' : 'bg-warning'}">${g.statusName}</span></td>
                <td class="text-start group-name-cell" data-id="${g.groupNo}" style="cursor:pointer">
                    <span class="name-text text-primary fw-bold">${g.groupName}</span>
                </td>
                <td class="text-center"><span class="badge bg-light text-dark">${g.memberCount || 0} ëª…</span></td>
                <td>
                    <button class="btn btn-sm ${g.status == 510 ? 'btn-outline-warning' : 'btn-outline-success'} btn-group-toggle" 
                            data-id="${g.groupNo}" data-status="${g.status}">ìƒíƒœë³€ê²½</button>
                </td>
            </tr>`,
        newRowHtml: `
            <tr class="table-info" id="rowGroupNew">
                <td>-</td>
                <td colspan="2"><input type="text" id="groupNewInput" class="form-control form-control-sm" placeholder="ìƒˆ ê·¸ë£¹ëª… ì…ë ¥"></td>
                <td>
                    <button class="btn btn-sm btn-primary btn-group-save">ì €ì¥</button>
                    <button class="btn btn-sm btn-secondary btn-group-cancel">ì·¨ì†Œ</button>
                </td>
            </tr>`
    });

    const rCtrl = setupSection({
        listUrl: '/settings/api/roles',
        searchUrl: '/settings/api/roles/search',
        searchBtnId: '#btnRoleSearch',
        keywordId: '#roleKeyword',
        addBtnId: '#btnRoleAdd',
        tbodyId: '#roleTableBody',
        cols: 2,
        emptyMsg: 'ë“±ë¡ëœ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.',
        newInputId: '#roleNewInput',
        rowFn: r => `
            <tr>
                <td class="text-start ps-4 role-name-cell" data-id="${r.roleNo}" style="cursor:pointer">
                    <span class="name-text text-primary fw-bold">${r.roleName}</span>
                </td>
                <td><button class="btn btn-sm btn-outline-danger btn-role-delete" data-id="${r.roleNo}">ì‚­ì œ</button></td>
            </tr>`,
        newRowHtml: `
            <tr class="table-info" id="rowRoleNew">
                <td><input type="text" id="roleNewInput" class="form-control form-control-sm" placeholder="ì—­í• ëª… ì…ë ¥"></td>
                <td>
                    <button class="btn btn-sm btn-primary btn-role-save">ì €ì¥</button>
                    <button class="btn btn-sm btn-secondary btn-role-cancel">ì·¨ì†Œ</button>
                </td>
            </tr>`
    });

    const jsCtrl = setupSection({ 
        listUrl: '/settings/api/job-status', 
        searchUrl: '/settings/api/job-status/search', 
        searchBtnId: '#btnJobStatusSearch', 
        keywordId: '#jobStatusKeyword', 
        addBtnId: '#btnJobStatusAdd', 
        tbodyId: '#jobStatusTableBody', 
        cols: 2, emptyMsg: 'ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 
        newInputId: '#jobStatusNewInput', 
        rowFn: i => `<tr><td class="text-start ps-4">${i.jobStatus}</td><td><button class="btn btn-sm btn-outline-danger btn-job-status-delete" data-id="${i.jobStatusNo}">ì‚­ì œ</button></td></tr>`, 
        newRowHtml: `<tr class="table-info" id="rowJobStatusNew"><td><input type="text" id="jobStatusNewInput" class="form-control form-control-sm" placeholder="ìƒíƒœëª… ì…ë ¥"></td><td><button class="btn btn-sm btn-primary btn-job-status-save">ì €ì¥</button> <button class="btn btn-sm btn-secondary btn-job-status-cancel">ì·¨ì†Œ</button></td></tr>` 
    });

    const jtCtrl = setupSection({ 
        listUrl: '/settings/api/job-types', 
        searchUrl: '/settings/api/job-types/search', 
        searchBtnId: '#btnJobTypeSearch', 
        keywordId: '#jobTypeKeyword', 
        addBtnId: '#btnJobTypeAdd', 
        tbodyId: '#jobTypeTableBody', 
        cols: 2, emptyMsg: 'ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 
        newInputId: '#jobTypeNewInput', 
        rowFn: i => `<tr><td class="text-start ps-4">${i.jobType}</td><td><button class="btn btn-sm btn-outline-danger btn-job-type-delete" data-id="${i.jobTypeNo}">ì‚­ì œ</button></td></tr>`, 
        newRowHtml: `<tr class="table-info" id="rowJobTypeNew"><td><input type="text" id="jobTypeNewInput" class="form-control form-control-sm" placeholder="ìœ í˜•ëª… ì…ë ¥"></td><td><button class="btn btn-sm btn-primary btn-job-type-save">ì €ì¥</button> <button class="btn btn-sm btn-secondary btn-job-type-cancel">ì·¨ì†Œ</button></td></tr>` 
    });

    const loadGroups = gCtrl.load, loadRoles = rCtrl.load, loadJobStatus = jsCtrl.load, loadJobTypes = jtCtrl.load;

    // 6. ê³µí†µ ì•¡ì…˜ ë°”ì¸ë”©
    const bindActions = (prefix, url, loadFn, dataFn, rowIdPrefix) => {
        let isProcessing = false;

        const save = () => {
            if (isProcessing) return;
            const $input = $(`#${prefix}NewInput`);
            const val = $input.val()?.trim();

            if (!val) { cancel(); return; }

            isProcessing = true;
            $input.prop('disabled', true);

            apiCall(url, 'POST', dataFn(val),
                (res) => {
                    alert("ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    isProcessing = false;
                    loadFn();
                },
                (err) => {
                    alert("ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    isProcessing = false;
                    $input.prop('disabled', false);
                }
            );
        };

        const cancel = () => { $(`#row${rowIdPrefix}New`).remove(); };
        const btnClassBase = prefix.replace(/([A-Z])/g, "-$1").toLowerCase();

        $(document).off('click', `.btn-${btnClassBase}-save`).on('click', `.btn-${btnClassBase}-save`, save);
        $(document).off('click', `.btn-${btnClassBase}-cancel`).on('click', `.btn-${btnClassBase}-cancel`, cancel);

        $(document).off('keydown', `#${prefix}NewInput`).on('keydown', `#${prefix}NewInput`, function (e) {
            if (e.key === 'Enter') { e.preventDefault(); save(); }
            if (e.key === 'Escape') cancel();
        });

        $(document).off('blur', `#${prefix}NewInput`).on('blur', `#${prefix}NewInput`, function () {
            setTimeout(() => { if (!$(this).val()?.trim()) cancel(); }, 200);
        });

        $(document).off('click', `.btn-${btnClassBase}-delete`).on('click', `.btn-${btnClassBase}-delete`, function () {
            const id = $(this).data('id');
            if (confirm("ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                apiCall(`${url}/${id}`, 'DELETE', null, () => {
                    alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    loadFn();
                });
            }
        });
    };

    bindActions('group', '/settings/api/groups', loadGroups, v => ({ groupName: v, status: 520 }), 'Group');
    bindActions('role', '/settings/api/roles', loadRoles, v => ({ roleName: v }), 'Role');
    bindActions('jobStatus', '/settings/api/job-status', loadJobStatus, v => ({ jobStatus: v }), 'JobStatus');
    bindActions('jobType', '/settings/api/job-types', loadJobTypes, v => ({ jobType: v }), 'JobType');

    // 7. íŠ¹ìˆ˜ ì´ë²¤íŠ¸ ì²˜ë¦¬ (í”„ë¡œì íŠ¸ & ì‚¬ìš©ì)
    $(document).on('click', '.btn-lock', function () {
    const id = $(this).data('id');
    const currentStatus = $(this).data('status');
    const originStatus = $(this).data('origin'); // ë²„íŠ¼ì— ë°•í˜€ìˆëŠ” 'ì¤‘ë‹¨(340)' í˜¹ì€ 'ì§„í–‰(330)'
    
    // í˜„ì¬ ì ê¸ˆ(350)ì´ë©´ ì›ë˜ ìƒíƒœë¡œ, ì•„ë‹ˆë©´ ì ê¸ˆ(350)ìœ¼ë¡œ!
    const targetStatus = (currentStatus == 350) ? originStatus : 350;

    $.ajax({
        url: `/settings/api/projects/${id}/lock?status=${targetStatus}`,
        type: 'PATCH',
        success: function () {
            alert("ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
            performSearch(); // ë‹¤ì‹œ ê²€ìƒ‰í•´ì„œ í…Œì´ë¸”ì„ ê·¸ë¦´ ë•Œ originStatusê°€ 350ìœ¼ë¡œ ë®ì–´ì¨ì§€ì§€ ì•Šê²Œ ì£¼ì˜í•´ì•¼ í•¨
        }
    });
});

    $(document).on('click', '.btn-delete', function () {
        if (confirm("í”„ë¡œì íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            apiCall(`/settings/api/projects/${$(this).data('id')}`, 'DELETE', null, performSearch);
        }
    });

    $(document).on('click', '.btn-user-status, .btn-user-activate, .btn-user-retire', function () {
        const userId = $(this).data('id');
        let targetStatus;

        if ($(this).hasClass('btn-user-activate')) {
            targetStatus = 110;
        } else if ($(this).hasClass('btn-user-retire')) {
            if (!confirm("ì •ë§ë¡œ í‡´ì‚¬ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            targetStatus = 190;
        } else {
            targetStatus = $(this).data('status');
        }

        apiCall('/settings/api/users/status', 'PATCH', { userId: userId, status: targetStatus }, function (res) {
            alert("ì‚¬ìš©ì ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
            performUserSearch();
            loadUserStatusOptions();
        });
    });

    $(document).on('click', '.btn-group-toggle', function () {
        apiCall(`/settings/api/groups/${$(this).data('id')}/toggle-status`, 'PATCH', null, loadGroups);
    });

    $(document).on('click', '.role-name-cell', function () {
        const roleId = $(this).data('id');
        if (roleId) location.href = `/settings/roles-info?menu_id=${roleId}`;
    });

    $(document).on('click', '.group-name-cell', function () {
        const groupId = $(this).data('id');
        if (groupId) location.href = `/settings/groups-info?group_no=${groupId}`;
    });

    
 	// í”„ë¡œì íŠ¸ ìƒíƒœ ë³€ê²½ ì‹œ ì¦‰ì‹œ ê²€ìƒ‰
    $('#projectStatusSelect').on('change', performSearch);

    // ì‚¬ìš©ì ìƒíƒœ ë³€ê²½ ì‹œ ì¦‰ì‹œ ê²€ìƒ‰
    $('#userStatusSelect').on('change', performUserSearch);
    
    
    init();
});
</script>
	</div>
</html>