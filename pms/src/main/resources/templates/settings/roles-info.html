<!DOCTYPE html>
<html lang="ko" xmlns:th="https://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/default-layout}">

<head>
<title>ê¶Œí•œ ìƒì„¸ ì„¤ì •</title>
<style>
.table th {
	background-color: #f8f9fa;
}

.permission-checkbox {
	transform: scale(1.2);
	cursor: pointer;
}

.menu-name {
	font-weight: 600;
	color: #333;
}

.url-text {
	font-size: 0.85rem;
	color: #666;
}

/* ìˆ˜ì • ëª¨ë“œ ì‹œ ê°•ì¡° íš¨ê³¼ */
#roleNameInput {
	font-size: 1.25rem;
	font-weight: bold;
	border-color: #4f5d73;
}

.role-header-area {
	padding: 1.5rem 1rem; /* í—¤ë” ê°„ê²© í™•ì¥ */
}
</style>
</head>

<body>
	<div layout:fragment="Content">
		<div class="container-fluid">
			<div class="card mb-4 shadow-sm">
				<div
					class="card-body d-flex justify-content-between align-items-center role-header-area">
					<div id="roleNameContainer" class="d-flex align-items-center gap-3">
						<h3 class="mb-0 d-flex align-items-center gap-2">
							<i class="cil-shield-check text-primary"></i> <span
								id="roleNameDisplay">ì—­í•  ê¶Œí•œ ì„¤ì •</span> <input type="text"
								id="roleNameInput" class="form-control d-none"
								style="width: 300px;">
						</h3>

						<div class="action-buttons">
							<button type="button" id="btnEditRoleName"
								class="btn btn-outline-secondary btn-sm">
								<i class="cil-pencil"></i> ì´ë¦„ ìˆ˜ì •
							</button>
							<button type="button" id="btnSaveRoleName"
								class="btn btn-success btn-sm text-white d-none">í™•ì¸</button>
							<button type="button" id="btnCancelRoleName"
								class="btn btn-link btn-sm text-danger d-none">ì·¨ì†Œ</button>
						</div>
						<span class="badge bg-light text-dark p-2" id="roleIdDisplay"></span>
					</div>

					<div class="d-flex gap-2">
						<button type="button" class="btn btn-outline-dark"
							onclick="history.back()">
							<i class="cil-arrow-left"></i> ë’¤ë¡œê°€ê¸°
						</button>
						<button type="button" id="btnSaveAll" class="btn btn-primary px-4">
							<i class="cil-save"></i> ì „ì²´ ê¶Œí•œ ì €ì¥
						</button>
					</div>
				</div>
			</div>

			<div class="card mb-4 border-0">
				<div class="card-body p-0">
					<div class="input-group input-group-lg shadow-sm">
						<span class="input-group-text bg-white border-end-0"><i
							class="cil-search"></i></span> <input type="text" id="menuSearchInput"
							class="form-control border-start-0 ps-0"
							placeholder="ì°¾ìœ¼ì‹œëŠ” ë©”ë‰´ëª… ë˜ëŠ” ê²½ë¡œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
						<button class="btn btn-light border" type="button"
							id="btnSearchClear">ì´ˆê¸°í™”</button>
					</div>
				</div>
			</div>

			<div class="card shadow-sm">
				<div class="card-header bg-white py-3">
					<h5 class="card-title mb-0">ë©”ë‰´ ì ‘ê·¼ ì œì–´ í–‰ë ¬ (CRUD Matrix)</h5>
				</div>
				<div class="card-body p-0">
					<table
						class="table table-bordered table-hover mb-0 text-center align-middle"
						id="permissionTable">
						<thead class="table-light">
							<tr>
								<th style="width: 30%;" class="py-3">ë©”ë‰´ëª… / ê²½ë¡œ</th>
								<th style="width: 15%;">ì¡°íšŒ(READ) <br> <input
									type="checkbox" class="form-check-input select-all mt-2"
									data-type="read"></th>
								<th style="width: 15%;">ìƒì„±(CREATE) <br> <input
									type="checkbox" class="form-check-input select-all mt-2"
									data-type="create"></th>
								<th style="width: 15%;">ìˆ˜ì •(UPDATE) <br> <input
									type="checkbox" class="form-check-input select-all mt-2"
									data-type="update"></th>
								<th style="width: 15%;">ì‚­ì œ(DELETE) <br> <input
									type="checkbox" class="form-check-input select-all mt-2"
									data-type="delete"></th>
							</tr>
						</thead>
						<tbody id="permissionTableBody">
							<tr>
								<td colspan="5" class="py-5 text-muted">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
		</div>

		<script th:inline="javascript">
    $(document).ready(function () {
        const urlParams = new URLSearchParams(window.location.search);
        const roleNo = urlParams.get('menu_id');

        if (!roleNo) {
            alert("ê¶Œí•œ ë²ˆí˜¸ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.");
            location.href = "/settings";
            return;
        }
        
        $(document).on('change', '.permission-checkbox', function() {
            updateSelectAllStatus();
        });

        // 1. ë°ì´í„° ë¡œë“œ ë° ìƒë‹¨ ì´ë¦„ ë™ê¸°í™”
        const loadData = () => {
    $.get(`/settings/api/roles/${roleNo}/permissions`, function (data) {
        renderTable(data);
        
        if(data && data.length > 0) {
            const realRoleName = data[0].roleName || "ì´ë¦„ ì •ë³´ ì—†ìŒ";
            $('#roleNameDisplay').text(realRoleName);
            $('#roleIdDisplay').text(`(ID: ${roleNo})`);
            
            // ğŸ“ ì¶”ê°€: í…Œì´ë¸” ë Œë”ë§ í›„ ì „ì²´ ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
            updateSelectAllStatus();
        }
    });
};

        // 2. í…Œì´ë¸” ë Œë”ë§
        const renderTable = (list) => {
            const $tbody = $('#permissionTableBody').empty();
            if(!list || list.length === 0) {
                $tbody.append('<tr><td colspan="5" class="py-5 text-muted">ì—°ê²°ëœ ë©”ë‰´ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>');
                return;
            }
            list.forEach(item => {
                $tbody.append(`
                    <tr data-menu-id="${item.menuId}">
                        <td class="text-start ps-4 search-target">
                            <div class="menu-name">${item.menuName}</div>
                            <div class="url-text text-secondary small">${item.urlData || '-'}</div>
                        </td>
                        <td><input type="checkbox" class="form-check-input permission-checkbox" data-type="read" ${item.crudRead == 1 ? 'checked' : ''}></td>
                        <td><input type="checkbox" class="form-check-input permission-checkbox" data-type="create" ${item.crudCreate == 1 ? 'checked' : ''}></td>
                        <td><input type="checkbox" class="form-check-input permission-checkbox" data-type="update" ${item.crudUpdate == 1 ? 'checked' : ''}></td>
                        <td><input type="checkbox" class="form-check-input permission-checkbox" data-type="delete" ${item.crudDelete == 1 ? 'checked' : ''}></td>
                    </tr>
                `);
            });
        };

        // 3. ì‹¤ì‹œê°„ ê²€ìƒ‰ í•„í„°ë§
        $('#menuSearchInput').on('keyup', function() {
            const value = $(this).val().toLowerCase().trim();
            $('#permissionTableBody tr').each(function() {
                const content = $(this).find('.search-target').text().toLowerCase();
                $(this).toggle(content.indexOf(value) > -1);
            });
            updateSelectAllStatus();
        });

        $('#btnSearchClear').on('click', function() {
            $('#menuSearchInput').val('').trigger('keyup').focus();
        });

        // 4. ì „ì²´ ì„ íƒ ê¸°ëŠ¥
        $(document).on('change', '.select-all', function() {
            const type = $(this).data('type');
            const isChecked = $(this).is(':checked');
            $('#permissionTableBody tr:visible').find(`.permission-checkbox[data-type="${type}"]`).prop('checked', isChecked);
        });

        // 5. ì—­í•  ì´ë¦„ ìˆ˜ì • ê´€ë ¨ ë¡œì§
        $('#btnEditRoleName').on('click', function() {
            const currentName = $('#roleNameDisplay').text();
            $('#roleNameDisplay, #btnEditRoleName').addClass('d-none');
            $('#roleNameInput').val(currentName).removeClass('d-none').focus();
            $('#btnSaveRoleName, #btnCancelRoleName').removeClass('d-none');
        });

        $('#btnCancelRoleName').on('click', function() {
            $('#roleNameInput, #btnSaveRoleName, #btnCancelRoleName').addClass('d-none');
            $('#roleNameDisplay, #btnEditRoleName').removeClass('d-none');
        });

        $('#btnSaveRoleName').on('click', function() {
            const newName = $('#roleNameInput').val().trim();
            if(!newName) return alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");

            $.ajax({
                url: `/settings/api/roles/${roleNo}`,
                type: 'PATCH',
                contentType: 'application/json',
                data: JSON.stringify({ roleName: newName }),
                success: function() {
                    $('#roleNameDisplay').text(newName);
                    $('#btnCancelRoleName').click();
                    alert("ì—­í•  ì´ë¦„ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
                }
            });
        });

        // 6. ì „ì²´ ê¶Œí•œ ì €ì¥ ë¡œì§ (btnSaveAll í´ë¦­ ì‹œ ì‹¤í–‰)
        $('#btnSaveAll').on('click', function () {
            if(!confirm("ì´ ì„¤ì •ìœ¼ë¡œ ê¶Œí•œì„ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

            const permissions = [];
            $('#permissionTableBody tr').each(function () {
                const $row = $(this);
                if($row.data('menu-id')) {
                    permissions.push({
                        menuId: $row.data('menu-id'),
                        roleNo: roleNo,
                        crudRead: $row.find('[data-type="read"]').is(':checked') ? 1 : 0,
                        crudCreate: $row.find('[data-type="create"]').is(':checked') ? 1 : 0,
                        crudUpdate: $row.find('[data-type="update"]').is(':checked') ? 1 : 0,
                        crudDelete: $row.find('[data-type="delete"]').is(':checked') ? 1 : 0
                    });
                }
            });

            $.ajax({
                url: `/settings/api/roles/${roleNo}/permissions`,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(permissions),
                success: function () {
                    alert("ê¶Œí•œ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    loadData();
                },
                error: function () { alert("ê¶Œí•œ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); }
            });
        });

        // ì—”í„°í‚¤ ëŒ€ì‘
        $('#roleNameInput').on('keydown', function(e) {
            if(e.key === 'Enter') $('#btnSaveRoleName').click();
            if(e.key === 'Escape') $('#btnCancelRoleName').click();
        });

        
        const updateSelectAllStatus = () => {
            const types = ['read', 'create', 'update', 'delete'];
            
            types.forEach(type => {
                // í˜„ì¬ í™”ë©´ì— ë³´ì´ëŠ”(filter ì œì™¸) í•´ë‹¹ íƒ€ì…ì˜ ëª¨ë“  ì²´í¬ë°•ìŠ¤ ê°œìˆ˜
                const totalVisible = $(`.permission-checkbox[data-type="${type}"]:visible`).length;
                // ê·¸ ì¤‘ ì²´í¬ëœ ê²ƒì˜ ê°œìˆ˜
                const checkedVisible = $(`.permission-checkbox[data-type="${type}"]:visible:checked`).length;
                
                // ì „ì²´ ê°œìˆ˜ê°€ 0ë³´ë‹¤ í¬ê³ , ì²´í¬ëœ ê°œìˆ˜ê°€ ì „ì²´ì™€ ê°™ë‹¤ë©´ ìƒë‹¨ ì²´í¬ë°•ìŠ¤ ì²´í¬!
                const isAllChecked = totalVisible > 0 && totalVisible === checkedVisible;
                $(`.select-all[data-type="${type}"]`).prop('checked', isAllChecked);
            });
        };
        
        // 7. ì´ˆê¸° ì‹¤í–‰
        loadData();
    }); // document ready ë
</script>
	</div>
</body>
</html>