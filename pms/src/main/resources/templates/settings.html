<html layout:decorate="~{common/layouts/default_layout}">
<div layout:fragment="Content">

    <div class="accordion" id="settingsAccordion">
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button" type="button" data-coreui-toggle="collapse" data-coreui-target="#collapseProject">
                    프로젝트 관리
                </button>
            </h2>

            <div id="collapseProject" class="accordion-collapse collapse show" data-coreui-parent="#settingsAccordion">
                <div class="accordion-body">
                    <div class="card mb-3">
                        <div class="card-body">
                            <form id="searchForm" class="row g-2">
                                <div class="col-md-3">
                                    <select id="statusSelect" name="status" class="form-select">
                                        <option value="">전체 상태</option>
                                        <th:block th:each="status : ${statusList}">
                                            <option th:value="${status.commonNo}" th:text="${status.commonName}"></option>
                                        </th:block>
                                    </select>
                                </div>
                                <div class="col-md-7">
                                    <input type="text" id="keyword" name="keyword" class="form-control" placeholder="프로젝트명 검색">
                                </div>
                                <div class="col-md-2">
                                    <button type="button" id="btnSearch" class="btn btn-primary w-100">
                                        <i class="cil-search"></i> 검색
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body p-0">
                            <table class="table table-striped table-hover mb-0 text-center align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>번호</th>
                                        <th>프로젝트명</th>
                                        <th>상태</th>
                                        <th>공개 여부</th>
                                        <th>등록일</th>
                                        <th>관리</th>
                                    </tr>
                                </thead>
                                <tbody id="projectTableBody">
                                    <tr th:each="p : ${projects}">
                                        <td th:text="${p.projectNo}"></td>
                                        <td class="text-start" th:text="${p.projectName}"></td>
                                        <td>
                                            <span class="badge" th:classappend="${p.statusLabel == '진행중' ? 'bg-success' : (p.statusLabel == '중단' ? 'bg-danger' : (p.statusLabel == '종료' ? 'bg-secondary' : 'bg-info'))}" th:text="${p.statusLabel}"></span>
                                        </td>
                                        <td>
                                            <span class="badge rounded-pill" th:classappend="${p.publicYnLabel == '공개' ? 'text-bg-light border' : 'text-bg-dark'}" th:text="${p.publicYnLabel}"></span>
                                        </td>
                                        <td th:text="${#temporals.format(p.createAt,'yyyy/MM/dd')}"></td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary" th:onclick="|alert('프로젝트 번호: ${p.projectNo}')|">상세</button>
                                            <button class="btn btn-sm btn-outline-danger btn-delete" th:data-id="${p.projectNo}">삭제</button>
                                        </td>
                                    </tr>
                                    <tr th:if="${#lists.isEmpty(projects)}">
                                        <td colspan="6" class="py-4">등록된 프로젝트가 없습니다.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
        $(document).ready(function () {
            // 검색 실행
            $('#btnSearch').on('click', performSearch);
            $('#keyword').on('keypress', (e) => { if(e.which == 13) { e.preventDefault(); performSearch(); } });

            function performSearch() {
                const status = $('#statusSelect').val();
                const keyword = $('#keyword').val();
                $.ajax({
                    url: '/settings/api/projects/search',
                    type: 'GET',
                    data: { status, keyword },
                    success: renderProjectTable
                });
            }

            function renderProjectTable(projects) {
                const $tbody = $('#projectTableBody').empty();
                if (!projects || projects.length === 0) {
                    $tbody.append('<tr><td colspan="6" class="py-4">검색 결과가 없습니다.</td></tr>');
                    return;
                }

                projects.forEach(p => {
                    let formattedDate = p.createAt ? new Date(p.createAt).toLocaleDateString('zh-Hans-CN').replace(/-/g, '/') : "-";
                    let statusColor = p.statusLabel === '진행중' ? 'bg-success' : (p.statusLabel === '종료' ? 'bg-secondary' : (p.statusLabel === '중단' ? 'bg-danger' : 'bg-info'));
                    let publicClass = p.publicYnLabel === '공개' ? 'text-bg-light border' : 'text-bg-dark';

                    const row = `
                        <tr>
                            <td>${p.projectNo}</td>
                            <td class="text-start">${p.projectName}</td>
                            <td><span class="badge ${statusColor}">${p.statusLabel}</span></td>
                            <td><span class="badge rounded-pill ${publicClass}">${p.publicYnLabel}</span></td>
                            <td>${formattedDate}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="alert('프로젝트 번호: ${p.projectNo}')">상세</button>
                                <button class="btn btn-sm btn-outline-danger btn-delete" data-id="${p.projectNo}">삭제</button>
                            </td>
                        </tr>`;
                    $tbody.append(row);
                });
            }

            // 딸-깍! 삭제 이벤트 (위임 방식)
            $(document).on('click', '.btn-delete', function() {
                const id = $(this).data('id');
                if(confirm(`${id}번 프로젝트를 삭제하시겠습니까?`)) {
                    $.ajax({
                        url: `/settings/api/projects/${id}`,
                        type: 'DELETE',
                        success: function() {
                            alert("삭제되었습니다.");
                            performSearch();
                        },
                        error: () => alert("삭제 처리에 실패했습니다.")
                    });
                }
            });
        });
    </script>
</div>
</html>