<html layout:decorate="~{common/layouts/default_layout}">

<div layout:fragment="Content">
    <div class="accordion" id="settingsAccordion">
        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button" type="button"
                        data-coreui-toggle="collapse" data-coreui-target="#collapseProject">
                    프로젝트
                </button>
            </h2>

            <div id="collapseProject" class="accordion-collapse collapse show"
                 data-coreui-parent="#settingsAccordion">
                <div class="accordion-body">

                    <div class="card mb-3">
                        <div class="card-body">
                            <form id="searchForm" class="row g-2">
                                <div class="col-md-3">
                                    <select id="statusSelect" name="status" class="form-select">
                                        <option value="">전체 상태</option>
                                        <th:block th:each="status : ${statusList}">
                                            <option th:value="${status.code}" th:text="${status.label}"></option>
                                        </th:block>
                                    </select>
                                </div>
                                <div class="col-md-7">
                                    <input type="text" id="keyword" name="keyword"
                                           class="form-control" placeholder="프로젝트명 검색">
                                </div>
                                <div class="col-md-2">
                                    <button type="button" id="btnSearch" class="btn btn-primary w-100">검색</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body p-0">
                            <table class="table table-striped table-hover mb-0 text-center">
                                <thead class="table-light">
                                    <tr>
                                        <th>프로젝트명</th>
                                        <th>상태</th>
                                        <th>등록일</th>
                                    </tr>
                                </thead>
                                <tbody id="projectTableBody">
                                    <tr th:each="p : ${projects}">
                                        <td th:text="${p.projectName}"></td>
                                        <td>
                                            <span class="badge"
                                                  th:classappend="${p.statusLabel == '진행중'} ? 'bg-success' : 'bg-secondary'"
                                                  th:text="${p.statusLabel}"></span>
                                        </td>
                                        <td th:text="${#temporals.format(p.createAt,'yyyy/MM/dd')}"></td>
                                    </tr>
                                    <tr th:if="${#lists.isEmpty(projects)}">
                                        <td colspan="3">데이터가 없습니다.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

<script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
    <script>
        $(document).ready(function() {
            // 1. 엔터키 방지 및 검색 실행
            $('#searchForm').on('submit', function(e) {
                e.preventDefault();
                performSearch();
            });

            // 2. 검색 버튼 클릭 시
            $('#btnSearch').on('click', function() {
                performSearch();
            });

            // 3. AJAX 검색 함수
            function performSearch() {
                const status = $('#statusSelect').val();
                const keyword = $('#keyword').val();

                $.ajax({
                    url: '/api/projects/search',
                    type: 'GET',
                    data: { 
                        status: status, 
                        keyword: keyword 
                    },
                    success: function(data) {
                        renderProjectTable(data);
                    },
                    error: function(xhr) {
                        console.error("검색 중 오류 발생:", xhr);
                        alert("데이터를 불러오는 중 오류가 발생했습니다.");
                    }
                });
            }

            // 4. 테이블 동적 렌더링 함수
            function renderProjectTable(projects) {
                const $tbody = $('#projectTableBody');
                $tbody.empty(); // 기존 내용 삭제

                if (!projects || projects.length === 0) {
                    $tbody.append('<tr><td colspan="3" class="py-4">검색 결과가 없습니다.</td></tr>');
                    return;
                }

                projects.forEach(function(p) {
                    // 날짜 변환 (null 대응)
                    let formattedDate = "-";
                    if (p.createAt) {
                        const date = new Date(p.createAt);
                        formattedDate = date.getFullYear() + '/' + 
                                        String(date.getMonth() + 1).padStart(2, '0') + '/' + 
                                        String(date.getDate()).padStart(2, '0');
                    }

                    const badgeClass = (p.statusLabel === '진행중') ? 'bg-success' : 'bg-secondary';

                    const row = `
                        <tr>
                            <td>${p.projectName}</td>
                            <td><span class="badge ${badgeClass}">${p.statusLabel}</span></td>
                            <td>${formattedDate}</td>
                        </tr>
                    `;
                    $tbody.append(row);
                });
            }
        });
    </script>
</div>

</html>