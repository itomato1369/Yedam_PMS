<html layout:decorate="~{common/layouts/default_layout}">
<div layout:fragment="Content">

    <div class="accordion" id="settingsAccordion">

        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button" type="button"
                    data-coreui-toggle="collapse" data-coreui-target="#collapseProject">
                    프로젝트 관리</button>
            </h2>

            <div id="collapseProject" class="accordion-collapse collapse show"
                data-coreui-parent="#settingsAccordion">
                <div class="accordion-body">

                    <div class="card mb-3">
                        <div class="card-body">
                            <form id="searchForm" class="row g-2">
                                <div class="col-md-3">
                                    <select id="statusSelect" name="status" class="form-select">
                                        <option value="">전체 상태</option>
                                        <th:block th:each="status : ${statusList}">
                                            <option th:value="${status.commonNo}" th:text="${status.commonName}"></option>
                                        </th:block>
                                    </select>
                                </div>
                                <div class="col-md-7">
                                    <input type="text" id="keyword" name="keyword"
                                        class="form-control" placeholder="프로젝트명 검색">
                                </div>
                                <div class="col-md-2">
                                    <button type="button" id="btnSearch"
                                        class="btn btn-primary w-100">
                                        <i class="cil-search"></i> 검색
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body p-0">
                            <table class="table table-striped table-hover mb-0 text-center align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>번호</th>
                                        <th>프로젝트명</th>
                                        <th>상태</th>
                                        <th>공개 여부</th>
                                        <th>등록일</th>
                                        <th>관리</th>
                                    </tr>
                                </thead>
                                <tbody id="projectTableBody">
                                    <tr th:each="p : ${projects}">
                                        <td th:text="${p.projectNo}"></td>
                                        <td class="text-start" th:text="${p.projectName}"></td>
                                        <td>
                                            <span class="badge"
                                                th:classappend="${p.statusValue == 1 ? 'bg-info' : (p.statusValue == 2 ? 'bg-success' : 'bg-secondary')}"
                                                th:text="${p.statusLabel}"></span>
                                        </td>
                                        <td>
                                            <span class="badge rounded-pill" 
                                                  th:classappend="${p.publicYnLabel == '공개' ? 'text-bg-light border' : 'text-bg-dark'}"
                                                  th:text="${p.publicYnLabel}"></span>
                                        </td>
                                        <td th:text="${#temporals.format(p.createAt,'yyyy/MM/dd')}"></td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary">상세</button>
                                        </td>
                                    </tr>
                                    <tr th:if="${#lists.isEmpty(projects)}">
                                        <td colspan="6" class="py-4">등록된 프로젝트가 없습니다.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>
        </div>


        <div class="accordion-item">
            <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button"
                    data-coreui-toggle="collapse" data-coreui-target="#collapseUsers">
                    유저 관리</button>
            </h2>

            <div id="collapseUsers" class="accordion-collapse collapse"
                data-coreui-parent="#settingsAccordion">
                <div class="accordion-body">
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="row g-2">
                                <div class="col-md-3">
                                    <select id="userStatusSelect" class="form-select">
                                        <option value="">전체 상태</option>
                                        <option value="110">사용중</option>
                                        <option value="120">등록대기</option>
                                        <option value="130">잠김</option>
                                    </select>
                                </div>
                                <div class="col-md-7">
                                    <input type="text" id="userKeyword" class="form-control" placeholder="이름 검색">
                                </div>
                                <div class="col-md-2">
                                    <button id="btnUserSearch" class="btn btn-primary w-100">검색</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body p-0">
                            <table class="table table-striped table-hover mb-0 text-center align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>아이디</th>
                                        <th>이름</th>
                                        <th>상태</th>
                                        <th>변경</th>
                                    </tr>
                                </thead>
                                <tbody id="userTableBody">
                                    <tr><td colspan="4" class="py-4">데이터를 불러오는 중...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        $(document).ready(function () {

            /* ================= 프로젝트 검색 및 렌더링 ================= */
            $('#btnSearch').on('click', function() {
                performSearch();
            });

            // 엔터키 검색 허용
            $('#keyword').on('keypress', function(e) {
                if(e.which == 13) {
                    e.preventDefault();
                    performSearch();
                }
            });

            function performSearch() {
                const status = $('#statusSelect').val();
                const keyword = $('#keyword').val();

                $.ajax({
                    url: '/api/projects/search',
                    type: 'GET',
                    data: { status: status, keyword: keyword },
                    success: function(data) {
                        renderProjectTable(data);
                    }
                });
            }

            function renderProjectTable(projects) {
                const $tbody = $('#projectTableBody');
                $tbody.empty();

                if (!projects || projects.length === 0) {
                    $tbody.append('<tr><td colspan="6" class="py-4">검색 결과가 없습니다.</td></tr>');
                    return;
                }

                projects.forEach(function(p) {
                    // 날짜 포맷팅
                    let formattedDate = "-";
                    if (p.createAt) {
                        const date = new Date(p.createAt);
                        formattedDate = date.getFullYear() + '/' +
                            String(date.getMonth() + 1).padStart(2, '0') + '/' +
                            String(date.getDate()).padStart(2, '0');
                    }

                    // 상태 배지 색상 결정 로직
                    let statusBadgeColor = 'bg-secondary';
                    if(p.statusLabel === '진행중') statusBadgeColor = 'bg-success';
                    else if(p.statusLabel === '계획중') statusBadgeColor = 'bg-info';

                    // 공개여부 배지 색상
                    const publicBadgeClass = (p.publicYnLabel === '공개') ? 'text-bg-light border' : 'text-bg-dark';

                    const row = `
                        <tr>
                            <td>${p.projectNo}</td>
                            <td class="text-start">${p.projectName}</td>
                            <td><span class="badge ${statusBadgeColor}">${p.statusLabel}</span></td>
                            <td><span class="badge rounded-pill ${publicBadgeClass}">${p.publicYnLabel}</span></td>
                            <td>${formattedDate}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="alert('프로젝트 번호: ${p.projectNo}')">상세</button>
                            </td>
                        </tr>
                    `;
                    $tbody.append(row);
                });
            }

            /* ================= 유저 관리 (기존 로직 유지) ================= */
            function loadUsers() {
                $.ajax({
                    url: '/admin/users',
                    type: 'GET',
                    success: function(users) { renderUserTable(users); }
                });
            }

            $('#collapseUsers').on('show.coreui.collapse', function () {
                loadUsers();
            });

            $('#btnUserSearch').on('click', function () {
                const status = $('#userStatusSelect').val();
                const keyword = $('#userKeyword').val();
                $.ajax({
                    url: '/admin/users/search',
                    type: 'GET',
                    data: { status: status, keyword: keyword },
                    success: function(users) { renderUserTable(users); }
                });
            });

            function renderUserTable(users) {
                const $tbody = $('#userTableBody');
                $tbody.empty();
                if (!users || users.length === 0) {
                    $tbody.append('<tr><td colspan="4">결과 없음</td></tr>');
                    return;
                }
                users.forEach(function(u) {
                    const row = `
                        <tr>
                            <td>${u.userId}</td>
                            <td>${u.username}</td>
                            <td>
                                <select class="form-select form-select-sm user-status" data-id="${u.userId}">
                                    <option value="110" ${u.status == 110 ? 'selected' : ''}>사용중</option>
                                    <option value="120" ${u.status == 120 ? 'selected' : ''}>등록대기</option>
                                    <option value="130" ${u.status == 130 ? 'selected' : ''}>잠김</option>
                                </select>
                            </td>
                            <td><button class="btn btn-sm btn-primary btn-save-status" data-id="${u.userId}">저장</button></td>
                        </tr>
                    `;
                    $tbody.append(row);
                });
            }

            $(document).on('click', '.btn-save-status', function() {
                const userId = $(this).data('id');
                const status = $(`select[data-id='${userId}']`).val();
                $.ajax({
                    url: '/admin/users/status',
                    type: 'PATCH',
                    contentType: 'application/json',
                    data: JSON.stringify({ userId: userId, status: parseInt(status) }),
                    success: function() { alert("변경 완료"); }
                });
            });
        });
    </script>
</div>
</html>