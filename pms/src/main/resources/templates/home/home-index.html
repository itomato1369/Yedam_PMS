<!doctype html>
<html lang="ko" xmlns:th="https://www.thymeleaf.org/"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layouts/default-layout}"
	layout:fragment="Content">

<head>
<meta charset="UTF-8" />
<title>Dashboard</title>

<script
	src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<style>
/* 1. ëŒ€ì‹œë³´ë“œ ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ */
.dashboard-grid {
	display: grid;
	grid-template-columns: repeat(2, 1fr);
	gap: 24px;
	align-items: start;
}

/* 2. ìœ„ì ¯ ë°•ìŠ¤ ê³µí†µ ìŠ¤íƒ€ì¼ */
.section-box {
	background: #ffffff;
	border-radius: 12px;
	padding: 24px;
	box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
	height: 520px;
	display: flex;
	flex-direction: column;
	transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.section-box:hover {
	transform: translateY(-3px);
	box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
}

/* 3. íƒ€ì´í‹€ ë””ìì¸ */
.section-title {
	font-size: 18px;
	font-weight: 700;
	margin-bottom: 20px;
	display: flex;
	align-items: center;
	justify-content: space-between;
	gap: 8px;
	cursor: grab;
	flex: 0 0 auto;
}

.section-title:active {
	cursor: grabbing;
}

/* 4. ì½˜í…ì¸  ì˜ì—­ */
.section-content {
	flex: 1 1 auto;
	overflow-y: auto;
	overflow-x: hidden;
	padding-right: 5px;
}

/* 5. í˜ì´ì§€ë„¤ì´ì…˜ ìŠ¤íƒ€ì¼ */
.widget-pagination {
	display: flex;
	justify-content: center;
	gap: 6px;
	padding-top: 15px;
	flex: 0 0 auto;
}

.page-link-sm {
	padding: 3px 9px;
	font-size: 11px;
	font-weight: 600;
	cursor: pointer;
	border-radius: 4px;
	border: 1px solid #eee;
	background: #fdfdfd;
	color: #666;
}

.page-link-sm.active {
	background-color: #333;
	color: white;
	border-color: #333;
}

/* 6. ë©”ëª¨ ì¹´ë“œ ìŠ¤íƒ€ì¼ (í¬ìŠ¤íŠ¸ì‡ ëŠë‚Œ) */
.memo-bg-1 {
	background-color: #fff9db !important;
} /* ë…¸ë‘ */
.memo-bg-2 {
	background-color: #e3faf2 !important;
} /* ë¯¼íŠ¸ */
.memo-bg-3 {
	background-color: #f3f0ff !important;
} /* ë³´ë¼ */
.memo-bg-4 {
	background-color: #fff0f6 !important;
} /* í•‘í¬ */
.memo-card {
	position: relative;
	cursor: pointer;
	transition: all 0.2s;
	border: none !important;
	min-height: 140px;
}

.memo-card:hover {
	transform: scale(1.03);
	box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1) !important;
}

.memo-content-preview {
	display: -webkit-box;
	-webkit-line-clamp: 5;
	-webkit-box-orient: vertical;
	overflow: hidden;
	font-size: 0.85rem;
	line-height: 1.5;
	color: #333;
}

.btn-delete-memo {
	position: absolute;
	top: 8px;
	right: 8px;
	width: 24px;
	height: 24px;
	border-radius: 50%;
	background-color: rgba(0, 0, 0, 0.1);
	color: #666;
	border: none;
	font-size: 14px;
	line-height: 1;
	display: flex;
	align-items: center;
	justify-content: center;
	cursor: pointer;
	transition: background 0.2s, color 0.2s;
	z-index: 10;
}

.btn-delete-memo:hover {
	background-color: #dc3545;
	color: white;
}

.hidden-item {
	display: none !important;
}

.drag-ghost {
	opacity: 0.3;
}
</style>
</head>

<body>

	<div class="container-fluid">
		<h2 class="mb-4 fw-bold">ğŸ“Š ëŒ€ì‹œë³´ë“œ</h2>

		<div id="dashboardGrid" class="dashboard-grid">

			<div class="dashboard-item" data-id="projects">
				<div class="section-box border-top border-primary border-4">
					<div class="section-title text-primary">
						<span><i class="cil-folder-open"></i> í”„ë¡œì íŠ¸</span>
					</div>
					<div class="section-content" id="content-projects">
						<div th:if="${#lists.isEmpty(list.projects)}"
							class="alert alert-light text-center">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
						<div class="row g-3" th:unless="${#lists.isEmpty(list.projects)}">
							<div class="col-md-6 page-item-projects"
								th:each="p : ${list.projects}">
								<div class="card border-0 shadow-sm h-100 bg-light">
									<div class="card-body p-3">
										<h6 class="fw-bold mb-0 text-truncate"
											th:text="${p.projectName}">í”„ë¡œì íŠ¸ëª…</h6>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="widget-pagination" id="pager-projects"></div>
				</div>
			</div>

			<div class="dashboard-item" data-id="notices">
				<div class="section-box border-top border-warning border-4">
					<div class="section-title text-warning">
						<span><i class="cil-bullhorn"></i> ê³µì§€ì‚¬í•­</span>
					</div>
					<div class="section-content" id="content-notices">
						<div th:if="${#lists.isEmpty(list.notices)}"
							class="alert alert-light text-center">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
						<ul class="list-group list-group-flush"
							th:unless="${#lists.isEmpty(list.notices)}">
							<li
								class="list-group-item d-flex justify-content-between align-items-center px-0 bg-transparent page-item-notices"
								th:each="n : ${list.notices}"><span class="text-truncate"
								th:text="${n.title}" style="max-width: 80%;">ê³µì§€ì œëª©</span> <span
								class="badge bg-warning text-dark">NEW</span></li>
						</ul>
					</div>
					<div class="widget-pagination" id="pager-notices"></div>
				</div>
			</div>

			<div class="dashboard-item" data-id="memos">
				<div class="section-box border-top border-success border-4">
					<div class="section-title text-success">
						<span><i class="cil-note-add"></i> ë©”ëª¨</span>
						<button class="btn btn-sm btn-success" onclick="showMemoForm()">+
							ì¶”ê°€</button>
					</div>

					<div class="section-content" id="content-memos">
						<div id="memoInputForm"
							class="card mb-3 border-success shadow-sm hidden-item">
							<div class="card-body p-3">
								<textarea id="memoTextarea" class="form-control mb-2" rows="3"
									placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." style="resize: none;"></textarea>
								<div class="text-end">
									<button class="btn btn-sm btn-light me-1"
										onclick="hideMemoForm()">ì·¨ì†Œ</button>
									<button class="btn btn-sm btn-success" onclick="saveMemo()">ì €ì¥</button>
								</div>
							</div>
						</div>

						<div th:if="${#lists.isEmpty(list.memos)}" id="noMemoMsg"
							class="alert alert-light text-center" style="cursor: pointer;"
							onclick="showMemoForm()">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. (í´ë¦­í•˜ì—¬ ì¶”ê°€)</div>

						<div class="row g-3" id="memoList">
							<div class="col-6 page-item-memos"
								th:each="m, stat : ${list.memos}">
								<div
									th:class="'card memo-card shadow-sm h-100 memo-bg-' + ${ (stat.index % 4) + 1 }"
									th:onclick="viewMemoDetail([[${m.content}]])">
									<div class="card-body py-3">
										<p class="mb-0 memo-content-preview" th:text="${m.content}">ë©”ëª¨
											ë‚´ìš©</p>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="widget-pagination" id="pager-memos"></div>
				</div>
			</div>

			<div class="dashboard-item" data-id="stats">
				<div class="section-box border-top border-info border-4">
					<div class="section-title text-info">
						<span><i class="cil-chart"></i> í†µê³„</span>

					</div>
					<div
						class="section-content d-flex align-items-center justify-content-center">
						<p class="text-muted">Chart.js ì˜ì—­</p>
					</div>
				</div>
			</div>

		</div>
	</div>

	<div class="modal fade" id="memoDetailModal" tabindex="-1"
		aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content border-0 shadow-lg">
				<div class="modal-header bg-success text-white">
					<h5 class="modal-title fw-bold">ë©”ëª¨ ìƒì„¸</h5>
					<button type="button" class="btn-close btn-close-white"
						data-bs-dismiss="modal"></button>
				</div>
				<div class="modal-body p-4">
					<div id="fullMemoContent"
						style="white-space: pre-wrap; line-height: 1.6;"></div>
				</div>
			</div>
		</div>
	</div>

	<script th:inline="javascript">
	document.addEventListener("DOMContentLoaded", function () {
		
		// 1. í˜ì´ì§€ë„¤ì´ì…˜ ì´ˆê¸°í™” í•¨ìˆ˜
		function initWidgetPagination(widgetId, itemsPerPage) {
			const items = document.querySelectorAll(`.page-item-${widgetId}`);
			const pager = document.getElementById(`pager-${widgetId}`);
			if (!pager) return;

			pager.innerHTML = "";
			const totalPages = Math.ceil(items.length / itemsPerPage);
			
			if (totalPages <= 1) {
				pager.style.display = 'none';
				items.forEach(item => item.classList.remove('hidden-item'));
				return;
            }
            
			pager.style.display = 'flex';
			function renderPage(page) {
				const start = (page - 1) * itemsPerPage;
				const end = start + itemsPerPage;
				items.forEach((item, index) => {
					item.classList.toggle('hidden-item', !(index >= start && index < end));
				});
				pager.querySelectorAll('.page-link-sm').forEach((btn, idx) => {
					btn.classList.toggle('active', idx === (page - 1));
				});
			}

			for (let i = 1; i <= totalPages; i++) {
				const btn = document.createElement('button');
				btn.innerText = i;
				btn.className = 'page-link-sm';
				btn.onclick = () => renderPage(i);
				pager.appendChild(btn);
			}
			renderPage(1);
		}

		// ì´ˆê¸° ì‹¤í–‰
		initWidgetPagination('projects', 10);
		initWidgetPagination('notices', 10);
		initWidgetPagination('memos', 4);

		// ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì„¤ì •
		const grid = document.getElementById("dashboardGrid");
		new Sortable(grid, {
			animation: 250,
			handle: ".section-title",
			ghostClass: "drag-ghost",
			onEnd: () => {
				const order = Array.from(document.querySelectorAll(".dashboard-item")).map(el => el.dataset.id);
				localStorage.setItem("dashboardOrder", JSON.stringify(order));
			}
		});

		const saved = JSON.parse(localStorage.getItem("dashboardOrder"));
		if (saved) saved.forEach(id => {
			const el = document.querySelector(`[data-id="${id}"]`);
			if (el) grid.appendChild(el);
		});
		
		// ì™¸ë¶€ ë…¸ì¶œìš© í˜ì´ì§• ê°±ì‹  í•¨ìˆ˜ ë“±ë¡
		window.refreshMemoPaging = () => initWidgetPagination('memos', 4);
	});

	// ë©”ëª¨ ì…ë ¥ í¼ ë³´ì´ê¸°
	function showMemoForm() {
		document.getElementById('memoInputForm').classList.remove('hidden-item');
		document.getElementById('noMemoMsg')?.classList.add('hidden-item');
		document.getElementById('memoTextarea').focus();
	}

	// ë©”ëª¨ ì…ë ¥ í¼ ìˆ¨ê¸°ê¸°
	function hideMemoForm() {
		document.getElementById('memoInputForm').classList.add('hidden-item');
		if (document.querySelectorAll('.page-item-memos').length === 0) {
			document.getElementById('noMemoMsg')?.classList.remove('hidden-item');
		}
		document.getElementById('memoTextarea').value = '';
	}

	// ë©”ëª¨ ì €ì¥ (HTML íƒœê·¸ ë°©ì§€ ë° ì‚­ì œ ê¸°ëŠ¥ í¬í•¨)
	function saveMemo() {
		const textarea = document.getElementById('memoTextarea');
		const content = textarea.value.trim();
		if (!content) return alert("ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");

		const memoList = document.getElementById('memoList');
		const currentMemos = document.querySelectorAll('.page-item-memos');
		const colorIdx = (currentMemos.length % 4) + 1;
		
		const wrapper = document.createElement('div');
		wrapper.className = 'col-6 page-item-memos';
		
		// ì¹´ë“œ ë ˆì´ì•„ì›ƒ ìƒì„±
		wrapper.innerHTML = `
			<div class="card memo-card shadow-sm h-100 memo-bg-${colorIdx}">
				<button class="btn-delete-memo" title="ì‚­ì œ">&times;</button>
				<div class="card-body py-3">
					<p class="mb-0 memo-content-preview"></p>
				</div>
			</div>`;
		
		// XSS ë°©ì§€ë¥¼ ìœ„í•´ innerTextë¡œ ë‚´ìš© ì‚½ì…
		wrapper.querySelector('.memo-content-preview').innerText = content;

		// ì¹´ë“œ í´ë¦­ ì‹œ ìƒì„¸ë³´ê¸° (ì§ì ‘ í• ë‹¹í•˜ì—¬ ì•ˆì „í•¨)
		wrapper.querySelector('.memo-card').onclick = function() {
			viewMemoDetail(content);
		};

		// ì‚­ì œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
		wrapper.querySelector('.btn-delete-memo').onclick = function(e) {
			e.stopPropagation(); // ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ ì „íŒŒ ë§‰ê¸°
			if(confirm("ì´ ë©”ëª¨ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
				wrapper.remove();
				if(window.refreshMemoPaging) window.refreshMemoPaging();
				checkEmptyMemo();
			}
		};
		
		// ëª©ë¡ ë§¨ ì•ì— ì‚½ì…
		memoList.insertBefore(wrapper, memoList.firstChild);
		
		hideMemoForm();
		if(window.refreshMemoPaging) window.refreshMemoPaging();
	}

	// ê¸°ì¡´(Thymeleaf) ë©”ëª¨ ì‚­ì œ í•¨ìˆ˜
	function deleteExistingMemo(btn, event) {
		event.stopPropagation();
		if(confirm("ì´ ë©”ëª¨ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
			const item = btn.closest('.page-item-memos');
			item.remove();
			if(window.refreshMemoPaging) window.refreshMemoPaging();
			checkEmptyMemo();
		}
	}

	// ë©”ëª¨ê°€ í•˜ë‚˜ë„ ì—†ëŠ”ì§€ ì²´í¬í•˜ì—¬ ë©”ì‹œì§€ í‘œì‹œ
	function checkEmptyMemo() {
		const memoCount = document.querySelectorAll('.page-item-memos').length;
		const noMemoMsg = document.getElementById('noMemoMsg');
		if (memoCount === 0 && noMemoMsg) {
			noMemoMsg.classList.remove('hidden-item');
		}
	}

	// ë©”ëª¨ ìƒì„¸ ë³´ê¸° (ëª¨ë‹¬)
	function viewMemoDetail(content) {
		document.getElementById('fullMemoContent').innerText = content;
		const modal = new bootstrap.Modal(document.getElementById('memoDetailModal'));
		modal.show();
	}
	</script>

</body>
</html>